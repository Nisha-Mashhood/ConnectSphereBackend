{"version":3,"file":"call-repository.js","sourceRoot":"","sources":["../../src/Repositories/call-repository.ts"],"names":[],"mappings":"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","sourcesContent":["import { RepositoryError } from \"../core/utils/error-handler\";\r\nimport { BaseRepository } from \"../core/repositries/base-repositry\";\r\nimport logger from \"../core/utils/logger\";\r\nimport { ICallLog } from \"../Interfaces/Models/i-call-log\";\r\nimport callModal from \"../Models/call-model\";\r\nimport { ICallLogPopulated } from \"../Utils/types/call-types\";\r\nimport { ICallLogRepository } from \"../Interfaces/Repository/i-call-repositry\";\r\nimport { StatusCodes } from \"../enums/status-code-enums\";\r\nimport { inject, injectable } from \"inversify\";\r\nimport { IUserRepository } from \"../Interfaces/Repository/i-user-repositry\";\r\nimport { ERROR_MESSAGES } from \"../constants/error-messages\";\r\n\r\n@injectable()\r\nexport class CallLogRepository extends BaseRepository<ICallLog> implements ICallLogRepository {\r\n  private _userRepository: IUserRepository;\r\n\r\n  constructor(@inject('IUserRepository') userRepository : IUserRepository) {\r\n    super(callModal);\r\n    this._userRepository = userRepository;\r\n  }\r\n\r\n  public createCallLog = async(data: Partial<ICallLog>): Promise<ICallLog> =>{\r\n    try {\r\n      logger.debug(\r\n        `Creating call log for chatKey: ${data.chatKey}, senderId: ${data.senderId}, CallId: ${data.CallId}`\r\n      );\r\n      const callLog = await this.create(data);\r\n      logger.info(\r\n        `Created call log: ${callLog._id}, CallId: ${callLog.CallId}, status: ${callLog.status}`\r\n      );\r\n      return callLog;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error creating call log`, err);\r\n      throw new RepositoryError(\r\n        ERROR_MESSAGES.FAILED_TO_CREATE_CALL_LOG,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n\r\n  public updateCallLog = async (\r\n    CallId: string,\r\n    data: Partial<ICallLog>\r\n  ): Promise<ICallLog | null> => {\r\n    try {\r\n      logger.debug(`Updating call log for CallId: ${CallId}`);\r\n      const callLog = await this.model\r\n        .findOneAndUpdate(\r\n          { CallId },\r\n          { ...data, updatedAt: new Date() },\r\n          { new: true }\r\n        )\r\n        .exec();\r\n      if (!callLog) {\r\n        logger.warn(`Call log not found for CallId: ${CallId}`);\r\n        throw new RepositoryError(\r\n          `${ERROR_MESSAGES.CALL_LOG_NOT_FOUND} for CallId: ${CallId}`,\r\n          StatusCodes.NOT_FOUND\r\n        );\r\n      }\r\n      logger.info(\r\n        `Updated call log: ${callLog._id}, CallId: ${callLog.CallId}, status: ${callLog.status}`\r\n      );\r\n      return callLog;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error updating call log for CallId: ${CallId}`, err);\r\n      throw new RepositoryError(\r\n        `${ERROR_MESSAGES.FAILED_TO_UPDATE_CALL_LOG} for CallId: ${CallId}`,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n\r\n  public findCallLogByCallId = async (CallId: string): Promise<ICallLog | null> => {\r\n    try {\r\n      logger.debug(`Finding call log by CallId: ${CallId}`);\r\n      const callLog = await this.model.findOne({ CallId }).exec();\r\n      if (callLog) {\r\n        logger.debug(`Found call log: ${callLog._id}, CallId: ${CallId}`);\r\n      } else {\r\n        logger.debug(`No call log found for CallId: ${CallId}`);\r\n      }\r\n      return callLog;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error finding call log by CallId: ${CallId}`, err);\r\n      throw new RepositoryError(\r\n        `${ERROR_MESSAGES.FAILED_TO_FIND_CALL_LOG} by CallId: ${CallId}`,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n\r\n  public findCallLogsByUserId = async (\r\n    userId: string\r\n  ): Promise<ICallLogPopulated[]> => {\r\n    try {\r\n      logger.debug(`Finding call logs for userId: ${userId}`);\r\n      const callLogs = await this.model\r\n        .find({\r\n          $or: [{ senderId: userId }, { recipientIds: userId }],\r\n        })\r\n        .sort({ createdAt: -1 })\r\n        .exec();\r\n\r\n      const populatedCallLogs = await Promise.all(\r\n        callLogs.map(async (log) => {\r\n          let senderDetails = null;\r\n          let recipientDetails: any[] = [];\r\n\r\n          try {\r\n            senderDetails = await this._userRepository.getUserById(\r\n              log.senderId as string\r\n            );\r\n          } catch (error) {\r\n            logger.warn(\r\n              `Failed to fetch sender details for userId ${log.senderId}: ${error}`\r\n            );\r\n          }\r\n\r\n          try {\r\n            recipientDetails = await Promise.all(\r\n              (log.recipientIds as string[]).map(async (id) => {\r\n                try {\r\n                  return await this._userRepository.getUserById(id);\r\n                } catch (error) {\r\n                  logger.warn(\r\n                    `Failed to fetch recipient details for userId ${id}: ${error}`\r\n                  );\r\n                  return null;\r\n                }\r\n              })\r\n            );\r\n          } catch (error) {\r\n            logger.warn(`Error fetching recipient details: ${error}`);\r\n          }\r\n\r\n          return {\r\n            ...log.toObject(),\r\n            senderId: senderDetails\r\n              ? {\r\n                  _id: senderDetails._id,\r\n                  name: senderDetails.name,\r\n                  profilePic: senderDetails.profilePic ?? null,\r\n                }\r\n              : { _id: log.senderId, name: \"Unknown\", profilePic: null },\r\n\r\n            recipientIds: recipientDetails.filter(Boolean).map((user) => ({\r\n              _id: user!._id,\r\n              name: user!.name,\r\n              profilePic: user!.profilePic ?? null,\r\n            })),\r\n          };\r\n        })\r\n      );\r\n\r\n      logger.info(\r\n        `Retrieved ${populatedCallLogs.length} call logs for userId: ${userId}`\r\n      );\r\n      return populatedCallLogs;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error finding call logs for userId: ${userId}`, err);\r\n      throw new RepositoryError(\r\n        `${ERROR_MESSAGES.FAILED_TO_FETCH_CALL_LOGS} for userId: ${userId}`,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n}"]}