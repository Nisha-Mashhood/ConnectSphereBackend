{"version":3,"file":"chat-repository.js","sourceRoot":"","sources":["../../src/Repositories/chat-repository.ts"],"names":[],"mappings":"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","sourcesContent":["import { injectable } from \"inversify\";\r\nimport { Types, Model } from \"mongoose\";\r\nimport { BaseRepository } from \"../core/repositries/base-repositry\";\r\nimport { RepositoryError } from \"../core/utils/error-handler\";\r\nimport logger from \"../core/utils/logger\";\r\nimport ChatMessage from \"../Models/chat-model\";\r\nimport { IChatMessage } from \"../Interfaces/Models/i-chat-message\";\r\nimport { IChatRepository } from \"../Interfaces/Repository/i-chat-repositry\";\r\nimport { StatusCodes } from \"../enums/status-code-enums\";\r\nimport { ERROR_MESSAGES } from \"../constants/error-messages\";\r\n\r\n@injectable()\r\nexport class ChatRepository extends BaseRepository<IChatMessage> implements IChatRepository{\r\n  constructor() {\r\n    super(ChatMessage as Model<IChatMessage>);\r\n  }\r\n\r\n  private toObjectId(id?: string | Types.ObjectId): Types.ObjectId {\r\n    if (!id) {\r\n      logger.warn(\"Missing ID when converting to ObjectId\");\r\n      throw new RepositoryError(\"Invalid ID: ID is required\", StatusCodes.BAD_REQUEST);\r\n    }\r\n\r\n    const idStr = id instanceof Types.ObjectId ? id.toString() : id;\r\n    if (!Types.ObjectId.isValid(idStr)) {\r\n      logger.warn(`Invalid ObjectId format: ${idStr}`);\r\n      throw new RepositoryError(\r\n        \"Invalid ID: must be a 24 character hex string\"\r\n      );\r\n    }\r\n\r\n    return new Types.ObjectId(idStr);\r\n  }\r\n\r\n  public saveChatMessage = async (data: Partial<IChatMessage>): Promise<IChatMessage> => {\r\n    try {\r\n      logger.debug(`Saving chat message for sender: ${data.senderId}`);\r\n      const message = await this.create({\r\n        ...data,\r\n        senderId: data.senderId ? this.toObjectId(data.senderId) : undefined,\r\n        collaborationId: data.collaborationId ? this.toObjectId(data.collaborationId) : undefined,\r\n        userConnectionId: data.userConnectionId ? this.toObjectId(data.userConnectionId) : undefined,\r\n        groupId: data.groupId ? this.toObjectId(data.groupId) : undefined,\r\n      });\r\n      logger.info(`Chat message created: ${message._id}`);\r\n      return message;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error saving chat message`, err);\r\n      throw new RepositoryError(\r\n        ERROR_MESSAGES.FAILED_TO_SAVE_CHAT_MESSAGE,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n\r\n  public findChatMessageById = async (messageId: string): Promise<IChatMessage | null> => {\r\n    try {\r\n      logger.debug(`Finding chat message by ID: ${messageId}`);\r\n      const message = await this.findById(messageId);\r\n      logger.info(`Chat message ${message ? 'found' : 'not found'}: ${messageId}`);\r\n      return message;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error finding chat message by ID ${messageId}: ${err}`);\r\n      throw new RepositoryError(\r\n        `${ERROR_MESSAGES.FAILED_TO_FIND_CHAT_MESSAGE_BY_ID} ${messageId}`,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n\r\n  public findChatMessagesByCollaborationId = async (\r\n    collaborationId: string,\r\n    page: number,\r\n    limit: number\r\n  ): Promise<IChatMessage[]> => {\r\n    try {\r\n      logger.debug(`Finding messages for collaboration: ${collaborationId}`);\r\n      const id = this.toObjectId(collaborationId);\r\n      return await this.model\r\n        .find({ collaborationId: id })\r\n        .sort({ timestamp: -1 })\r\n        .skip((page - 1) * limit)\r\n        .limit(limit)\r\n        .exec();\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error finding messages by collaboration ID: ${err}`);\r\n      throw new RepositoryError(\r\n        `${ERROR_MESSAGES.FAILED_TO_FIND_CHAT_MESSAGES_BY_COLLABORATION_ID} ${collaborationId}`,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n\r\n  public findChatMessagesByUserConnectionId = async (\r\n    userConnectionId: string,\r\n    page: number,\r\n    limit: number\r\n  ): Promise<IChatMessage[]> => {\r\n    try {\r\n      logger.debug(`Finding messages for user connection: ${userConnectionId}`);\r\n      const id = this.toObjectId(userConnectionId);\r\n      return await this.model\r\n        .find({ userConnectionId: id })\r\n        .sort({ timestamp: -1 })\r\n        .skip((page - 1) * limit)\r\n        .limit(limit)\r\n        .exec();\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error finding messages by user connection ID: ${err}`);\r\n      throw new RepositoryError(\r\n        `${ERROR_MESSAGES.FAILED_TO_FIND_CHAT_MESSAGES_BY_USER_CONNECTION_ID} ${userConnectionId}`,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n\r\n  public findChatMessagesByGroupId = async (\r\n    groupId: string,\r\n    page: number,\r\n    limit: number\r\n  ): Promise<IChatMessage[]> => {\r\n    try {\r\n      logger.debug(`Finding messages for group: ${groupId}`);\r\n      const id = this.toObjectId(groupId);\r\n      return await this.model\r\n        .find({ groupId: id })\r\n        .sort({ timestamp: -1 })\r\n        .skip((page - 1) * limit)\r\n        .limit(limit)\r\n        .exec();\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error finding messages by group ID: ${err}`);\r\n      throw new RepositoryError(\r\n        `${ERROR_MESSAGES.FAILED_TO_FIND_CHAT_MESSAGES_BY_GROUP_ID} ${groupId}`,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n\r\n  public countMessagesByCollaborationId = async (collaborationId: string): Promise<number> => {\r\n    try {\r\n      logger.debug(`Counting messages for collaboration: ${collaborationId}`);\r\n      const id = this.toObjectId(collaborationId);\r\n      return await this.model.countDocuments({ collaborationId: id });\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error counting messages by collaboration ID: ${err}`);\r\n      throw new RepositoryError(\r\n        `${ERROR_MESSAGES.FAILED_TO_COUNT_MESSAGES_BY_COLLABORATION_ID} ${collaborationId}`,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n\r\n  public countMessagesByUserConnectionId = async (userConnectionId: string): Promise<number> => {\r\n    try {\r\n      logger.debug(`Counting messages for user connection: ${userConnectionId}`);\r\n      const id = this.toObjectId(userConnectionId);\r\n      return await this.model.countDocuments({ userConnectionId: id });\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error counting messages by user connection ID: ${err}`);\r\n      throw new RepositoryError(\r\n        `${ERROR_MESSAGES.FAILED_TO_COUNT_MESSAGES_BY_USER_CONNECTION_ID} ${userConnectionId}`,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n\r\n  public countMessagesByGroupId = async (groupId: string): Promise<number> => {\r\n    try {\r\n      logger.debug(`Counting messages for group: ${groupId}`);\r\n      const id = this.toObjectId(groupId);\r\n      return await this.model.countDocuments({ groupId: id });\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error counting messages by group ID: ${err}`);\r\n      throw new RepositoryError(\r\n        `${ERROR_MESSAGES.FAILED_TO_COUNT_MESSAGES_BY_GROUP_ID} ${groupId}`,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n\r\n  public countUnreadMessagesByGroupId = async (\r\n    groupId: string,\r\n    userId: string\r\n  ): Promise<number> => {\r\n    try {\r\n      logger.debug(`Counting unread messages for group: ${groupId}, user: ${userId}`);\r\n      const gId = this.toObjectId(groupId);\r\n      const uId = this.toObjectId(userId);\r\n      const count = await this.model.countDocuments({\r\n        groupId: gId,\r\n        isRead: false,\r\n        senderId: { $ne: uId },\r\n      });\r\n      logger.debug(`Unread count for group ${groupId}: ${count}`);\r\n      return count;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error counting unread messages by group ID: ${err}`);\r\n      throw new RepositoryError(\r\n        `${ERROR_MESSAGES.FAILED_TO_COUNT_UNREAD_MESSAGES_BY_GROUP_ID} ${groupId}`,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n\r\n  public countUnreadMessagesByCollaborationId = async (\r\n    collaborationId: string,\r\n    userId: string\r\n  ): Promise<number> => {\r\n    try {\r\n      logger.debug(`Counting unread messages for collaboration: ${collaborationId}, user: ${userId}`);\r\n      const cId = this.toObjectId(collaborationId);\r\n      const uId = this.toObjectId(userId);\r\n      const count = await this.model.countDocuments({\r\n        collaborationId: cId,\r\n        isRead: false,\r\n        senderId: { $ne: uId },\r\n      });\r\n      logger.debug(`Unread count for collaboration ${collaborationId}: ${count}`);\r\n      return count;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error counting unread messages by collaboration ID: ${err}`);\r\n      throw new RepositoryError(\r\n        `${ERROR_MESSAGES.FAILED_TO_COUNT_UNREAD_MESSAGES_BY_COLLABORATION_ID} ${collaborationId}`,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n\r\n  public countUnreadMessagesByUserConnectionId = async (\r\n    userConnectionId: string,\r\n    userId: string\r\n  ): Promise<number> => {\r\n    try {\r\n      logger.debug(`Counting unread messages for user connection: ${userConnectionId}, user: ${userId}`);\r\n      const ucId = this.toObjectId(userConnectionId);\r\n      const uId = this.toObjectId(userId);\r\n      const count = await this.model.countDocuments({\r\n        userConnectionId: ucId,\r\n        isRead: false,\r\n        senderId: { $ne: uId },\r\n      });\r\n      logger.debug(`Unread count for user connection ${userConnectionId}: ${count}`);\r\n      return count;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error counting unread messages by user connection ID: ${err}`);\r\n      throw new RepositoryError(\r\n        `${ERROR_MESSAGES.FAILED_TO_COUNT_UNREAD_MESSAGES_BY_USER_CONNECTION_ID} ${userConnectionId}`,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n\r\n  public markMessagesAsRead = async (\r\n    chatKey: string,\r\n    userId: string,\r\n    type: \"group\" | \"user-mentor\" | \"user-user\"\r\n  ): Promise<string[]> => {\r\n    try {\r\n      logger.debug(`Marking messages as read: ${chatKey}, user: ${userId}, type: ${type}`);\r\n      const filter: Record<string, any> = {\r\n        isRead: false,\r\n        senderId: { $ne: this.toObjectId(userId) },\r\n      };\r\n      if (type === \"group\") {\r\n        filter.groupId = this.toObjectId(chatKey.replace(\"group_\", \"\"));\r\n      } else if (type === \"user-mentor\") {\r\n        filter.collaborationId = this.toObjectId(chatKey.replace(\"user-mentor_\", \"\"));\r\n      } else {\r\n        filter.userConnectionId = this.toObjectId(chatKey.replace(\"user-user_\", \"\"));\r\n      }\r\n      const unreadMessages = await this.model.find(filter).select(\"_id\").exec();\r\n      const messageIds = unreadMessages.map((msg) => msg._id.toString());\r\n\r\n      if (messageIds.length > 0) {\r\n        await this.model.updateMany(\r\n          { _id: { $in: messageIds.map((id) => this.toObjectId(id)) } },\r\n          { $set: { isRead: true, status: \"read\" } }\r\n        );\r\n        logger.info(`Marked ${messageIds.length} messages as read for ${chatKey}`);\r\n      }\r\n\r\n      return messageIds;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error marking messages as read: ${err}`);\r\n      throw new RepositoryError(\r\n        ERROR_MESSAGES.FAILED_TO_MARK_MESSAGES_AS_READ,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n\r\n  public async findLatestMessageByGroupId(groupId: string): Promise<IChatMessage | null> {\r\n    try {\r\n      logger.debug(`Finding latest message for groupId: ${groupId}`);\r\n      const message = await this.model\r\n        .findOne({ groupId: this.toObjectId(groupId) })\r\n        .sort({ timestamp: -1 })\r\n        .select('timestamp content senderId contentType')\r\n        .lean()\r\n        .exec();\r\n      return message as IChatMessage | null;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error finding latest message by groupId ${groupId}: ${err}`);\r\n      throw new RepositoryError(\r\n        `${ERROR_MESSAGES.FAILED_TO_FIND_LATEST_MESSAGE} by groupId ${groupId}`,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n\r\n  public async findLatestMessageByCollaborationId(collaborationId: string): Promise<IChatMessage | null> {\r\n    try {\r\n      logger.debug(`Finding latest message for collaborationId: ${collaborationId}`);\r\n      const message = await this.model\r\n        .findOne({ collaborationId: this.toObjectId(collaborationId) })\r\n        .sort({ timestamp: -1 })\r\n        .select('timestamp content senderId contentType')\r\n        .lean()\r\n        .exec();\r\n      return message as IChatMessage | null;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error finding latest message by collaborationId ${collaborationId}: ${err}`);\r\n      throw new RepositoryError(\r\n        `${ERROR_MESSAGES.FAILED_TO_FIND_LATEST_MESSAGE} by collaborationId ${collaborationId}`,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n\r\n  public async findLatestMessageByUserConnectionId(userConnectionId: string): Promise<IChatMessage | null> {\r\n    try {\r\n      logger.debug(`Finding latest message for userConnectionId: ${userConnectionId}`);\r\n      const message = await this.model\r\n        .findOne({ userConnectionId: this.toObjectId(userConnectionId) })\r\n        .sort({ timestamp: -1 })\r\n        .select('timestamp content senderId contentType')\r\n        .lean()\r\n        .exec();\r\n      return message as IChatMessage | null;\r\n    } catch(error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error finding latest message by userConnectionId ${userConnectionId}: ${err}`);\r\n      throw new RepositoryError(\r\n        `${ERROR_MESSAGES.FAILED_TO_FIND_LATEST_MESSAGE} by userConnectionId ${userConnectionId}`,\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  }\r\n}\r\n"]}