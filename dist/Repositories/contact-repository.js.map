{"version":3,"file":"contact-repository.js","sourceRoot":"","sources":["../../src/Repositories/contact-repository.ts"],"names":[],"mappings":"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","sourcesContent":["import { inject, injectable } from 'inversify';\r\nimport { Types, Model, ClientSession } from 'mongoose';\r\nimport { BaseRepository } from '../core/repositries/base-repositry';\r\nimport { RepositoryError } from '../core/utils/error-handler';\r\nimport logger from '../core/utils/logger';\r\nimport Contact from '../Models/contacts-model';\r\nimport { IContact } from '../Interfaces/Models/i-contact';\r\nimport { PopulatedContact } from '../Utils/types/contact-types';\r\nimport { IContactRepository } from '../Interfaces/Repository/i-contact-repositry';\r\nimport { StatusCodes } from '../enums/status-code-enums';\r\nimport { IChatRepository } from '../Interfaces/Repository/i-chat-repositry';\r\n\r\n@injectable()\r\nexport class ContactRepository extends BaseRepository<IContact> implements IContactRepository{\r\n  private _chatRepo: IChatRepository;\r\n\r\n  constructor(@inject('IChatRepository') chatRepository : IChatRepository) {\r\n    super(Contact as Model<IContact>);\r\n    this._chatRepo = chatRepository;\r\n  }\r\n\r\n  private toObjectId = (id?: string | Types.ObjectId): Types.ObjectId => {\r\n    if (!id) {\r\n      logger.warn('Missing ID when converting to ObjectId');\r\n      throw new RepositoryError('Invalid ID: ID is required', StatusCodes.BAD_REQUEST);\r\n    }\r\n    const idStr = id instanceof Types.ObjectId ? id.toString() : id;\r\n    if (!Types.ObjectId.isValid(idStr)) {\r\n      logger.warn(`Invalid ObjectId format: ${idStr}`);\r\n      throw new RepositoryError('Invalid ID: must be a 24 character hex string', StatusCodes.BAD_REQUEST);\r\n    }\r\n    return new Types.ObjectId(idStr);\r\n  }\r\n\r\n   public createContact = async (contactData: Partial<IContact>, session?: ClientSession): Promise<IContact> => {\r\n    try {\r\n      logger.debug(`Creating contact for user: ${contactData.userId}`);\r\n      const contact = await this.create({\r\n        ...contactData,\r\n        userId: contactData.userId ? this.toObjectId(contactData.userId) : undefined,\r\n        targetUserId: contactData.targetUserId ? this.toObjectId(contactData.targetUserId) : undefined,\r\n        collaborationId: contactData.collaborationId ? this.toObjectId(contactData.collaborationId) : undefined,\r\n        userConnectionId: contactData.userConnectionId ? this.toObjectId(contactData.userConnectionId) : undefined,\r\n        groupId: contactData.groupId ? this.toObjectId(contactData.groupId) : undefined,\r\n      },\r\n    session\r\n  );\r\n      logger.info(`Contact created: ${contact._id}`);\r\n      return contact;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error creating contact`, err);\r\n      throw new RepositoryError('Error creating contact', StatusCodes.INTERNAL_SERVER_ERROR, err);\r\n    }\r\n  }\r\n\r\n   public findContactById = async (contactId: string): Promise<IContact | null> => {\r\n    try {\r\n      logger.debug(`Finding contact by ID: ${contactId}`);\r\n      const contact = await this.findById(contactId);\r\n      logger.info(`Contact ${contact ? 'found' : 'not found'}: ${contactId}`);\r\n      return contact;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error finding contact by ID ${contactId}`, err);\r\n      throw new RepositoryError('Error finding contact by ID', StatusCodes.INTERNAL_SERVER_ERROR, err);\r\n    }\r\n  }\r\n\r\n   public findContactByUsers = async (userId: string, targetUserId: string): Promise<IContact | null> => {\r\n    try {\r\n      logger.debug(`Finding contact for users: ${userId}, ${targetUserId}`);\r\n      const contact = await this.findOne({\r\n        $or: [\r\n          { userId: this.toObjectId(userId), targetUserId: this.toObjectId(targetUserId) },\r\n          { userId: this.toObjectId(targetUserId), targetUserId: this.toObjectId(userId) },\r\n        ],\r\n        type: { $in: ['user-user', 'user-mentor'] },\r\n      });\r\n      logger.info(`Contact ${contact ? 'found' : 'not found'} for users: ${userId}, ${targetUserId}`);\r\n      return contact;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error finding contact for users ${userId}, ${targetUserId}`, err);\r\n      throw new RepositoryError('Error finding contact by user IDs', StatusCodes.INTERNAL_SERVER_ERROR, err);\r\n    }\r\n  }\r\n\r\n   public findContactsByUserId = async (userId?: string): Promise<PopulatedContact[]> => {\r\n    if (!userId) {\r\n      logger.warn('User ID not provided for finding contacts');\r\n      throw new RepositoryError('User ID not provided', StatusCodes.BAD_REQUEST);\r\n    }\r\n    try {\r\n      logger.debug(`Finding contacts for user: ${userId}`);\r\n      const uId = this.toObjectId(userId);\r\n\r\n      const contacts = await this.model\r\n        .find({\r\n          $or: [{ userId: uId }, { targetUserId: uId }],\r\n        })\r\n        .populate({\r\n          path: 'userId',\r\n          select: '_id name profilePic userId jobTitle',\r\n          model: 'User',\r\n        })\r\n        .populate({\r\n          path: 'targetUserId',\r\n          select: '_id name profilePic userId jobTitle',\r\n          model: 'User',\r\n        })\r\n        .populate({\r\n          path: 'collaborationId',\r\n          select: '_id mentorId userId startDate endDate price selectedSlot',\r\n          model: 'Collaboration',\r\n          populate: [\r\n            { path: 'mentorId', select: 'userId', populate: { path: 'userId', select: '_id name profilePic jobTitle' } },\r\n            { path: 'userId', select: '_id name profilePic jobTitle' },\r\n          ],\r\n        })\r\n        .populate({\r\n          path: 'userConnectionId',\r\n          select: '_id requester recipient requestAcceptedAt',\r\n          model: 'UserConnection',\r\n          populate: [\r\n            { path: 'requester', select: '_id name profilePic jobTitle' },\r\n            { path: 'recipient', select: '_id name profilePic jobTitle' },\r\n          ],\r\n        })\r\n        .populate({\r\n          path: 'groupId',\r\n          select: '_id name profilePic startDate adminId bio price maxMembers availableSlots members',\r\n          model: 'Group',\r\n          populate: [\r\n            { path: 'adminId', select: '_id name profilePic' },\r\n            { path: 'members.userId', select: '_id name profilePic' },\r\n          ],\r\n        })\r\n        .lean()\r\n        .exec() as unknown as PopulatedContact[];\r\n\r\n      const contactsWithMessages = await Promise.all(\r\n        contacts.map(async (contact) => {\r\n          let lastMessage: { timestamp: Date } | null = null;\r\n          if (contact.type === 'group' && contact.groupId?._id) {\r\n            lastMessage = await this._chatRepo.findLatestMessageByGroupId(contact.groupId._id.toString());\r\n          } else if (contact.type === 'user-mentor' && contact.collaborationId?._id) {\r\n            lastMessage = await this._chatRepo.findLatestMessageByCollaborationId(contact.collaborationId._id.toString());\r\n          } else if (contact.type === 'user-user' && contact.userConnectionId?._id) {\r\n            lastMessage = await this._chatRepo.findLatestMessageByUserConnectionId(contact.userConnectionId._id.toString());\r\n          }\r\n          return { ...contact, lastMessage: lastMessage || undefined };\r\n        })\r\n      );\r\n\r\n      const sortedContacts = contactsWithMessages.sort((a, b) => {\r\n        const aTimestamp = a.lastMessage?.timestamp ? new Date(a.lastMessage.timestamp).getTime() : 0;\r\n        const bTimestamp = b.lastMessage?.timestamp ? new Date(b.lastMessage.timestamp).getTime() : 0;\r\n        return bTimestamp - aTimestamp || a._id.toString().localeCompare(b._id.toString());\r\n      });\r\n      return sortedContacts;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error finding contacts for user ${userId}`, err);\r\n      throw new RepositoryError('Error finding contacts by user ID', StatusCodes.INTERNAL_SERVER_ERROR, err);\r\n    }\r\n  }\r\n\r\n  public deleteContact = async (\r\n    id: string,\r\n    type: 'group' | 'user-mentor' | 'user-user',\r\n    userId?: string\r\n  ): Promise<number> => {\r\n    try {\r\n      logger.debug(`Deleting contact for id: ${id}, type: ${type}${userId ? `, userId: ${userId}` : ''}`);\r\n      const query: Record<string, any> = { type };\r\n      if (type === 'group') {\r\n        query.groupId = this.toObjectId(id);\r\n        if (userId) {\r\n          query.userId = this.toObjectId(userId);\r\n        }\r\n      } else if (type === 'user-mentor') {\r\n        query.collaborationId = this.toObjectId(id);\r\n      } else if (type === 'user-user') {\r\n        query.userConnectionId = this.toObjectId(id);\r\n      } else {\r\n        logger.warn(`Invalid contact type: ${type}`);\r\n        throw new RepositoryError(`Invalid contact type: ${type}`, StatusCodes.BAD_REQUEST);\r\n      }\r\n\r\n      const result = await this.model.deleteMany(query).exec();\r\n      const deletedCount = result.deletedCount || 0;\r\n      logger.info(`Deleted ${deletedCount} contact(s) for id: ${id}, type: ${type}${userId ? `, userId: ${userId}` : ''}`);\r\n      return deletedCount;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error deleting contact for id: ${id}, type: ${type}`, err);\r\n      throw new RepositoryError('Error deleting contact', StatusCodes.INTERNAL_SERVER_ERROR, err);\r\n    }\r\n  }\r\n}"]}