{"version":3,"file":"contact-us-repository.js","sourceRoot":"","sources":["../../src/Repositories/contact-us-repository.ts"],"names":[],"mappings":"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","sourcesContent":["import { injectable } from 'inversify';\r\nimport { Model, PipelineStage } from 'mongoose';\r\nimport { BaseRepository } from '../core/repositries/base-repositry';\r\nimport { RepositoryError } from '../core/utils/error-handler';\r\nimport logger from '../core/utils/logger';\r\nimport ContactMessage from '../Models/contact-message-model';\r\nimport { IContactMessage } from '../Interfaces/Models/i-contact-message';\r\nimport { IContactMessageRepository } from '../Interfaces/Repository/i-contact-message-repositry';\r\nimport { StatusCodes } from '../enums/status-code-enums';\r\n\r\n@injectable()\r\nexport class ContactMessageRepository extends BaseRepository<IContactMessage> implements IContactMessageRepository{\r\n  constructor() {\r\n    super(ContactMessage as Model<IContactMessage>);\r\n  }\r\n\r\n   public createContactMessage = async (data: { name: string; email: string; message: string }): Promise<IContactMessage> => {\r\n    try {\r\n      logger.debug(`Creating contact message from: ${data.email}`);\r\n      const message = await this.create({\r\n        ...data,\r\n        givenReply: false,\r\n        createdAt: new Date(),\r\n      });\r\n      logger.info(`Contact message created: ${message._id}`);\r\n      return message;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error creating contact message from ${data.email}`, err);\r\n      throw new RepositoryError('Error creating contact message', StatusCodes.INTERNAL_SERVER_ERROR, err);\r\n    }\r\n  }\r\n\r\n   public async getAllContactMessages({\r\n  page = 1,\r\n  limit = 10,\r\n  search = \"\",\r\n  dateFilter = \"all\",\r\n}: {\r\n  page?: number;\r\n  limit?: number;\r\n  search?: string;\r\n  dateFilter?: \"today\" | \"7days\" | \"30days\" | \"all\";\r\n}): Promise<{ messages: IContactMessage[]; total: number; page: number; pages: number }> {\r\n  try {\r\n    logger.debug(\r\n      `Fetching contact messages (page=${page}, limit=${limit}, search=${search}, dateFilter=${dateFilter})`\r\n    );\r\n\r\n    const matchStage: any = {};\r\n\r\n    if (search.trim() !== \"\") {\r\n      matchStage.$or = [\r\n        { name: { $regex: search, $options: \"i\" } },\r\n        { email: { $regex: search, $options: \"i\" } },\r\n        { message: { $regex: search, $options: \"i\" } },\r\n      ];\r\n    }\r\n\r\n    if (dateFilter !== \"all\") {\r\n      const now = new Date();\r\n\r\n      let startDate: Date | null = null;\r\n\r\n      if (dateFilter === \"today\") {\r\n        startDate = new Date(now.setHours(0, 0, 0, 0));\r\n      } else if (dateFilter === \"7days\") {\r\n        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\r\n      } else if (dateFilter === \"30days\") {\r\n        startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\r\n      }\r\n\r\n      if (startDate) {\r\n        matchStage.createdAt = { $gte: startDate };\r\n      }\r\n    }\r\n\r\n    const pipeline: PipelineStage[] = [\r\n      { $match: matchStage },\r\n\r\n      { $sort: { createdAt: -1 } },\r\n\r\n      {\r\n        $facet: {\r\n          messages: [\r\n            { $skip: (page - 1) * limit },\r\n            { $limit: limit },\r\n            {\r\n              $project: {\r\n                _id: 1,\r\n                contactMessageId: 1,\r\n                name: 1,\r\n                email: 1,\r\n                message: 1,\r\n                createdAt: 1,\r\n                givenReply: 1,\r\n              },\r\n            },\r\n          ],\r\n          total: [{ $count: \"count\" }],\r\n        },\r\n      },\r\n    ];\r\n\r\n    const result = await this.model.aggregate(pipeline).exec();\r\n\r\n    const messages = result[0]?.messages || [];\r\n    const total = result[0]?.total[0]?.count || 0;\r\n\r\n    return {\r\n      messages: messages as IContactMessage[],\r\n      total,\r\n      page,\r\n      pages: Math.ceil(total / limit),\r\n    };\r\n  } catch (error) {\r\n    logger.error(\"Error fetching paginated contact messages\", error);\r\n    throw new RepositoryError(\r\n      \"Error fetching paginated contact messages\",\r\n      StatusCodes.INTERNAL_SERVER_ERROR,\r\n      error as Error\r\n    );\r\n  }\r\n}\r\n\r\n  public updateReplyStatus = async (contactMessageId: string): Promise<IContactMessage | null> => {\r\n    try {\r\n      logger.debug(`Updating reply status for contact message: ${contactMessageId}`);\r\n      const message = await this.model\r\n        .findByIdAndUpdate(\r\n          contactMessageId,\r\n          { givenReply: true },\r\n          { new: true }\r\n        )\r\n        .exec();\r\n      if (!message) {\r\n        logger.warn(`Contact message not found: ${contactMessageId}`);\r\n        throw new RepositoryError(`Contact message not found with ID: ${contactMessageId}`, StatusCodes.NOT_FOUND);\r\n      }\r\n      logger.info(`Reply status updated for contact message: ${contactMessageId}`);\r\n      return message;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error updating reply status for contact message ${contactMessageId}`, err);\r\n      throw new RepositoryError('Error updating reply status', StatusCodes.INTERNAL_SERVER_ERROR, err);\r\n    }\r\n  }\r\n}"]}