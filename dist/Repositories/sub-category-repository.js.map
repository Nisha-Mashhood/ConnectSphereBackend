{"version":3,"file":"sub-category-repository.js","sourceRoot":"","sources":["../../src/Repositories/sub-category-repository.ts"],"names":[],"mappings":"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","sourcesContent":["import { injectable } from \"inversify\";\r\nimport { Model, Types } from \"mongoose\";\r\nimport { BaseRepository } from \"../core/repositries/base-repositry\";\r\nimport { RepositoryError } from \"../core/utils/error-handler\";\r\nimport logger from \"../core/utils/logger\";\r\nimport { ISubcategory } from \"../Interfaces/Models/i-sub-category\";\r\nimport { Subcategory } from \"../Models/sub-category-model\";\r\nimport { StatusCodes } from \"../enums/status-code-enums\";\r\nimport { ISubcategoryRepository } from \"../Interfaces/Repository/i-sub-category-repositry\";\r\n\r\n@injectable()\r\nexport class SubcategoryRepository extends BaseRepository<ISubcategory> implements ISubcategoryRepository{\r\n  constructor() {\r\n    super(Subcategory as Model<ISubcategory>);\r\n  }\r\n\r\n   public createSubcategory = async(data: Partial<ISubcategory>): Promise<ISubcategory> => {\r\n    try {\r\n      logger.debug(`Creating subcategory: ${data.name} for category ${data.categoryId}`);\r\n      const subcategory = await this.create(data);\r\n      logger.info(`Subcategory created: ${subcategory._id} (${subcategory.name})`);\r\n      return subcategory;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error creating subcategory ${data.name}`, err);\r\n      throw new RepositoryError('Error creating subcategory', StatusCodes.INTERNAL_SERVER_ERROR, err);\r\n    }\r\n  }\r\n\r\n   public getAllSubcategories = async (\r\n    categoryId: string,\r\n    query: { search?: string; page?: number; limit?: number }\r\n  ): Promise<{ subcategories: ISubcategory[]; total: number }> => {\r\n    try {\r\n      logger.debug(\r\n        `Fetching subcategories for category: ${categoryId} with query: ${JSON.stringify(query)}`\r\n      );\r\n\r\n      const { search, page = 1, limit = 10 } = query;\r\n\r\n      const matchStage: Record<string, any> = {\r\n        categoryId: new Types.ObjectId(categoryId),\r\n      };\r\n\r\n      if (search) {\r\n        matchStage.name = { $regex: `${search}`, $options: \"i\" };\r\n      }\r\n\r\n      const pipeline = [\r\n        { $match: matchStage },\r\n        {\r\n          $project: {\r\n            _id: 1,\r\n            subcategoryId: 1,\r\n            name: 1,\r\n            description: 1,\r\n            imageUrl: 1,\r\n            categoryId: 1,\r\n            createdAt: 1,\r\n            updatedAt: 1,\r\n          },\r\n        },\r\n        {\r\n          $facet: {\r\n            subcategories: [\r\n              { $skip: (page - 1) * limit },\r\n              { $limit: limit },\r\n            ],\r\n            total: [{ $count: \"count\" }],\r\n          },\r\n        },\r\n      ]\r\n\r\n      const result = await this.model.aggregate(pipeline).exec();\r\n\r\n      const subcategories: ISubcategory[] = result[0]?.subcategories || [];\r\n      const total: number = result[0]?.total[0]?.count || 0;\r\n\r\n      logger.info(`Fetched ${subcategories.length} subcategories (total: ${total})`);\r\n      return { subcategories, total };\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error fetching subcategories`, err);\r\n      throw new RepositoryError(\r\n        \"Failed to fetch subcategories\",\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  };\r\n\r\n   getSubcategoryById = async(id: string): Promise<ISubcategory | null> =>{\r\n    try {\r\n      logger.debug(`Fetching subcategory by ID: ${id}`);\r\n      const subcategory = await this.model\r\n        .findById(id)\r\n        .populate(\"categoryId\")\r\n        .exec();\r\n      if (!subcategory) {\r\n        logger.warn(`Subcategory not not found: ${id}`);\r\n        throw new RepositoryError(`Subcategory not found with ID: ${id}`, StatusCodes.NOT_FOUND);\r\n      }\r\n        logger.info(`Subcategory fetched: ${id} (${subcategory.name})`);\r\n      return subcategory;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error fetching subcategory by ID ${id}`, err);\r\n      throw new RepositoryError('Error fetching subcategory by ID', StatusCodes.INTERNAL_SERVER_ERROR, err);\r\n    }\r\n  }\r\n\r\n   public updateSubcategory = async(\r\n    id: string,\r\n    data: Partial<ISubcategory>\r\n  ): Promise<ISubcategory | null> =>{\r\n    try {\r\n      logger.debug(`Updating subcategory: ${id}`);\r\n      const subcategory = await this.findByIdAndUpdate(id, data, { new: true });\r\n      if (!subcategory) {\r\n        logger.warn(`Subcategory not not found: ${id}`);\r\n        throw new RepositoryError(`Subcategory not found with ID: ${id}`, StatusCodes.NOT_FOUND);\r\n      }\r\n        logger.info(`Subcategory updated: ${id} (${subcategory.name})`);\r\n      return subcategory;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error updating subcategory ${id}`, err);\r\n      throw new RepositoryError('Error updating subcategory', StatusCodes.INTERNAL_SERVER_ERROR, err);\r\n    }\r\n  }\r\n\r\n   public deleteSubcategory = async(id: string): Promise<ISubcategory | null> =>{\r\n    try {\r\n      logger.debug(`Deleting subcategory: ${id}`);\r\n      const subcategory = await this.findByIdAndDelete(id);\r\n      if (!subcategory) {\r\n        logger.warn(`Subcategory not not found: ${id}`);\r\n        throw new RepositoryError(`Subcategory not found with ID: ${id}`, StatusCodes.NOT_FOUND);\r\n      }\r\n        logger.info(`Subcategory deleted: ${id} (${subcategory.name})`);\r\n      return subcategory;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error deleting subcategory ${id}`, err);\r\n      throw new RepositoryError('Error deleting subcategory', StatusCodes.INTERNAL_SERVER_ERROR, err);\r\n    }\r\n  }\r\n\r\n   deleteManySubcategories = async(\r\n    categoryId: string\r\n  ): Promise<{ deletedCount: number }> =>{\r\n    try {\r\n      logger.debug(`Deleting subcategories for category: ${categoryId}`);\r\n      const result = await this.model.deleteMany({ categoryId }).exec();\r\n      logger.info(`Deleted ${result.deletedCount} subcategories for category ${categoryId}`);\r\n      return result;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error deleting subcategories for category ${categoryId}`, err);\r\n      throw new RepositoryError('Error deleting subcategories', StatusCodes.INTERNAL_SERVER_ERROR, err);\r\n    }\r\n  }\r\n\r\n  public isDuplicateSubcategory = async (name: string, categoryId: string, excludeId?: string): Promise<boolean> => {\r\n    try {\r\n      logger.debug(`Checking duplicate subcategory: ${name} for category: ${categoryId}${excludeId ? `, excluding ID: ${excludeId}` : ''}`);\r\n      const query: any = { name, categoryId };\r\n      if (excludeId) {\r\n        query._id = { $ne: excludeId };\r\n      }\r\n      const existingSubcategory = await this.model.findOne(query).exec();\r\n      const isDuplicate = !!existingSubcategory;\r\n      logger.info(`Duplicate check for subcategory ${name} in category ${categoryId} - ${isDuplicate}`);\r\n      return isDuplicate;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error checking duplicate subcategory ${name} for category ${categoryId}`, err);\r\n      throw new RepositoryError('Error checking duplicate subcategory', StatusCodes.INTERNAL_SERVER_ERROR, err);\r\n    }\r\n  }\r\n}\r\n"]}