{"version":3,"file":"j-w-t.js","sourceRoot":"","sources":["../../../../src/Utils/utils/auth-utils/j-w-t.ts"],"names":[],"mappings":"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","sourcesContent":["import jwt from 'jsonwebtoken';\r\nimport { inject, injectable } from 'inversify';\r\nimport { Response } from 'express';\r\nimport config from '../../../config/env-config';\r\nimport logger from '../../../core/utils/logger';\r\nimport { ServiceError } from '../../../core/utils/error-handler';\r\nimport { IUserRepository } from '../../../Interfaces/Repository/i-user-repositry';\r\nimport { IJWTService } from '../../../Interfaces/Services/i-jwt-service';\r\n\r\ninterface JwtPayload {\r\n  [key: string]: any;\r\n}\r\n\r\n@injectable()\r\nexport class JWTServiceClass implements IJWTService{\r\n  private userRepo: IUserRepository;\r\n\r\n  constructor(@inject('IUserRepository') userRepository : IUserRepository) {\r\n    this.userRepo = userRepository;\r\n  }\r\n\r\n  public generateAccessToken = (payload: JwtPayload, expiresIn: string = '1h'): string => {\r\n    if (!config.jwtSecret) {\r\n      logger.error('JWT secret is not defined');\r\n      throw new ServiceError('JWT secret is not defined');\r\n    }\r\n    if (typeof payload !== 'object' || payload === null) {\r\n      logger.error('Payload must be a plain object');\r\n      throw new ServiceError('Payload must be a plain object');\r\n    }\r\n    try {\r\n      const token = jwt.sign(payload, config.jwtSecret, { expiresIn });\r\n      logger.debug(`Generated access token for payload: ${JSON.stringify(payload)}`);\r\n      return token;\r\n    } catch (error: any) {\r\n      logger.error(`Failed to generate access token: ${error.message}`);\r\n      throw new ServiceError(`Failed to generate access token: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  public verifyAccessToken = (token: string): JwtPayload => {\r\n    logger.info(`Token Received : ${token}`);\r\n    if (!config.jwtSecret) {\r\n      logger.error('JWT secret is not defined');\r\n      throw new ServiceError('JWT secret is not defined');\r\n    }\r\n    try {\r\n      const payload = jwt.verify(token, config.jwtSecret) as JwtPayload;\r\n      logger.info(`Payload after verification : ${payload}`);\r\n      if(!payload){\r\n        throw new ServiceError('Payload for JWT not verified');\r\n      }\r\n      logger.debug(`Verified access token: ${token}`);\r\n      return payload;\r\n    } catch (error) {\r\n      logger.info(error);\r\n      logger.error(`Invalid or expired access token: ${token}`);\r\n      throw new ServiceError('Invalid or expired access token');\r\n    }\r\n  }\r\n\r\n  public generateRefreshToken = (payload: JwtPayload): string => {\r\n    if (!config.jwtSecret) {\r\n      logger.error('JWT secret is not defined');\r\n      throw new ServiceError('JWT secret is not defined');\r\n    }\r\n    if (typeof payload !== 'object' || payload === null) {\r\n      logger.error('Payload must be a plain object');\r\n      throw new ServiceError('Payload must be a plain object');\r\n    }\r\n    try {\r\n      const token = jwt.sign(payload, config.jwtSecret, { expiresIn: '7d' });\r\n      logger.debug(`Generated refresh token for payload: ${JSON.stringify(payload)}`);\r\n      return token;\r\n    } catch (error: any) {\r\n      logger.error(`Failed to generate refresh token: ${error.message}`);\r\n      throw new ServiceError(`Failed to generate refresh token: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  public verifyRefreshToken = (token: string): JwtPayload => {\r\n    if (!config.jwtSecret) {\r\n      logger.error('JWT secret is not defined');\r\n      throw new ServiceError('JWT secret is not defined');\r\n    }\r\n    try {\r\n      const payload = jwt.verify(token, config.jwtSecret) as JwtPayload;\r\n      logger.debug(`Verified refresh token: ${token}`);\r\n      return payload;\r\n    } catch (error) {\r\n      logger.info(error);\r\n      logger.error(`Invalid or expired refresh token: ${token}`);\r\n      throw new ServiceError('Invalid or expired refresh token');\r\n    }\r\n  }\r\n\r\n  public setTokensInCookies = (res: Response, accessToken: string, refreshToken: string): void => {\r\n    const isProduction = config.node_env === 'production';\r\n    try {\r\n      res.cookie('accessToken', accessToken, {\r\n        httpOnly: true,\r\n        secure: isProduction,\r\n        sameSite: isProduction ? 'none' : 'lax',\r\n        maxAge: 60 * 60 * 1000, // 1 hour\r\n      });\r\n      res.cookie('refreshToken', refreshToken, {\r\n        httpOnly: true,\r\n        secure: isProduction,\r\n        sameSite: isProduction ? 'none' : 'lax',\r\n        maxAge: 7 * 24 * 60 * 60 * 1000, // 7 days\r\n      });\r\n      logger.debug('Set accessToken and refreshToken in cookies');\r\n    } catch (error: any) {\r\n      logger.error(`Failed to set tokens in cookies: ${error.message}`);\r\n      throw new ServiceError(`Failed to set tokens in cookies: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  public clearCookies = (res: Response): void => {\r\n    try {\r\n      res.clearCookie('accessToken', { httpOnly: true, sameSite: 'strict' });\r\n      res.clearCookie('refreshToken', { httpOnly: true, sameSite: 'strict' });\r\n      logger.debug('Cleared accessToken and refreshToken cookies');\r\n    } catch (error: any) {\r\n      logger.error(`Failed to clear cookies: ${error.message}`);\r\n      throw new ServiceError(`Failed to clear cookies: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  public removeRefreshToken = async(userEmail: string): Promise<{ message: string }> => {\r\n    try {\r\n      const user = await this.userRepo.findUserByEmail(userEmail);\r\n      if (!user) {\r\n        logger.error(`User not found for email: ${userEmail}`);\r\n        throw new ServiceError('User not found');\r\n      }\r\n      await this.userRepo.removeRefreshToken(userEmail);\r\n      logger.info(`Refresh token removed for user: ${userEmail}`);\r\n      return { message: 'Refresh token removed successfully' };\r\n    } catch (error: any) {\r\n      logger.error(`Error removing refresh token for user ${userEmail}: ${error.message}`);\r\n      throw new ServiceError(`Error removing refresh token: ${error.message}`);\r\n    }\r\n  }\r\n}"]}