{"version":3,"file":"otp-redis-helper.js","sourceRoot":"","sources":["../../../../src/Utils/utils/auth-utils/otp-redis-helper.ts"],"names":[],"mappings":"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","sourcesContent":["import { v4 as uuidv4 } from \"uuid\";\r\nimport { redisClient } from \"../../../config/redis-client-config\";\r\nimport { OtpPurpose, OtpRedisPayload } from \"../../types/auth-types\";\r\n\r\n\r\n //Generate unique OTP session id\r\nexport const generateOtpId = (): string => {\r\n  return uuidv4();\r\n};\r\n\r\n//Redis key for OTP\r\nconst buildOtpKey = (\r\n  purpose: OtpPurpose,\r\n  email: string,\r\n  otpId: string\r\n): string => {\r\n  return `otp:${purpose}:${email}:${otpId}`;\r\n};\r\n\r\n//Save OTP to Redis with TTL\r\nexport const saveOtpToRedis = async (\r\n  payload: OtpRedisPayload,\r\n  ttlSeconds: number = 300\r\n): Promise<string> => {\r\n  const otpId = generateOtpId();\r\n  const key = buildOtpKey(payload.purpose, payload.email, otpId);\r\n\r\n  await redisClient.set(key, JSON.stringify(payload), \"EX\", ttlSeconds);\r\n\r\n  return otpId;\r\n};\r\n\r\n//Get OTP from Redis\r\nexport const getOtpFromRedis = async (\r\n  purpose: OtpPurpose,\r\n  email: string,\r\n  otpId: string\r\n): Promise<OtpRedisPayload | null> => {\r\n  const key = buildOtpKey(purpose, email, otpId);\r\n  const value: string | null = await redisClient.get(key);\r\n  if (!value) return null;\r\n  return JSON.parse(value) as OtpRedisPayload;\r\n};\r\n\r\n//Delete OTP from Redis\r\nexport const deleteOtpFromRedis = async (\r\n  purpose: OtpPurpose,\r\n  email: string,\r\n  otpId: string\r\n): Promise<void> => {\r\n  const key = buildOtpKey(purpose, email, otpId);\r\n  await redisClient.del(key);\r\n};\r\n\r\n//Increment OTP attempt count\r\nexport const incrementOtpAttempts = async (\r\n  purpose: OtpPurpose,\r\n  email: string,\r\n  otpId: string\r\n): Promise<number> => {\r\n  const key = buildOtpKey(purpose, email, otpId);\r\n  const value: string | null = await redisClient.get(key);\r\n  if (!value) {\r\n    throw new Error(\"OTP session not found\");\r\n  }\r\n  const payload: OtpRedisPayload = JSON.parse(value);\r\n  payload.attempts += 1;\r\n  await redisClient.set(key, JSON.stringify(payload));\r\n  return payload.attempts;\r\n};\r\n\r\n//Verify the otp with otpId\r\nexport const verifyOtpFromRedis = async (\r\n  purpose: OtpPurpose,\r\n  email: string,\r\n  otpId: string,\r\n  providedOtp: string,\r\n  maxAttempts: number = 5\r\n): Promise<OtpRedisPayload> => {\r\n  const payload = await getOtpFromRedis(purpose, email, otpId);\r\n\r\n  if (!payload) {\r\n    throw new Error(\"OTP expired or not found\");\r\n  }\r\n  if (payload.otp !== providedOtp) {\r\n    const attempts = await incrementOtpAttempts(purpose, email, otpId);\r\n    if (attempts >= maxAttempts) {\r\n      await deleteOtpFromRedis(purpose, email, otpId);\r\n      throw new Error(\"Maximum OTP attempts exceeded\");\r\n    }\r\n    throw new Error(\"Invalid OTP\");\r\n  }\r\n  await deleteOtpFromRedis(purpose, email, otpId);\r\n  return payload;\r\n};"]}