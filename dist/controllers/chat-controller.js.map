{"version":3,"file":"chat-controller.js","sourceRoot":"","sources":["../../src/controllers/chat-controller.ts"],"names":[],"mappings":"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","sourcesContent":["import { Request, Response, NextFunction } from 'express';\r\nimport { BaseController } from '../core/controller/base-controller';\r\nimport logger from '../core/utils/logger';\r\nimport { HttpError } from '../core/utils/error-handler';\r\nimport { IChatController } from '../Interfaces/Controller/i-chat-controller';\r\nimport { StatusCodes } from \"../enums/status-code-enums\";\r\nimport { IChatService } from '../Interfaces/Services/i-chat-service';\r\nimport { inject, injectable } from 'inversify';\r\nimport { CHAT_MESSAGES } from '../constants/messages';\r\nimport { ERROR_MESSAGES } from '../constants/error-messages';\r\n\r\n@injectable()\r\nexport class ChatController extends BaseController implements IChatController{\r\n  private _chatService: IChatService;\r\n\r\n  constructor(\r\n    @inject('IChatService') chatService : IChatService,\r\n  ) {\r\n    super();\r\n    this._chatService = chatService;\r\n  }\r\n\r\n  getChatMessages = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\r\n    try {\r\n      const { contactId, groupId, page = \"1\", limit = \"10\" } = req.query;\r\n      const parsedPage = parseInt(page as string, 10);\r\n      const parsedLimit = parseInt(limit as string, 10);\r\n\r\n      if (isNaN(parsedPage) || parsedPage < 1) {\r\n        throw new HttpError(ERROR_MESSAGES.INVALID_PAGE_NUMBER, StatusCodes.BAD_REQUEST);\r\n      }\r\n      if (isNaN(parsedLimit) || parsedLimit < 1) {\r\n        throw new HttpError(ERROR_MESSAGES.INVALID_LIMIT_VALUE, StatusCodes.BAD_REQUEST);\r\n      }\r\n\r\n      logger.debug(`Fetching chat messages with contactId: ${contactId}, groupId: ${groupId}, page: ${parsedPage}, limit: ${parsedLimit}`);\r\n\r\n      const result = await this._chatService.getChatMessages(contactId as string | undefined, groupId as string | undefined, parsedPage, parsedLimit);\r\n\r\n      if (result.messages.length === 0) {\r\n        this.sendSuccess(\r\n          res,\r\n          { messages: [], total: 0, page: parsedPage, limit: parsedLimit },\r\n          contactId ? CHAT_MESSAGES.NO_MESSAGES_FOUND_FOR_CONTACT : CHAT_MESSAGES.NO_MESSAGES_FOUND_FOR_GROUP\r\n        );\r\n        logger.info(`No messages found for contactId: ${contactId || \"none\"}, groupId: ${groupId || \"none\"}`);\r\n        return;\r\n      }\r\n\r\n      this.sendSuccess(\r\n        res,\r\n        { messages: result.messages, total: result.total, page: parsedPage, limit: parsedLimit },\r\n        CHAT_MESSAGES.MESSAGES_RETRIEVED\r\n      );\r\n      logger.info(`Fetched ${result.messages.length} messages, total: ${result.total}`);\r\n    } catch (error: any) {\r\n      logger.error(`Error fetching chat messages: ${error.message}`);\r\n      next(error);\r\n    }\r\n  };\r\n\r\n  uploadAndSaveMessage = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\r\n    try {\r\n      const { senderId, targetId, type, collaborationId, userConnectionId, groupId } = req.body;\r\n      if (!req.file || !senderId || !targetId || !type) {\r\n        throw new HttpError(ERROR_MESSAGES.REQUIRED_MESSAGE_FIELDS, StatusCodes.BAD_REQUEST);\r\n      }\r\n\r\n      logger.debug(`Uploading and saving message: senderId=${senderId}, targetId=${targetId}, type=${type}`);\r\n\r\n      const result = await this._chatService.uploadAndSaveMessage({\r\n        senderId,\r\n        targetId,\r\n        type,\r\n        collaborationId,\r\n        userConnectionId,\r\n        groupId,\r\n        file: {\r\n          path: req.file.path,\r\n          size: req.file.size,\r\n          originalname: req.file.originalname,\r\n          mimetype: req.file.mimetype,\r\n        },\r\n      });\r\n\r\n      this.sendCreated(res, { url: result.url, thumbnailUrl: result.thumbnailUrl, messageId: result.messageId }, CHAT_MESSAGES.MESSAGE_UPLOADED);\r\n      logger.info(`Saved message: ${result.messageId}`);\r\n    } catch (error: any) {\r\n      if (error.http_code === StatusCodes.BAD_REQUEST && error.message.includes(\"Video is too large\")) {\r\n        throw new HttpError(ERROR_MESSAGES.VIDEO_TOO_LARGE, StatusCodes.BAD_REQUEST);\r\n      }\r\n      logger.error(`Error uploading and saving message: ${error.message}`);\r\n      next(error);\r\n    }\r\n  };\r\n\r\n  getUnreadMessageCounts = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\r\n    try {\r\n      const { userId } = req.query;\r\n      if (!userId) {\r\n        throw new HttpError(ERROR_MESSAGES.REQUIRED_USER_ID, StatusCodes.BAD_REQUEST);\r\n      }\r\n      const unreadCounts = await this._chatService.getUnreadMessageCounts(userId as string);\r\n      if (Object.keys(unreadCounts).length === 0) {\r\n        this.sendSuccess(res, { unreadCounts: {} }, CHAT_MESSAGES.NO_UNREAD_MESSAGES);\r\n        logger.info(`No unread messages found for userId: ${userId}`);\r\n        return;\r\n      }\r\n      logger.debug(\"Unread Counts: %s\", JSON.stringify(unreadCounts, null, 2));\r\n      this.sendSuccess(res, unreadCounts, CHAT_MESSAGES.UNREAD_COUNTS_RETRIEVED);\r\n    } catch (error: any) {\r\n      next(error);\r\n    }\r\n  };\r\n\r\n  getLastMessageSummaries = async (req: Request, res: Response, next: NextFunction): Promise<void> => {\r\n    try {\r\n      const { userId } = req.query;\r\n      if (!userId) {\r\n        throw new HttpError(ERROR_MESSAGES.REQUIRED_USER_ID, StatusCodes.BAD_REQUEST);\r\n      }\r\n      const summaries = await this._chatService.getLastMessageSummaries( userId as string );\r\n      this.sendSuccess( res, summaries, CHAT_MESSAGES.LAST_MESSAGE_SUMMARIES_RETRIEVED  );\r\n    } catch (error) {\r\n      next(error);\r\n    }\r\n  };\r\n}"]}