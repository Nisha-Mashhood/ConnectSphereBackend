{"version":3,"file":"chat-service.js","sourceRoot":"","sources":["../../src/services/chat-service.ts"],"names":[],"mappings":"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","sourcesContent":["import { inject, injectable } from \"inversify\";\r\nimport { Types } from \"mongoose\";\r\nimport { IChatMessage } from \"../Interfaces/Models/i-chat-message\";\r\nimport { IChatRepository } from \"../Interfaces/Repository/i-chat-repositry\";\r\nimport { IContactRepository } from \"../Interfaces/Repository/i-contact-repositry\";\r\nimport { IGroupRepository } from \"../Interfaces/Repository/i-group-repositry\";\r\nimport logger from \"../core/utils/logger\";\r\nimport { IContact } from \"../Interfaces/Models/i-contact\";\r\nimport { StatusCodes } from \"../enums/status-code-enums\";\r\nimport { ServiceError } from \"../core/utils/error-handler\";\r\nimport { IChatService } from \"../Interfaces/Services/i-chat-service\";\r\nimport { uploadMedia } from \"../core/utils/cloudinary\";\r\nimport { IChatMessageDTO } from \"../Interfaces/DTOs/i-chat-message-dto\";\r\nimport { toChatMessageDTOs } from \"../Utils/mappers/chat-message-mapper\";\r\nimport { LastMessageSummary } from \"../Utils/types/contact-types\";\r\n\r\n@injectable()\r\nexport class ChatService implements IChatService {\r\n  private _chatRepository: IChatRepository;\r\n  private _contactRepository: IContactRepository;\r\n  private _groupRepository: IGroupRepository;\r\n  \r\n  constructor(\r\n    @inject('IChatRepository') chatRepository : IChatRepository,\r\n    @inject('IContactRepository') contactRepository : IContactRepository,\r\n    @inject('IGroupRepository') groupRepository : IGroupRepository\r\n  ) {\r\n    this._chatRepository = chatRepository;\r\n    this._contactRepository = contactRepository;\r\n    this._groupRepository = groupRepository;\r\n  }\r\n\r\n  getChatMessages = async (\r\n    contactId?: string,\r\n    groupId?: string,\r\n    page: number = 1,\r\n    limit: number = 10\r\n  ): Promise<{ messages: IChatMessageDTO[]; total: number }> => {\r\n    try {\r\n      logger.debug(\r\n        `Fetching chat messages for contact: ${contactId}, group: ${groupId}, page: ${page}, limit: ${limit}`\r\n      );\r\n      if (!contactId && !groupId) {\r\n        throw new ServiceError(\r\n          \"Contact ID or Group ID is required to fetch chat messages\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n      if (contactId && groupId) {\r\n        throw new ServiceError(\r\n          \"Provide only one of Contact ID or Group ID, not both\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      let messages: IChatMessage[] = [];\r\n      let total = 0;\r\n\r\n      if (groupId) {\r\n        if (!Types.ObjectId.isValid(groupId)) {\r\n          throw new ServiceError(\r\n            \"Invalid group ID: must be a 24 character hex string\",\r\n            StatusCodes.BAD_REQUEST\r\n          );\r\n        }\r\n        const group = await this._groupRepository.getGroupById(groupId);\r\n        if (!group) {\r\n          throw new ServiceError(\"Invalid group ID\", StatusCodes.NOT_FOUND);\r\n        }\r\n        messages = await this._chatRepository.findChatMessagesByGroupId(\r\n          groupId,\r\n          page,\r\n          limit\r\n        );\r\n        total = await this._chatRepository.countMessagesByGroupId(groupId);\r\n      } else if (contactId) {\r\n        if (!Types.ObjectId.isValid(contactId)) {\r\n          throw new ServiceError(\r\n            \"Invalid contact ID: must be a 24 character hex string\",\r\n            StatusCodes.BAD_REQUEST\r\n          );\r\n        }\r\n        const contact: IContact | null = await this._contactRepository.findContactById(\r\n          contactId\r\n        );\r\n        if (!contact) {\r\n          throw new ServiceError(\"Invalid contact ID\", StatusCodes.NOT_FOUND);\r\n        }\r\n\r\n        if (contact.type === \"user-mentor\" && contact.collaborationId) {\r\n          messages = await this._chatRepository.findChatMessagesByCollaborationId(\r\n            contact.collaborationId.toString(),\r\n            page,\r\n            limit\r\n          );\r\n          total = await this._chatRepository.countMessagesByCollaborationId(\r\n            contact.collaborationId.toString()\r\n          );\r\n        } else if (contact.type === \"user-user\" && contact.userConnectionId) {\r\n          messages = await this._chatRepository.findChatMessagesByUserConnectionId(\r\n            contact.userConnectionId.toString(),\r\n            page,\r\n            limit\r\n          );\r\n          total = await this._chatRepository.countMessagesByUserConnectionId(\r\n            contact.userConnectionId.toString()\r\n          );\r\n        } else {\r\n          throw new ServiceError(\r\n            \"No valid connection ID found for contact\",\r\n            StatusCodes.BAD_REQUEST\r\n          );\r\n        }\r\n      }\r\n\r\n      const messagesDTO = toChatMessageDTOs(messages);\r\n      return { messages: messagesDTO.reverse(), total };\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error fetching chat messages: ${err.message}`);\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to fetch chat messages\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  getUnreadMessageCounts = async (\r\n    userId: string\r\n  ): Promise<{ [key: string]: number }> => {\r\n    try {\r\n      logger.debug(`Fetching unread message counts for user: ${userId}`);\r\n      if (!userId) {\r\n        throw new ServiceError(\"User ID is required\", StatusCodes.BAD_REQUEST);\r\n      }\r\n      if (!Types.ObjectId.isValid(userId)) {\r\n        throw new ServiceError(\r\n          \"Invalid user ID: must be a 24 character hex string\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      const contacts = await this._contactRepository.findContactsByUserId(userId);\r\n      logger.debug(`Found ${contacts.length} contacts for user: ${userId}`);\r\n      const unreadCounts: { [key: string]: number } = {};\r\n\r\n      if (contacts.length === 0) {\r\n        logger.info(`No contacts found for user: ${userId}`);\r\n        return unreadCounts;\r\n      }\r\n\r\n      for (const contact of contacts) {\r\n        let count = 0;\r\n        try {\r\n          if (contact.type === \"group\" && contact.groupId) {\r\n            const groupIdStr = contact.groupId._id?.toString();\r\n            if (!groupIdStr) continue;\r\n            count = await this._chatRepository.countUnreadMessagesByGroupId(\r\n              groupIdStr,\r\n              userId\r\n            );\r\n            unreadCounts[`group_${groupIdStr}`] = count;\r\n          } else if (\r\n            contact.type === \"user-mentor\" &&\r\n            contact.collaborationId\r\n          ) {\r\n            const collabIdStr = contact.collaborationId._id?.toString();\r\n            if (!collabIdStr) continue;\r\n            count = await this._chatRepository.countUnreadMessagesByCollaborationId(\r\n              collabIdStr,\r\n              userId\r\n            );\r\n            unreadCounts[`user-mentor_${collabIdStr}`] = count;\r\n          } else if (contact.type === \"user-user\" && contact.userConnectionId) {\r\n            const userConnIdStr = contact.userConnectionId._id?.toString();\r\n            if (!userConnIdStr) continue;\r\n            count = await this._chatRepository.countUnreadMessagesByUserConnectionId(\r\n              userConnIdStr,\r\n              userId\r\n            );\r\n            unreadCounts[`user-user_${userConnIdStr}`] = count;\r\n          }\r\n        } catch (error: unknown) {\r\n          const err = error instanceof Error ? error : new Error(String(error));\r\n          logger.warn(\r\n            `Skipping unread count for contact ${contact._id}: ${err.message}`\r\n          );\r\n          const id =\r\n            contact.groupId?._id?.toString() ||\r\n            contact.collaborationId?._id?.toString() ||\r\n            contact.userConnectionId?._id?.toString() ||\r\n            \"unknown\";\r\n          unreadCounts[`${contact.type}_${id}`] = 0;\r\n        }\r\n      }\r\n\r\n      logger.info(`Unread message counts: ${JSON.stringify(unreadCounts)}`);\r\n      return unreadCounts;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error fetching unread message counts for user ${userId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to fetch unread message counts\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  uploadAndSaveMessage = async (data: {\r\n    senderId: string;\r\n    targetId: string;\r\n    type: 'user-mentor' | 'user-user' | 'group';\r\n    collaborationId?: string;\r\n    userConnectionId?: string;\r\n    groupId?: string;\r\n    file: {\r\n      path: string;\r\n      size?: number;\r\n      originalname?: string;\r\n      mimetype?: string;\r\n    };\r\n  }): Promise<{ url: string; thumbnailUrl?: string; messageId: string }> => {\r\n    try {\r\n      logger.debug(`Uploading and saving message: senderId=${data.senderId}, targetId=${data.targetId}, type=${data.type}`);\r\n\r\n      // Validate message type and associated IDs\r\n      if (data.type === 'user-mentor' && !data.collaborationId) {\r\n        throw new ServiceError('Collaboration ID is required for user-mentor messages', StatusCodes.BAD_REQUEST);\r\n      }\r\n      if (data.type === 'user-user' && !data.userConnectionId) {\r\n        throw new ServiceError('User connection ID is required for user-user messages', StatusCodes.BAD_REQUEST);\r\n      }\r\n      if (data.type === 'group' && !data.groupId) {\r\n        throw new ServiceError('Group ID is required for group messages', StatusCodes.BAD_REQUEST);\r\n      }\r\n\r\n      // Ensure only the relevant ID is included\r\n      if (data.type !== 'user-mentor' && data.collaborationId) {\r\n        throw new ServiceError('Collaboration ID is only valid for user-mentor messages', StatusCodes.BAD_REQUEST);\r\n      }\r\n      if (data.type !== 'user-user' && data.userConnectionId) {\r\n        throw new ServiceError('User connection ID is only valid for user-user messages', StatusCodes.BAD_REQUEST);\r\n      }\r\n      if (data.type !== 'group' && data.groupId) {\r\n        throw new ServiceError('Group ID is only valid for group messages', StatusCodes.BAD_REQUEST);\r\n      }\r\n\r\n      const folder = data.type === 'group' ? 'group_chat_media' : 'chat_media';\r\n      const contentType = data.file.mimetype?.startsWith('image/')\r\n        ? 'image'\r\n        : data.file.mimetype?.startsWith('video/')\r\n        ? 'video'\r\n        : 'file';\r\n      const { url, thumbnailUrl } = await uploadMedia(data.file.path, folder, data.file.size, contentType);\r\n\r\n      const message = await this._chatRepository.saveChatMessage({\r\n        senderId: data.senderId,\r\n        content: url,\r\n        thumbnailUrl,\r\n        contentType,\r\n        collaborationId: data.collaborationId,\r\n        userConnectionId: data.userConnectionId,\r\n        groupId: data.groupId,\r\n        fileMetadata: {\r\n          fileName: data.file.originalname,\r\n          fileSize: data.file.size,\r\n          mimeType: data.file.mimetype,\r\n        },\r\n        timestamp: new Date(),\r\n      });\r\n\r\n      logger.info(`Saved message: ${message._id}`);\r\n      return { url, thumbnailUrl, messageId: message._id.toString() };\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error uploading and saving message: ${err.message}`);\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to upload and save message\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  getLastMessageSummaries = async (\r\n  userId: string\r\n): Promise<{ [chatKey: string]: LastMessageSummary }> => {\r\n  try {\r\n    logger.debug(`Fetching last message summaries for user: ${userId}`);\r\n    if (!userId) {\r\n      throw new ServiceError(\"User ID is required\", StatusCodes.BAD_REQUEST);\r\n    }\r\n    if (!Types.ObjectId.isValid(userId)) {\r\n      throw new ServiceError(\r\n        \"Invalid user ID: must be a 24 character hex string\",\r\n        StatusCodes.BAD_REQUEST\r\n      );\r\n    }\r\n\r\n    const contacts = await this._contactRepository.findContactsByUserId(userId);\r\n    const summaries: { [chatKey: string]: LastMessageSummary } = {};\r\n\r\n    for (const contact of contacts) {\r\n      try {\r\n        if (contact.type === \"group\" && contact.groupId?._id) {\r\n          const groupId = contact.groupId._id.toString();\r\n          const msg = await this._chatRepository.findLatestMessageByGroupId(\r\n            groupId\r\n          );\r\n          if (msg) {\r\n            summaries[`group_${groupId}`] = {\r\n              content: msg.content,\r\n              senderId: msg.senderId.toString(),\r\n              timestamp: msg.timestamp,\r\n              contentType: msg.contentType as any,\r\n            };\r\n          }\r\n        } else if (\r\n          contact.type === \"user-mentor\" &&\r\n          contact.collaborationId?._id\r\n        ) {\r\n          const collabId = contact.collaborationId._id.toString();\r\n          const msg =\r\n            await this._chatRepository.findLatestMessageByCollaborationId(\r\n              collabId\r\n            );\r\n          if (msg) {\r\n            summaries[`user-mentor_${collabId}`] = {\r\n              content: msg.content,\r\n              senderId: msg.senderId.toString(),\r\n              timestamp: msg.timestamp,\r\n              contentType: msg.contentType as any,\r\n            };\r\n          }\r\n        } else if (\r\n          contact.type === \"user-user\" &&\r\n          contact.userConnectionId?._id\r\n        ) {\r\n          const connId = contact.userConnectionId._id.toString();\r\n          const msg =\r\n            await this._chatRepository.findLatestMessageByUserConnectionId(\r\n              connId\r\n            );\r\n          if (msg) {\r\n            summaries[`user-user_${connId}`] = {\r\n              content: msg.content,\r\n              senderId: msg.senderId.toString(),\r\n              timestamp: msg.timestamp,\r\n              contentType: msg.contentType as any,\r\n            };\r\n          }\r\n        }\r\n      } catch (err: any) {\r\n        logger.warn(\r\n          `Skipping last message summary for contact ${contact._id}: ${err.message}`\r\n        );\r\n      }\r\n    }\r\n\r\n    return summaries;\r\n  } catch (error: unknown) {\r\n    const err = error instanceof Error ? error : new Error(String(error));\r\n    logger.error(\r\n      `Error fetching last message summaries for user ${userId}: ${err.message}`\r\n    );\r\n    throw error instanceof ServiceError\r\n      ? error\r\n      : new ServiceError(\r\n          \"Failed to fetch last message summaries\",\r\n          StatusCodes.INTERNAL_SERVER_ERROR,\r\n          err\r\n        );\r\n  }\r\n};\r\n}\r\n"]}