{"version":3,"file":"collaboration-service.js","sourceRoot":"","sources":["../../src/services/collaboration-service.ts"],"names":[],"mappings":"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","sourcesContent":["import { inject, injectable } from \"inversify\";\r\nimport mongoose, { Types } from \"mongoose\";\r\nimport { v4 as uuid } from \"uuid\";\r\nimport PDFDocument from \"pdfkit\";\r\nimport { StatusCodes } from \"../enums/status-code-enums\";\r\nimport { ICollaboration } from \"../Interfaces/Models/i-collaboration\";\r\nimport { IMentorRequest } from \"../Interfaces/Models/i-mentor-request\";\r\nimport { IUser } from \"../Interfaces/Models/i-user\";\r\nimport { IMentor } from \"../Interfaces/Models/i-mentor\";\r\nimport { ICollaborationService } from \"../Interfaces/Services/i-collaboration-service\";\r\nimport { LockedSlot } from \"../Utils/types/collaboration-types\";\r\nimport { ServiceError } from \"../core/utils/error-handler\";\r\nimport { sendEmail } from \"../core/utils/email\";\r\nimport stripe from \"../core/utils/stripe\";\r\nimport logger from \"../core/utils/logger\";\r\nimport { ICollaborationRepository } from \"../Interfaces/Repository/i-collaboration-repositry\";\r\nimport { IContactRepository } from \"../Interfaces/Repository/i-contact-repositry\";\r\nimport { IMentorRepository } from \"../Interfaces/Repository/i-mentor-repositry\";\r\nimport { IUserRepository } from \"../Interfaces/Repository/i-user-repositry\";\r\nimport { INotificationService } from \"../Interfaces/Services/i-notification-service\";\r\nimport { IMentorRequestDTO } from \"../Interfaces/DTOs/i-mentor-request-dto\";\r\nimport { toMentorRequestDTO, toMentorRequestDTOs } from \"../Utils/mappers/mentor-request-mapper\";\r\nimport { toCollaborationDTO } from \"../Utils/mappers/collaboration-mapper\";\r\nimport { ICollaborationDTO } from \"../Interfaces/DTOs/i-collaboration-dto\";\r\nimport Stripe from \"stripe\";\r\n\r\n@injectable()\r\nexport class CollaborationService implements ICollaborationService {\r\n  private _collabRepository: ICollaborationRepository;\r\n  private _contactRepository: IContactRepository;\r\n  private _mentorRepository: IMentorRepository;\r\n  private _userRepository: IUserRepository;\r\n  private _notificationService: INotificationService;\r\n\r\n  constructor(\r\n    @inject('ICollaborationRepository') collaboartionRepository : ICollaborationRepository,\r\n    @inject('IContactRepository') contactRepository : IContactRepository,\r\n    @inject('IMentorRepository') mentorRepository : IMentorRepository,\r\n    @inject('IUserRepository') userRepository : IUserRepository,\r\n    @inject('INotificationService') notificationService : INotificationService\r\n  ) {\r\n    this._collabRepository = collaboartionRepository;\r\n    this._contactRepository = contactRepository;\r\n    this._mentorRepository = mentorRepository;\r\n    this._userRepository = userRepository;\r\n    this._notificationService = notificationService;\r\n  }\r\n\r\n  public TemporaryRequestService = async (\r\n    requestData: Partial<IMentorRequest>\r\n  ): Promise<IMentorRequestDTO | null> => {\r\n    try {\r\n      logger.debug(`Creating temporary request`);\r\n      const request = await this._collabRepository.createTemporaryRequest({\r\n        ...requestData,\r\n        paymentStatus: \"Pending\",\r\n        isAccepted: \"Pending\",\r\n      });\r\n      logger.info(`Temporary request created: ${request._id}`);\r\n      return toMentorRequestDTO(request);\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error creating temporary request: ${err.message}`);\r\n      throw new ServiceError(\r\n        \"Failed to create temporary request\",\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  };\r\n\r\n  public getMentorRequests = async (\r\n    mentorId: string\r\n  ): Promise<IMentorRequestDTO[]> => {\r\n    try {\r\n      logger.debug(`Fetching mentor requests for mentor: ${mentorId}`);\r\n      if (!Types.ObjectId.isValid(mentorId)) {\r\n        throw new ServiceError(\r\n          \"Invalid mentor ID: must be a 24 character hex string\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n      const requests = await this._collabRepository.getMentorRequestsByMentorId(\r\n        mentorId\r\n      );\r\n      logger.info(\r\n        `Fetched ${requests.length} mentor requests for mentorId: ${mentorId}`\r\n      );\r\n      return toMentorRequestDTOs(requests);\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error fetching mentor requests for mentor ${mentorId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to fetch mentor requests\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  private async hasMentorSlotConflict(\r\n    mentorId: string,\r\n    day: string,\r\n    time: string\r\n  ): Promise<boolean> {\r\n    const lockedSlots: LockedSlot[] =\r\n      await this._collabRepository.getLockedSlotsByMentorId(mentorId);\r\n\r\n    const normalizedDay = day.trim().toLowerCase();\r\n    const normalizedTime = time.trim().toLowerCase();\r\n\r\n    return lockedSlots.some((slot) => {\r\n      const slotDay = slot.day.trim().toLowerCase();\r\n      if (slotDay !== normalizedDay) return false;\r\n\r\n      return slot.timeSlots.some(\r\n        (t) => t.trim().toLowerCase() === normalizedTime\r\n      );\r\n    });\r\n  }\r\n\r\n  private async hasUserCollabSlotConflict(\r\n    userId: string,\r\n    day: string,\r\n    time: string\r\n  ): Promise<boolean> {\r\n    const collaborations = await this._collabRepository.getCollabDataForUser(userId);\r\n\r\n    const normalizedDay = day.trim().toLowerCase();\r\n    const normalizedTime = time.trim().toLowerCase();\r\n\r\n    return collaborations.some((collab) => {\r\n      // Skip cancelled or completed collabs\r\n      if (collab.isCancelled || collab.isCompleted) return false;\r\n      if (!Array.isArray(collab.selectedSlot)) return false;\r\n\r\n      return collab.selectedSlot.some((slot) => {\r\n        if (!slot.day || !Array.isArray(slot.timeSlots)) return false;\r\n\r\n        const slotDay = slot.day.trim().toLowerCase();\r\n        if (slotDay !== normalizedDay) return false;\r\n\r\n        return slot.timeSlots.some(\r\n          (t) => t.trim().toLowerCase() === normalizedTime\r\n        );\r\n      });\r\n    });\r\n  }\r\n\r\n  public acceptRequest = async (\r\n    requestId: string\r\n  ): Promise<IMentorRequestDTO | null> => {\r\n    try {\r\n      logger.debug(`Accepting mentor request: ${requestId}`);\r\n      if (!Types.ObjectId.isValid(requestId)) {\r\n        throw new ServiceError(\r\n          \"Invalid request ID: must be a 24 character hex string\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      //Load the request first\r\n    const existingRequest = await this._collabRepository.findMentorRequestById(requestId);\r\n\r\n    if (!existingRequest) {\r\n      throw new ServiceError(\"Mentor request not found\", StatusCodes.NOT_FOUND);\r\n    }\r\n\r\n    if ( !existingRequest.selectedSlot || !existingRequest.selectedSlot.day ||!existingRequest.selectedSlot.timeSlots ) {\r\n      throw new ServiceError( \"Selected time slot not found for this request\", StatusCodes.BAD_REQUEST );\r\n    }\r\n\r\n    const slotDay = existingRequest.selectedSlot.day;\r\n    const rawTime = existingRequest.selectedSlot.timeSlots;\r\n    const slotTime = Array.isArray(rawTime) ? rawTime[0] : rawTime;\r\n    const mentorIdStr = existingRequest.mentorId.toString();\r\n    const userIdStr = existingRequest.userId.toString();\r\n\r\n    //Check mentor schedule (collabs + accepted requests)\r\n    const mentorHasConflict = await this.hasMentorSlotConflict(\r\n      mentorIdStr,\r\n      slotDay,\r\n      slotTime\r\n    );\r\n\r\n    if (mentorHasConflict) {\r\n      throw new ServiceError(\"Mentor already has a session at this time slot\", StatusCodes.BAD_REQUEST);\r\n    }\r\n\r\n    //Check user schedule (confirmed collaborations)\r\n    const userHasConflict = await this.hasUserCollabSlotConflict(\r\n      userIdStr,\r\n      slotDay,\r\n      slotTime\r\n    );\r\n\r\n    if (userHasConflict) {\r\n      throw new ServiceError(\"User already has a confirmed session at this time slot\", StatusCodes.BAD_REQUEST);\r\n    }\r\n\r\n\r\n      const updatedRequest = await this._collabRepository.updateMentorRequestStatus(\r\n        requestId,\r\n        \"Accepted\"\r\n      );\r\n      if (!updatedRequest) {\r\n        throw new ServiceError(\r\n          \"Updating status of request failed\",\r\n          StatusCodes.INTERNAL_SERVER_ERROR\r\n        );\r\n      }\r\n      \r\n      const user = await this._userRepository.findById(\r\n        updatedRequest.userId.toString()\r\n      );\r\n      const mentor = await this._mentorRepository.getMentorById(\r\n        updatedRequest.mentorId.toString()\r\n      );\r\n      if (!user || !mentor || !mentor.userId) {\r\n        throw new ServiceError(\r\n          \"User or mentor details not found\",\r\n          StatusCodes.NOT_FOUND\r\n        );\r\n      }\r\n      const mentorUser = mentor.userId as Pick<IUser, \"_id\" | \"name\" | \"email\">;\r\n\r\n      const userEmail = user.email;\r\n      const userName = user.name;\r\n      const mentorEmail = mentorUser.email;\r\n      const mentorName = mentorUser.name;\r\n\r\n      if (!userEmail || !mentorEmail) {\r\n        throw new ServiceError(\r\n          \"User or mentor email not found\",\r\n          StatusCodes.NOT_FOUND\r\n        );\r\n      }\r\n\r\n      const userSubject = \"Mentor Request Acceptance Notice\";\r\n      const userText = `Dear ${userName},\\n\\nYour mentor request to ${mentorName} has been accepted. Please proceed with the payment to start the collaboration.\\n\\nBest regards,\\nConnectSphere Team`;\r\n      await sendEmail(userEmail, userSubject, userText);\r\n      logger.info(`Acceptance email sent to user: ${userEmail}`);\r\n\r\n      const mentorSubject = \"Mentor Request Acceptance Notice\";\r\n      const mentorText = `Dear ${mentorName},\\n\\nYou have accepted the mentor request from ${userName}. Awaiting payment to start the collaboration.\\n\\nBest regards,\\nConnectSphere Team`;\r\n      await sendEmail(mentorEmail, mentorSubject, mentorText);\r\n      logger.info(`Acceptance email sent to mentor: ${mentorEmail}`);\r\n\r\n      await this._notificationService.sendNotification(\r\n        user._id.toString(),\r\n        \"collaboration_status\",\r\n        mentorUser._id.toString(),\r\n        requestId,\r\n        \"collaboration\",\r\n        undefined,\r\n        undefined,\r\n        `Your mentor request has been accepted by ${mentorUser.name}. Waiting for payment.`\r\n      );\r\n      logger.info(`Sent collaboration_status notification to user ${user._id}`);\r\n\r\n      await this._notificationService.sendNotification(\r\n        mentorUser._id.toString(),\r\n        \"collaboration_status\",\r\n        user._id.toString(),\r\n        requestId,\r\n        \"collaboration\",\r\n        undefined,\r\n        undefined,\r\n        `You have accepted the mentor request from ${user.name}.`\r\n      );\r\n      logger.info(\r\n        `Sent collaboration_status notification to mentor ${mentorUser._id}`\r\n      );\r\n\r\n      return toMentorRequestDTO(updatedRequest);\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error accepting request ${requestId}: ${err.message}`);\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to accept mentor request\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public rejectRequest = async (\r\n    requestId: string\r\n  ): Promise<IMentorRequestDTO | null> => {\r\n    try {\r\n      logger.debug(`Rejecting mentor request: ${requestId}`);\r\n      if (!Types.ObjectId.isValid(requestId)) {\r\n        throw new ServiceError(\r\n          \"Invalid request ID: must be a 24 character hex string\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n      const updatedRequest = await this._collabRepository.updateMentorRequestStatus(\r\n        requestId,\r\n        \"Rejected\"\r\n      );\r\n      if (!updatedRequest) {\r\n        throw new ServiceError(\r\n          \"Updating status of request failed\",\r\n          StatusCodes.INTERNAL_SERVER_ERROR\r\n        );\r\n      }\r\n\r\n      const user = await this._userRepository.findById(\r\n        updatedRequest.userId.toString()\r\n      );\r\n      const mentor = await this._mentorRepository.getMentorById(\r\n        updatedRequest.mentorId.toString()\r\n      );\r\n      if (!user || !mentor || !mentor.userId) {\r\n        throw new ServiceError(\r\n          \"User or mentor details not found\",\r\n          StatusCodes.NOT_FOUND\r\n        );\r\n      }\r\n      const mentorUser = mentor.userId as Pick<IUser, \"_id\" | \"name\" | \"email\">;\r\n\r\n      const userEmail = user.email;\r\n      const userName = user.name;\r\n      const mentorEmail = mentorUser.email;\r\n      const mentorName = mentorUser.name;\r\n\r\n      if (!userEmail || !mentorEmail) {\r\n        throw new ServiceError(\r\n          \"User or mentor email not found\",\r\n          StatusCodes.NOT_FOUND\r\n        );\r\n      }\r\n\r\n      const userSubject = \"Mentor Request Rejection Notice\";\r\n      const userText = `Dear ${userName},\\n\\nYour mentor request to ${mentorName} has been rejected.\\nPlease contact support for more details.\\n\\nBest regards,\\nConnectSphere Team`;\r\n      await sendEmail(userEmail, userSubject, userText);\r\n      logger.info(`Rejection email sent to user: ${userEmail}`);\r\n\r\n      const mentorSubject = \"Mentor Request Rejection Notice\";\r\n      const mentorText = `Dear ${mentorName},\\n\\nYou have rejected the mentor request from ${userName}.\\nPlease contact support for more details.\\n\\nBest regards,\\nConnectSphere Team`;\r\n      await sendEmail(mentorEmail, mentorSubject, mentorText);\r\n      logger.info(`Rejection email sent to mentor: ${mentorEmail}`);\r\n\r\n      await this._notificationService.sendNotification(\r\n        user._id.toString(),\r\n        \"collaboration_status\",\r\n        mentorUser._id.toString(),\r\n        requestId,\r\n        \"collaboration\",\r\n        undefined,\r\n        undefined,\r\n        `Your mentor request to ${mentorUser.name} has been rejected. Check your email for more details.`\r\n      );\r\n      logger.info(`Sent collaboration_status notification to user ${user._id}`);\r\n\r\n      await this._notificationService.sendNotification(\r\n        mentorUser._id.toString(),\r\n        \"collaboration_status\",\r\n        user._id.toString(),\r\n        requestId,\r\n        \"collaboration\",\r\n        undefined,\r\n        undefined,\r\n        `You have rejected the mentor request from ${user.name}. Check your email for more details.`\r\n      );\r\n      logger.info(\r\n        `Sent collaboration_status notification to mentor ${mentorUser._id}`\r\n      );\r\n\r\n      return toMentorRequestDTO(updatedRequest);\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error rejecting request ${requestId}: ${err.message}`);\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to reject mentor request\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public getRequestForUser = async (\r\n    userId: string\r\n  ): Promise<IMentorRequestDTO[]> => {\r\n    try {\r\n      logger.debug(`Fetching requests for user: ${userId}`);\r\n      if (!Types.ObjectId.isValid(userId)) {\r\n        throw new ServiceError(\r\n          \"Invalid user ID: must be a 24 character hex string\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n      const requests = await this._collabRepository.getRequestByUserId(userId);\r\n      logger.info(\r\n        `Fetched ${requests.length} mentor requests for userId: ${userId}`\r\n      );\r\n      return toMentorRequestDTOs(requests);\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error fetching requests for user ${userId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to fetch user requests\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n\r\n  public processPaymentService = async (\r\n  paymentMethodId: string,\r\n  amount: number,\r\n  requestId: string,\r\n  mentorRequestData: Partial<IMentorRequest>,\r\n  email: string,\r\n  returnUrl: string\r\n): Promise<{ paymentIntent: Stripe.PaymentIntent; contacts?: any[] }> => {\r\n  try {\r\n    logger.debug(`Processing payment for request: ${requestId}`);\r\n\r\n    if (!mentorRequestData.mentorId || !mentorRequestData.userId) {\r\n      throw new ServiceError(\r\n        \"Mentor ID and User ID are required\",\r\n        StatusCodes.BAD_REQUEST\r\n      );\r\n    }\r\n\r\n    //Fetch mentor & user\r\n    const mentor  = await this._mentorRepository.getMentorById(\r\n      mentorRequestData.mentorId.toString()\r\n    );\r\n    if (!mentor || !mentor.userId) {\r\n      throw new ServiceError(\r\n        \"Mentor or mentors userId not found\",\r\n        StatusCodes.NOT_FOUND\r\n      );\r\n    }\r\n    const mentorUser = mentor.userId as Pick<IUser, \"_id\" | \"name\" | \"email\">;\r\n\r\n    const user = await this._userRepository.findById(\r\n      mentorRequestData.userId.toString()\r\n    );\r\n    if (!user) {\r\n      throw new ServiceError(\"User not found\", StatusCodes.NOT_FOUND);\r\n    }\r\n\r\n    const idempotencyKey = uuid();\r\n\r\n    let customers = await stripe.customers.list({ email, limit: 1 });\r\n    let customer = customers.data.length > 0 ? customers.data[0] : null;\r\n\r\n    if (!customer) {\r\n      customer = await stripe.customers.create({\r\n        email,\r\n        payment_method: paymentMethodId,\r\n        invoice_settings: { default_payment_method: paymentMethodId },\r\n      });\r\n    }\r\n\r\n    const paymentIntent = await stripe.paymentIntents.create(\r\n      {\r\n        amount,\r\n        currency: \"inr\",\r\n        customer: customer.id,\r\n        payment_method: paymentMethodId,\r\n        confirm: true,\r\n        receipt_email: email,\r\n        description: `Payment for Request ID: ${requestId}`,\r\n        metadata: { requestId },\r\n        return_url: `${returnUrl}?payment_status=success&request_id=${requestId}`,\r\n      },\r\n      { idempotencyKey }\r\n    );\r\n\r\n    // If payment not successful  no DB changes\r\n    if (paymentIntent.status !== \"succeeded\") {\r\n      return { paymentIntent };\r\n    }\r\n\r\n    // ---------- MONGODB TRANSACTION START ----------\r\n    const session = await mongoose.startSession();\r\n    let createdContacts: any[] | undefined;\r\n\r\n    try {\r\n      await session.withTransaction(async () => {\r\n        const startDate = new Date();\r\n        const endDate = new Date(startDate);\r\n        const totalSessions = mentorRequestData.timePeriod || 1;\r\n        const sessionDay = mentorRequestData.selectedSlot?.day;\r\n\r\n        if (!sessionDay) {\r\n          throw new ServiceError(\r\n            \"Selected slot day is required\",\r\n            StatusCodes.BAD_REQUEST\r\n          );\r\n        }\r\n\r\n        // Calculate endDate based on day & number of sessions\r\n        let sessionCount = 0;\r\n        while (sessionCount < totalSessions) {\r\n          endDate.setDate(endDate.getDate() + 1);\r\n          if (\r\n            endDate.toLocaleDateString(\"en-US\", { weekday: \"long\" }) ===\r\n            sessionDay\r\n          ) {\r\n            sessionCount++;\r\n          }\r\n        }\r\n\r\n        // Create collaboration inside transaction\r\n        const collaboration = await this._collabRepository.createCollaboration(\r\n          {\r\n            mentorId: mentorRequestData.mentorId,\r\n            userId: mentorRequestData.userId,\r\n            selectedSlot: mentorRequestData.selectedSlot\r\n              ? [mentorRequestData.selectedSlot]\r\n              : [],\r\n            price: amount / 100,\r\n            payment: true,\r\n            isCancelled: false,\r\n            startDate,\r\n            endDate,\r\n            paymentIntentId: paymentIntent.id,\r\n          },\r\n          session\r\n        );\r\n\r\n        const collaborationDTO = toCollaborationDTO(collaboration);\r\n        if (!collaborationDTO) {\r\n          logger.error(\r\n            `Failed to map collaboration ${collaboration._id} to DTO`\r\n          );\r\n          throw new ServiceError(\r\n            \"Failed to map collaboration to DTO\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR\r\n          );\r\n        }\r\n        logger.info(`Collaboration created: ${collaboration._id}`);\r\n\r\n        // Create contacts inside transaction\r\n        const [contact1, contact2] = await Promise.all([\r\n          this._contactRepository.createContact(\r\n            {\r\n              userId: mentorRequestData.userId ? mentorRequestData.userId.toString() : undefined,\r\n              targetUserId: mentorUser._id.toString(),\r\n              collaborationId: collaboration._id,\r\n              type: \"user-mentor\",\r\n            },\r\n            session\r\n          ),\r\n          this._contactRepository.createContact(\r\n            {\r\n              userId: mentorUser._id.toString(),\r\n              targetUserId: mentorRequestData.userId ? mentorRequestData.userId.toString() : undefined,\r\n              collaborationId: collaboration._id,\r\n              type: \"user-mentor\",\r\n            },\r\n            session\r\n          ),\r\n        ]);\r\n\r\n        createdContacts = [contact1, contact2];\r\n\r\n        // Delete mentor request inside transaction\r\n        await this._collabRepository.deleteMentorRequest(requestId, session);\r\n      });\r\n\r\n      // ---------- TRANSACTION COMMITTED SUCCESSFULLY ----------\r\n\r\n      // Notifications & emails\r\n      await this._notificationService.sendNotification(\r\n        user._id.toString(),\r\n        \"collaboration_status\",\r\n        mentorUser._id.toString(),\r\n        requestId,\r\n        \"collaboration\",\r\n        undefined,\r\n        undefined,\r\n        `Payment completed and collaboration created with ${mentorUser.name}!`\r\n      );\r\n\r\n      await this._notificationService.sendNotification(\r\n          mentorUser._id.toString(),\r\n          \"collaboration_status\",\r\n          user._id.toString(),\r\n          requestId,\r\n          \"collaboration\",\r\n          undefined,\r\n          undefined,\r\n          `${user.name}s payment completed and collaboration created!`\r\n\r\n      );\r\n\r\n      return { paymentIntent, contacts: createdContacts };\r\n    } finally {\r\n      session.endSession();\r\n    }\r\n  } catch (error: unknown) {\r\n    const err = error instanceof Error ? error : new Error(String(error));\r\n    logger.error(\r\n      `Error processing payment for request ${requestId}: ${err.message}`\r\n    );\r\n    throw error instanceof ServiceError\r\n      ? error\r\n      : new ServiceError(\r\n          \"Failed to process payment\",\r\n          StatusCodes.INTERNAL_SERVER_ERROR,\r\n          err\r\n        );\r\n  }\r\n};\r\n\r\n  //Check whether the collbaoration is completed\r\n  private checkAndCompleteCollaboration = async (\r\n    collab: ICollaboration\r\n  ): Promise<ICollaborationDTO | null> => {\r\n    try {\r\n      const currentDate = new Date();\r\n      if (\r\n        !collab.isCancelled &&\r\n        (collab.feedbackGiven ||\r\n          (collab.endDate && collab.endDate <= currentDate))\r\n      ) {\r\n        logger.debug(`Marking collaboration ${collab._id} as complete`);\r\n\r\n        const updatedCollab = await this._collabRepository.findByIdAndUpdateWithPopulate(\r\n          collab._id.toString(),\r\n          { isCompleted: true },\r\n          { new: true }\r\n        );\r\n\r\n        const updatedCollabDTO = toCollaborationDTO(updatedCollab);\r\n        if (!updatedCollabDTO) {\r\n          logger.error(`Failed to map collaboration ${collab._id} to DTO`);\r\n          throw new ServiceError(\"Failed to map collaboration to DTO\", StatusCodes.INTERNAL_SERVER_ERROR);\r\n        }\r\n\r\n       await this._contactRepository.deleteContact(\r\n          collab._id.toString(),\r\n          \"user-mentor\"\r\n        );\r\n        logger.info(\r\n          `Collaboration ${collab._id} was completed, so associated contact was deleted`\r\n        );\r\n\r\n        return updatedCollabDTO;\r\n      }\r\n      const collabDTO = toCollaborationDTO(collab);\r\n      if (!collabDTO) {\r\n        logger.error(`Failed to map collaboration ${collab._id} to DTO`);\r\n        throw new ServiceError(\"Failed to map collaboration to DTO\", StatusCodes.INTERNAL_SERVER_ERROR);\r\n      }\r\n      return collabDTO;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error checking collaboration ${collab._id}: ${err.message}`\r\n      );\r\n      throw new ServiceError(\r\n        \"Failed to check and complete collaboration\",\r\n        StatusCodes.INTERNAL_SERVER_ERROR,\r\n        err\r\n      );\r\n    }\r\n  };\r\n\r\n  public getCollabDataForUserService = async (\r\n    userId: string,\r\n    includeCompleted: boolean = true\r\n  ): Promise<ICollaborationDTO[]> => {\r\n    try {\r\n      logger.debug(`Fetching collaboration data for user: ${userId}`);\r\n      if (!Types.ObjectId.isValid(userId)) {\r\n        throw new ServiceError(\r\n          \"Invalid user ID: must be a 24 character hex string\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n      const collaborations = await this._collabRepository.getCollabDataForUser(userId);\r\n      const updatedCollaborations = await Promise.all(\r\n        collaborations.map(async (collab) => {\r\n          return await this.checkAndCompleteCollaboration(collab);\r\n        })\r\n      );\r\n      const finalCollaborations = includeCompleted\r\n      ? updatedCollaborations.filter((c): c is ICollaborationDTO => c !== null)\r\n      : updatedCollaborations.filter((c): c is ICollaborationDTO => c !== null && !c.isCompleted);\r\n\r\n    logger.info(\r\n      `Fetched ${finalCollaborations.length} ${includeCompleted ? \"total\" : \"active\"} collaborations for userId: ${userId}`\r\n    );\r\n    return finalCollaborations;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error fetching collaborations for user ${userId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to fetch user collaborations\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public getCollabDataForMentorService = async (\r\n    mentorId: string,\r\n    includeCompleted: boolean = true\r\n  ): Promise<ICollaborationDTO[]> => {\r\n    try {\r\n      logger.debug(`Fetching collaboration data for mentor: ${mentorId}`);\r\n      if (!Types.ObjectId.isValid(mentorId)) {\r\n        throw new ServiceError(\r\n          \"Invalid mentor ID: must be a 24 character hex string\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n      const collaborations = await this._collabRepository.getCollabDataForMentor(\r\n        mentorId\r\n      );\r\n      const updatedCollaborations = await Promise.all(\r\n        collaborations.map(async (collab) => {\r\n          return await this.checkAndCompleteCollaboration(collab);\r\n        })\r\n      );\r\n      const finalCollaborations = includeCompleted\r\n      ? updatedCollaborations.filter((c): c is ICollaborationDTO => c !== null)\r\n      : updatedCollaborations.filter((c): c is ICollaborationDTO => c !== null && !c.isCompleted);\r\n\r\n    logger.info(\r\n      `Fetched ${finalCollaborations.length} ${includeCompleted ? \"total\" : \"active\"} collaborations for userId: ${mentorId}`\r\n    );\r\n    return finalCollaborations;\r\n\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error fetching collaborations for mentor ${mentorId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to fetch mentor collaborations\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public cancelAndRefundCollab = async (\r\n    collabId: string,\r\n    reason: string,\r\n    amount: number\r\n  ): Promise<ICollaborationDTO | null> => {\r\n    try {\r\n      logger.debug(\r\n        `Processing cancellation and refund for collaboration: ${collabId}`\r\n      );\r\n      if (!Types.ObjectId.isValid(collabId)) {\r\n        throw new ServiceError(\r\n          \"Invalid collaboration ID: must be a 24 character hex string\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      const collab = await this._collabRepository.findCollabById(collabId);\r\n      if (!collab) {\r\n        throw new ServiceError(\r\n          \"Collaboration not found\",\r\n          StatusCodes.NOT_FOUND\r\n        );\r\n      }\r\n      if (!collab.payment) {\r\n        throw new ServiceError(\r\n          \"No payment found for this collaboration\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n      if (collab.isCancelled) {\r\n        throw new ServiceError(\r\n          \"Collaboration is already cancelled\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      if (collab.paymentIntentId) {\r\n        const refundAmount = Math.round(amount * 100);\r\n        const refund = await stripe.refunds.create({\r\n          payment_intent: collab.paymentIntentId,\r\n          amount: refundAmount,\r\n          reason: \"requested_by_customer\",\r\n          metadata: { collabId, reason },\r\n        });\r\n        logger.info(\r\n          `Refund processed for collaboration ${collabId}: ${\r\n            refund.id\r\n          }, amount: ${refundAmount / 100} INR`\r\n        );\r\n      } else {\r\n        logger.warn(\r\n          `No paymentIntentId for collaboration ${collabId}. Skipping refund and notifying support.`\r\n        );\r\n      }\r\n\r\n      const updatedCollab = await this._collabRepository.markCollabAsCancelled(\r\n        collabId\r\n      );\r\n      const updatedCollabDTO = toCollaborationDTO(updatedCollab);\r\n      if (!updatedCollabDTO) {\r\n        logger.error(`Failed to map collaboration ${updatedCollab?._id} to DTO`);\r\n        throw new ServiceError(\"Failed to map collaboration to DTO\", StatusCodes.INTERNAL_SERVER_ERROR);\r\n      }\r\n      await this._contactRepository.deleteContact(collabId, \"user-mentor\");\r\n\r\n      const user = collab.userId as Pick<IUser, \"_id\" | \"name\" | \"email\">;\r\n      const mentor = (collab.mentorId as { userId: Pick<IUser, \"_id\" | \"name\" | \"email\"> } ).userId;\r\n      logger.info(`[cancel and Refund] user deatils : ${user}`);\r\n      logger.info(`[cancel and Refund] mentor Details : ${mentor}`);\r\n\r\n      if (!user.email || !mentor.email) {\r\n        throw new ServiceError(\r\n          \"User or mentor email not found\",\r\n          StatusCodes.NOT_FOUND\r\n        );\r\n      }\r\n\r\n      //Give notification here also\r\n\r\n      await this._notificationService.sendNotification(\r\n        user._id.toString(),\r\n        \"collaboration_status\",\r\n        mentor._id.toString(),\r\n        collabId,\r\n        \"collaboration\",\r\n        undefined,\r\n        undefined,\r\n        `Your collaboration with ${mentor.name} cancelled.`\r\n      );\r\n      logger.info(`Sent collaboration_status 'cancelled' notification to user ${user._id}`);\r\n\r\n      await this._notificationService.sendNotification(\r\n        mentor._id.toString(),\r\n        \"collaboration_status\",\r\n        user._id.toString(),\r\n        collabId,\r\n        \"collaboration\",\r\n        undefined,\r\n        undefined,\r\n        `You collaboration with ${user.name} cancelled`\r\n      );\r\n      logger.info(\r\n        `Sent collaboration_status 'cancelled' to mentor ${mentor._id}`\r\n      );\r\n\r\n      const userSubject = \"Mentorship Cancellation and Refund Notice\";\r\n      const userText = collab.paymentIntentId\r\n        ? `Dear ${user.name},\\n\\nYour mentorship session with ${\r\n            mentor.name\r\n          } has been cancelled, and a 50% refund of Rs. ${amount.toFixed(\r\n            2\r\n          )} has been processed.\\nReason: ${reason}\\n\\nIf you have any questions, please contact support.\\n\\nBest regards,\\nConnectSphere Team`\r\n        : `Dear ${user.name},\\n\\nYour mentorship session with ${mentor.name} has been cancelled. No refund was processed due to missing payment details. Please contact support for assistance.\\nReason: ${reason}\\n\\nBest regards,\\nConnectSphere Team`;\r\n      await sendEmail(user.email, userSubject, userText);\r\n      logger.info(`Cancellation and refund email sent to user: ${user.email}`);\r\n\r\n      const mentorSubject = \"Mentorship Session Cancellation Notice\";\r\n      const mentorText = `Dear ${mentor.name},\\n\\nWe regret to inform you that your mentorship session with ${user.name} has been cancelled.\\nReason: ${reason}\\n\\nIf you have any questions, please contact support.\\n\\nBest regards,\\nConnectSphere Team`;\r\n      await sendEmail(mentor.email, mentorSubject, mentorText);\r\n      logger.info(`Cancellation email sent to mentor: ${mentor.email}`);\r\n\r\n      logger.info(\r\n        `Collaboration ${collabId} cancelled${\r\n          collab.paymentIntentId\r\n            ? ` with 50% refund of Rs. ${amount.toFixed(2)}`\r\n            : \"\"\r\n        }`\r\n      );\r\n      return updatedCollabDTO;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error cancelling collaboration ${collabId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to cancel and refund collaboration\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public getMentorRequestsService = async ({\r\n    page,\r\n    limit,\r\n    search,\r\n  }: {\r\n    page: number;\r\n    limit: number;\r\n    search: string;\r\n  }): Promise<{\r\n    requests: IMentorRequestDTO[];\r\n    total: number;\r\n    page: number;\r\n    pages: number;\r\n  }> => {\r\n    try {\r\n      logger.debug(\r\n        `Fetching mentor requests for admin with page: ${page}, limit: ${limit}, search: ${search}`\r\n      );\r\n      const result = await this._collabRepository.findMentorRequest({\r\n        page,\r\n        limit,\r\n        search,\r\n      });\r\n      logger.info(\r\n        `Fetched ${result.requests.length} mentor requests, total: ${result.total}`\r\n      );\r\n      return {\r\n        requests: toMentorRequestDTOs(result.requests),\r\n        total: result.total,\r\n        page: result.page,\r\n        pages: result.pages,\r\n      };\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error fetching mentor requests: ${err.message}`);\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to fetch mentor requests\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public getCollabsService = async ({\r\n    page,\r\n    limit,\r\n    search,\r\n  }: {\r\n    page: number;\r\n    limit: number;\r\n    search: string;\r\n  }): Promise<{\r\n    collabs: ICollaborationDTO[];\r\n    total: number;\r\n    page: number;\r\n    pages: number;\r\n  }> => {\r\n    try {\r\n      logger.debug(\r\n        `Fetching collaborations for admin with page: ${page}, limit: ${limit}, search: ${search}`\r\n      );\r\n      const {\r\n        collabs,\r\n        total,\r\n        page: currentPage,\r\n        pages,\r\n      } = await this._collabRepository.findCollab({\r\n        page,\r\n        limit,\r\n        search,\r\n      });\r\n      const updatedCollabs = await Promise.all(\r\n        collabs.map(async (collab) => {\r\n          return await this.checkAndCompleteCollaboration(collab);\r\n        })\r\n      );\r\n      const filteredCollabs = updatedCollabs.filter(\r\n        (collab): collab is ICollaborationDTO => collab !== null\r\n      );\r\n      logger.info(\r\n        `Fetched ${filteredCollabs.length} collaborations, total: ${total}`\r\n      );\r\n      return { collabs: filteredCollabs, total, page: currentPage, pages };\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error fetching collaborations: ${err.message}`);\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to fetch collaborations\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public fetchCollabById = async (\r\n    collabId: string\r\n  ): Promise<ICollaborationDTO | null> => {\r\n    try {\r\n      logger.debug(`Fetching collaboration by ID: ${collabId}`);\r\n      if (!Types.ObjectId.isValid(collabId)) {\r\n        throw new ServiceError(\r\n          \"Invalid collaboration ID: must be a 24 character hex string\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n      const collab = await this._collabRepository.findCollabById(collabId);\r\n      const collabDTO = toCollaborationDTO(collab);\r\n      if (!collabDTO && collab) {\r\n        logger.error(`Failed to map collaboration ${collab._id} to DTO`);\r\n        throw new ServiceError(\"Failed to map collaboration to DTO\", StatusCodes.INTERNAL_SERVER_ERROR);\r\n      }\r\n      logger.info(\r\n        `Collaboration ${\r\n          collab ? \"found\" : \"not found\"\r\n        } for collabId: ${collabId}`\r\n      );\r\n      return collabDTO;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error fetching collaboration ${collabId}: ${err.message}`);\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to fetch collaboration\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public fetchRequestById = async (\r\n    requestId: string\r\n  ): Promise<IMentorRequestDTO | null> => {\r\n    try {\r\n      logger.debug(`Fetching request by ID: ${requestId}`);\r\n      if (!Types.ObjectId.isValid(requestId)) {\r\n        throw new ServiceError(\r\n          \"Invalid request ID: must be a 24 character hex string\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n      const request = await this._collabRepository.fetchMentorRequestDetails(\r\n        requestId\r\n      );\r\n      const requestDTO = toMentorRequestDTO(request);\r\n      if (!requestDTO && request) {\r\n        logger.error(`Failed to map mentor request ${request._id} to DTO`);\r\n        throw new ServiceError(\"Failed to map mentor request to DTO\", StatusCodes.INTERNAL_SERVER_ERROR);\r\n      }\r\n      logger.info(\r\n        `Mentor request ${\r\n          request ? \"found\" : \"not found\"\r\n        } for requestId: ${requestId}`\r\n      );\r\n      return requestDTO;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error fetching request ${requestId}: ${err.message}`);\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to fetch mentor request\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public markUnavailableDaysService = async (\r\n    collabId: string,\r\n    updateData: {\r\n      datesAndReasons: { date: Date; reason: string }[];\r\n      requestedBy: \"user\" | \"mentor\";\r\n      requesterId: string;\r\n      approvedById: string;\r\n      isApproved: \"pending\" | \"approved\" | \"rejected\";\r\n    }\r\n  ): Promise<ICollaborationDTO | null> => {\r\n    try {\r\n      logger.debug(`Marking unavailable days for collaboration: ${collabId}`);\r\n      if (!Types.ObjectId.isValid(collabId)) {\r\n        throw new ServiceError(\r\n          \"Invalid collaboration ID: must be a 24 character hex string\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n      const collaboration = await this._collabRepository.updateUnavailableDays(\r\n        collabId,\r\n        updateData\r\n      );\r\n      const collaborationDTO = toCollaborationDTO(collaboration);\r\n      if (!collaborationDTO && collaboration) {\r\n        logger.error(`Failed to map collaboration ${collaboration._id} to DTO`);\r\n        throw new ServiceError(\"Failed to map collaboration to DTO\", StatusCodes.INTERNAL_SERVER_ERROR);\r\n      }\r\n      logger.info(`Updated unavailable days for collaboration ${collabId}`);\r\n      return collaborationDTO;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error marking unavailable days for collaboration ${collabId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to mark unavailable days\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public updateTemporarySlotChangesService = async (\r\n    collabId: string,\r\n    updateData: {\r\n      datesAndNewSlots: { date: Date; newTimeSlots: string[] }[];\r\n      requestedBy: \"user\" | \"mentor\";\r\n      requesterId: string;\r\n      approvedById: string;\r\n      isApproved: \"pending\" | \"approved\" | \"rejected\";\r\n    }\r\n  ): Promise<ICollaborationDTO | null> => {\r\n    try {\r\n      logger.debug(\r\n        `Updating temporary slot changes for collaboration: ${collabId}`\r\n      );\r\n      if (!Types.ObjectId.isValid(collabId)) {\r\n        throw new ServiceError(\r\n          \"Invalid collaboration ID: must be a 24 character hex string\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n      const collaboration = await this._collabRepository.updateTemporarySlotChanges(\r\n        collabId,\r\n        updateData\r\n      );\r\n      const collaborationDTO = toCollaborationDTO(collaboration);\r\n      if (!collaborationDTO && collaboration) {\r\n        logger.error(`Failed to map collaboration ${collaboration._id} to DTO`);\r\n        throw new ServiceError(\"Failed to map collaboration to DTO\", StatusCodes.INTERNAL_SERVER_ERROR);\r\n      }\r\n      logger.info(\r\n        `Updated temporary slot changes for collaboration ${collabId}`\r\n      );\r\n      return collaborationDTO;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error updating temporary slot changes for collaboration ${collabId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to update temporary slot changes\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public processTimeSlotRequest = async (\r\n    collabId: string,\r\n    requestId: string,\r\n    isApproved: boolean,\r\n    requestType: \"unavailable\" | \"timeSlot\"\r\n  ): Promise<ICollaborationDTO | null> => {\r\n    try {\r\n      logger.debug(\r\n        `Processing time slot request for collaboration: ${collabId}`\r\n      );\r\n      if (\r\n        !Types.ObjectId.isValid(collabId) ||\r\n        !Types.ObjectId.isValid(requestId)\r\n      ) {\r\n        throw new ServiceError(\r\n          \"Invalid collaboration ID or request ID: must be a 24 character hex string\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      const collaboration = await this._collabRepository.findCollabById(collabId);\r\n      if (!collaboration) {\r\n        throw new ServiceError(\r\n          \"Collaboration not found\",\r\n          StatusCodes.NOT_FOUND\r\n        );\r\n      }\r\n\r\n      let requestedBy: \"user\" | \"mentor\" | undefined;\r\n      if (requestType === \"unavailable\") {\r\n        const request = collaboration.unavailableDays.find(\r\n          (req) => req._id.toString() === requestId\r\n        );\r\n        if (!request) {\r\n          throw new ServiceError(\r\n            \"Unavailable days request not found\",\r\n            StatusCodes.NOT_FOUND\r\n          );\r\n        }\r\n        requestedBy = request.requestedBy;\r\n      } else {\r\n        const request = collaboration.temporarySlotChanges.find(\r\n          (req) => req._id.toString() === requestId\r\n        );\r\n        if (!request) {\r\n          throw new ServiceError(\r\n            \"Time slot change request not found\",\r\n            StatusCodes.NOT_FOUND\r\n          );\r\n        }\r\n        requestedBy = request.requestedBy;\r\n      }\r\n\r\n      if (!requestedBy) {\r\n        throw new ServiceError(\r\n          \"Unable to determine who requested the change\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      let newEndDate: Date | undefined;\r\n      if (requestType === \"unavailable\" && isApproved) {\r\n        const request = collaboration.unavailableDays.find(\r\n          (req) => req._id.toString() === requestId\r\n        );\r\n        if (request) {\r\n          const unavailableDates = request.datesAndReasons.map(\r\n            (item) => new Date(item.date)\r\n          );\r\n          const selectedDay = collaboration.selectedSlot[0]?.day;\r\n          if (!selectedDay) {\r\n            throw new ServiceError(\r\n              \"Selected slot day not found\",\r\n              StatusCodes.BAD_REQUEST\r\n            );\r\n          }\r\n          const currentEndDate =\r\n            collaboration.endDate || collaboration.startDate;\r\n          newEndDate = this.calculateNewEndDate(\r\n            currentEndDate,\r\n            unavailableDates,\r\n            selectedDay\r\n          );\r\n        }\r\n      }\r\n\r\n      const status = isApproved ? \"approved\" : \"rejected\";\r\n      const updatedCollaboration = await this._collabRepository.updateRequestStatus(\r\n        collabId,\r\n        requestId,\r\n        requestType,\r\n        status,\r\n        newEndDate\r\n      );\r\n\r\n      const updatedCollaborationDTO = toCollaborationDTO(updatedCollaboration);\r\n      if (!updatedCollaborationDTO && updatedCollaboration) {\r\n        logger.error(`Failed to map collaboration ${updatedCollaboration._id} to DTO`);\r\n        throw new ServiceError(\"Failed to map collaboration to DTO\", StatusCodes.INTERNAL_SERVER_ERROR);\r\n      }\r\n\r\n      if (status === \"rejected\") {\r\n        const user = collaboration.userId as Pick<IUser, \"name\" | \"email\">;\r\n        const mentor = (\r\n          collaboration.mentorId as { userId: Pick<IUser, \"name\" | \"email\"> }\r\n        ).userId;\r\n\r\n        if (!user.email || !mentor.email) {\r\n          throw new ServiceError(\r\n            \"User or mentor email not found\",\r\n            StatusCodes.NOT_FOUND\r\n          );\r\n        }\r\n\r\n        const recipientEmail =\r\n          requestedBy === \"user\" ? mentor.email : user.email;\r\n        const recipientName = requestedBy === \"user\" ? mentor.name : user.name;\r\n        const otherPartyName = requestedBy === \"user\" ? user.name : mentor.name;\r\n\r\n        const subject = \"Request Rejection Notice\";\r\n        const text = `Dear ${recipientName},\\n\\nWe regret to inform you that the request for ${\r\n          requestType === \"unavailable\"\r\n            ? \"unavailable days\"\r\n            : \"a time slot change\"\r\n        } in your mentorship session with ${otherPartyName} has been rejected.\\n\\nIf you have any questions, please contact support.\\n\\nBest regards,\\nConnectSphere Team`;\r\n        await sendEmail(recipientEmail, subject, text);\r\n        logger.info(\r\n          `Rejection email sent to ${\r\n            requestedBy === \"user\" ? \"mentor\" : \"user\"\r\n          }: ${recipientEmail}`\r\n        );\r\n      }\r\n\r\n      logger.info(\r\n        `Processed time slot request for collaboration ${collabId}: ${status}`\r\n      );\r\n      return updatedCollaborationDTO;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error processing time slot request for collaboration ${collabId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to process time slot request\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public getMentorLockedSlots = async (\r\n    mentorId: string\r\n  ): Promise<LockedSlot[]> => {\r\n    try {\r\n      logger.debug(`Fetching locked slots for mentor: ${mentorId}`);\r\n      if (!Types.ObjectId.isValid(mentorId)) {\r\n        throw new ServiceError(\r\n          \"Invalid mentor ID: must be a 24 character hex string\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n      const lockedSlots = await this._collabRepository.getLockedSlotsByMentorId(\r\n        mentorId\r\n      );\r\n      logger.info(\r\n        `Fetched ${lockedSlots.length} locked slots for mentorId: ${mentorId}`\r\n      );\r\n      return lockedSlots;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error fetching locked slots for mentor ${mentorId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to fetch locked slots\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public calculateNewEndDate = (\r\n    currentEndDate: Date,\r\n    unavailableDates: Date[],\r\n    selectedDay: string\r\n  ): Date => {\r\n    try {\r\n      const dayMap: { [key: string]: number } = {\r\n        Sunday: 0,\r\n        Monday: 1,\r\n        Tuesday: 2,\r\n        Wednesday: 3,\r\n        Thursday: 4,\r\n        Friday: 5,\r\n        Saturday: 6,\r\n      };\r\n      const selectedDayOfWeek = dayMap[selectedDay];\r\n      if (selectedDayOfWeek === undefined) {\r\n        throw new ServiceError(\"Invalid selected day\", StatusCodes.BAD_REQUEST);\r\n      }\r\n      const newEndDate = new Date(currentEndDate);\r\n      const daysToAdd = unavailableDates.length;\r\n\r\n      let currentDate = new Date(newEndDate);\r\n      let sessionsAdded = 0;\r\n\r\n      while (sessionsAdded < daysToAdd) {\r\n        currentDate.setDate(currentDate.getDate() + 1);\r\n        if (currentDate.getDay() === selectedDayOfWeek) {\r\n          sessionsAdded++;\r\n        }\r\n      }\r\n\r\n      return currentDate;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error calculating new end date: ${err.message}`);\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to calculate new end date\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public getReceiptData = async (\r\n    collabId: string\r\n  ): Promise<{\r\n    mentorUser: { name: string; email: string };\r\n    user: { name: string; email: string; _id: Types.ObjectId };\r\n    paymentIntent: Stripe.PaymentIntent;\r\n    collab: ICollaborationDTO;\r\n  }> => {\r\n    try {\r\n      logger.debug(`Fetching receipt data for collaboration: ${collabId}`);\r\n      if (!Types.ObjectId.isValid(collabId)) {\r\n        throw new ServiceError(\r\n          \"Invalid collaboration ID: must be a 24 character hex string\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      const collab = await this._collabRepository.findCollabById(collabId);\r\n      if (!collab || !collab.paymentIntentId) {\r\n        throw new ServiceError(\r\n          \"Collaboration or payment not found\",\r\n          StatusCodes.NOT_FOUND\r\n        );\r\n      }\r\n\r\n      const collabDTO = toCollaborationDTO(collab);\r\n      logger.debug(\"Collaboartion DTO Structure : \",collabDTO)\r\n      if (!collabDTO) {\r\n        logger.error(`Failed to map collaboration ${collab._id} to DTO`);\r\n        throw new ServiceError(\"Failed to map collaboration to DTO\", StatusCodes.INTERNAL_SERVER_ERROR);\r\n      }\r\n\r\n      const paymentIntent = await stripe.paymentIntents.retrieve(\r\n        collab.paymentIntentId\r\n      );\r\n      if (!paymentIntent) {\r\n        throw new ServiceError(\r\n          \"Payment intent not found\",\r\n          StatusCodes.NOT_FOUND\r\n        );\r\n      }\r\n      const mentorId = (collab.mentorId as IMentor)._id.toString();\r\n      const mentor = await this._mentorRepository.getMentorById(mentorId);\r\n      if (!mentor || !mentor.userId) {\r\n        throw new ServiceError(\r\n          \"Mentor or mentors userId not found\",\r\n          StatusCodes.NOT_FOUND\r\n        );\r\n      }\r\n      const mentorUser = mentor.userId as { name: string; email: string };\r\n\r\n      const userId = (collab.userId as IUser)._id.toString()\r\n      const user = await this._userRepository.findById(userId);\r\n      if (!user) {\r\n        throw new ServiceError(\"User not found\", StatusCodes.NOT_FOUND);\r\n      }\r\n\r\n      return { mentorUser, user, paymentIntent, collab: collabDTO };\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error fetching receipt data for collaboration ${collabId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to fetch receipt data\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public generateReceiptPDF = async (collabId: string): Promise<Buffer> => {\r\n    try {\r\n      logger.debug(`Generating PDF receipt for collaboration: ${collabId}`);\r\n      const { mentorUser, user, paymentIntent, collab } =\r\n        await this.getReceiptData(collabId);\r\n\r\n      return new Promise((resolve, reject) => {\r\n        const doc = new PDFDocument();\r\n        const buffers: Buffer[] = [];\r\n\r\n        doc.on(\"data\", buffers.push.bind(buffers));\r\n        doc.on(\"end\", () => {\r\n          const pdfBuffer = Buffer.concat(buffers);\r\n          resolve(pdfBuffer);\r\n        });\r\n        doc.on(\"error\", (error: Error) => {\r\n          logger.error(\r\n            `Error generating PDF for collabId ${collabId}: ${error.message}`\r\n          );\r\n          reject(\r\n            new ServiceError(\r\n              \"Failed to generate PDF\",\r\n              StatusCodes.INTERNAL_SERVER_ERROR,\r\n              error\r\n            )\r\n          );\r\n        });\r\n\r\n        doc.fontSize(20).text(\"Payment Receipt\", { align: \"center\" });\r\n        doc\r\n          .fontSize(14)\r\n          .text(\"ConnectSphere Mentorship Platform\", { align: \"center\" });\r\n        doc.fontSize(10).text(\r\n          `Issued on: ${new Date().toLocaleDateString(\"en-US\", {\r\n            year: \"numeric\",\r\n            month: \"long\",\r\n            day: \"numeric\",\r\n          })}`,\r\n          { align: \"center\" }\r\n        );\r\n        doc.moveDown(2);\r\n\r\n        doc.fontSize(12).text(\"Receipt Details\", { underline: true });\r\n        doc.moveDown(0.5);\r\n        doc\r\n          .fontSize(10)\r\n          .text(`Collaboration ID: ${collab.collaborationId || collab.id}`);\r\n        doc.text(`Mentor: ${mentorUser.name}`);\r\n        doc.text(`User: ${user.name}`);\r\n        doc.text(`Amount: INR ${collab.price.toFixed(2)}`);\r\n        doc.text(\r\n          `Payment Date: ${\r\n            paymentIntent.created\r\n              ? new Date(paymentIntent.created * 1000).toLocaleDateString(\r\n                  \"en-US\",\r\n                  {\r\n                    year: \"numeric\",\r\n                    month: \"long\",\r\n                    day: \"numeric\",\r\n                  }\r\n                )\r\n              : \"Unknown\"\r\n          }`\r\n        );\r\n        doc.text(`Payment ID: ${paymentIntent.id}`);\r\n        doc.text(\r\n          `Status: ${\r\n            paymentIntent.status.charAt(0).toUpperCase() +\r\n            paymentIntent.status.slice(1)\r\n          }`\r\n        );\r\n        doc.moveDown(2);\r\n\r\n        doc.fontSize(12).text(\"Description\", { underline: true });\r\n        doc.moveDown(0.5);\r\n        doc\r\n          .fontSize(10)\r\n          .text(\r\n            `Payment for mentorship session with ${mentorUser.name} from ` +\r\n              `${\r\n                collab.startDate\r\n                  ? new Date(collab.startDate).toLocaleDateString(\"en-US\", {\r\n                      year: \"numeric\",\r\n                      month: \"long\",\r\n                      day: \"numeric\",\r\n                    })\r\n                  : \"Not specified\"\r\n              } to ` +\r\n              `${\r\n                collab.endDate\r\n                  ? new Date(collab.endDate).toLocaleDateString(\"en-US\", {\r\n                      year: \"numeric\",\r\n                      month: \"long\",\r\n                      day: \"numeric\",\r\n                    })\r\n                  : \"Not specified\"\r\n              }`\r\n          );\r\n        doc.moveDown(2);\r\n\r\n        doc.fontSize(12).text(\"Contact Information\", { underline: true });\r\n        doc.moveDown(0.5);\r\n        doc\r\n          .fontSize(10)\r\n          .text(\r\n            \"For any inquiries, please contact ConnectSphere support at support@connectsphere.com.\"\r\n          );\r\n\r\n        doc.end();\r\n      });\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error generating PDF receipt for collaboration ${collabId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to generate PDF receipt\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  }\r\n\r\n  public deleteMentorRequestService = async (requestId: string): Promise<void> => {\r\n  try {\r\n    logger.debug(`Deleting mentor request in service: ${requestId}`);\r\n\r\n    if (!Types.ObjectId.isValid(requestId)) {\r\n      throw new ServiceError(\r\n        \"Invalid request ID: must be a 24 character hex string\",\r\n        StatusCodes.BAD_REQUEST\r\n      );\r\n    }\r\n\r\n    await this._collabRepository.deleteMentorRequest(requestId);\r\n    logger.info(`Mentor request deleted: ${requestId}`);\r\n  } catch (error: unknown) {\r\n    const err = error instanceof Error ? error : new Error(String(error));\r\n    logger.error(`Error deleting mentor request ${requestId}: ${err.message}`);\r\n    throw error instanceof ServiceError\r\n      ? error\r\n      : new ServiceError(\r\n          \"Failed to delete mentor request\",\r\n          StatusCodes.INTERNAL_SERVER_ERROR,\r\n          err\r\n        );\r\n  }\r\n};\r\n}\r\n"]}