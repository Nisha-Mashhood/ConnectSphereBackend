{"version":3,"file":"contact-service.js","sourceRoot":"","sources":["../../src/services/contact-service.ts"],"names":[],"mappings":"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","sourcesContent":["import { inject, injectable } from \"inversify\";\r\nimport logger from \"../core/utils/logger\";\r\nimport {\r\n  FormattedContact,\r\n  PopulatedContact,\r\n} from \"../Utils/types/contact-types\";\r\nimport { ServiceError } from \"../core/utils/error-handler\";\r\nimport { StatusCodes } from \"../enums/status-code-enums\";\r\nimport { IContactService } from \"../Interfaces/Services/i-contact-service\";\r\nimport { IContactRepository } from \"../Interfaces/Repository/i-contact-repositry\";\r\n\r\n@injectable()\r\nexport class ContactService implements IContactService{\r\n  private _contactRepository: IContactRepository;\r\n\r\n  constructor(@inject('IContactRepository') contactRepository : IContactRepository) {\r\n    this._contactRepository = contactRepository;\r\n  }\r\n\r\n  public getUserContacts = async (userId?: string): Promise<FormattedContact[]> => {\r\n    try {\r\n      if (!userId) {\r\n        logger.error(\"User ID not provided\");\r\n        throw new ServiceError(\"User ID not provided\", StatusCodes.BAD_REQUEST);\r\n      }\r\n      logger.debug(`Fetching contacts for user: ${userId}`);\r\n      const contacts = await this._contactRepository.findContactsByUserId(userId);\r\n      const formattedContacts = contacts.map(\r\n        (contact: PopulatedContact): FormattedContact => {\r\n          let targetId = \"\";\r\n          let targetName = \"Unknown\";\r\n          let targetProfilePic = \"\";\r\n          let targetJobTitle: string | undefined;\r\n          let collaborationId: string | undefined;\r\n          let collaborationDetails: FormattedContact[\"collaborationDetails\"];\r\n          let userConnectionId: string | undefined;\r\n          let connectionDetails: FormattedContact[\"connectionDetails\"];\r\n          let groupId: string | undefined;\r\n          let groupDetails: FormattedContact[\"groupDetails\"];\r\n\r\n          const contactUserId = contact.userId._id.toString();\r\n          const contactTargetId = contact.targetUserId?._id.toString();\r\n\r\n          if (contact.type === \"user-mentor\" && contact.collaborationId) {\r\n            if (contactUserId === userId && contactTargetId) {\r\n              targetId = contactTargetId;\r\n              targetName = contact.targetUserId?.name || \"Unknown\";\r\n              targetProfilePic = contact.targetUserId?.profilePic || \"\";\r\n              targetJobTitle = contact.targetUserId?.jobTitle;\r\n            } else if (contactTargetId === userId && contactUserId) {\r\n              targetId = contactUserId;\r\n              targetName = contact.userId?.name || \"Unknown\";\r\n              targetProfilePic = contact.userId?.profilePic || \"\";\r\n              targetJobTitle = contact.userId?.jobTitle;\r\n            }\r\n            collaborationId = contact.collaborationId._id.toString();\r\n            collaborationDetails = {\r\n              startDate: contact.collaborationId.startDate,\r\n              endDate: contact.collaborationId.endDate,\r\n              price: contact.collaborationId.price,\r\n              selectedSlot: contact.collaborationId.selectedSlot,\r\n              mentorName:\r\n                contact.collaborationId.mentorId.userId.name || \"Unknown\",\r\n              mentorProfilePic:\r\n                contact.collaborationId.mentorId.userId.profilePic || \"\",\r\n              mentorJobTitle: contact.collaborationId.mentorId.userId.jobTitle,\r\n              userName: contact.collaborationId.userId.name || \"Unknown\",\r\n              userProfilePic: contact.collaborationId.userId.profilePic || \"\",\r\n              userJobTitle: contact.collaborationId.userId.jobTitle,\r\n            };\r\n          } else if (contact.type === \"user-user\" && contact.userConnectionId) {\r\n            const connection = contact.userConnectionId;\r\n            const otherUser =\r\n              connection.requester._id.toString() === userId\r\n                ? connection.recipient\r\n                : connection.requester;\r\n            targetId = otherUser._id.toString();\r\n            targetName = otherUser.name || \"Unknown\";\r\n            targetProfilePic = otherUser.profilePic || \"\";\r\n            targetJobTitle = otherUser.jobTitle;\r\n            userConnectionId = connection._id.toString();\r\n            connectionDetails = {\r\n              requestAcceptedAt: connection.requestAcceptedAt,\r\n              requesterName: connection.requester.name || \"Unknown\",\r\n              requesterProfilePic: connection.requester.profilePic || \"\",\r\n              requesterJobTitle: connection.requester.jobTitle,\r\n              recipientName: connection.recipient.name || \"Unknown\",\r\n              recipientProfilePic: connection.recipient.profilePic || \"\",\r\n              recipientJobTitle: connection.recipient.jobTitle,\r\n            };\r\n          } else if (contact.type === \"group\" && contact.groupId) {\r\n            const group = contact.groupId;\r\n            targetId = group._id.toString();\r\n            targetName = group.name || \"Unknown\";\r\n            targetProfilePic = group.profilePic || \"\";\r\n            groupId = group._id.toString();\r\n            groupDetails = {\r\n              groupName: group.name || \"Unknown Group\",\r\n              startDate: group.startDate,\r\n              adminName: group.adminId?.name || \"Unknown\",\r\n              adminProfilePic: group.adminId?.profilePic || \"\",\r\n              bio: group.bio || \"No Bio\",\r\n              price: group.price,\r\n              maxMembers: group.maxMembers,\r\n              availableSlots: group.availableSlots,\r\n              members: group.members.map((member) => ({\r\n                userId: member.userId._id.toString(),\r\n                name: member.userId.name || \"Unknown\",\r\n                profilePic: member.userId.profilePic || \"\",\r\n                joinedAt: member.joinedAt,\r\n              })),\r\n            };\r\n          }\r\n\r\n          return {\r\n            _id: contact._id.toString(),\r\n            contactId: contact.contactId,\r\n            userId: contactUserId,\r\n            targetId,\r\n            type: contact.type,\r\n            targetName,\r\n            targetProfilePic,\r\n            targetJobTitle,\r\n            collaborationId,\r\n            collaborationDetails,\r\n            userConnectionId,\r\n            connectionDetails,\r\n            groupId,\r\n            groupDetails,\r\n          };\r\n        }\r\n      );\r\n\r\n      const validContacts = formattedContacts.filter(\r\n        (contact) =>\r\n          contact.userId === userId &&\r\n          contact.userId !== contact.targetId &&\r\n          contact.targetId !== \"\"\r\n      );\r\n\r\n      logger.info(\r\n        `Retrieved ${validContacts.length} valid contacts for user: ${userId}`\r\n      );\r\n      return validContacts;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error fetching contacts for user ${userId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to fetch user contacts\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n}\r\n"]}