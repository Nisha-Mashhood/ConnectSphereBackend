{"version":3,"file":"contact-us-service.js","sourceRoot":"","sources":["../../src/services/contact-us-service.ts"],"names":[],"mappings":"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","sourcesContent":["import { inject, injectable } from \"inversify\";\r\nimport { Types } from \"mongoose\";\r\nimport config from \"../config/env-config\";\r\nimport { StatusCodes } from \"../enums/status-code-enums\";\r\nimport { sendEmail } from \"../core/utils/email\";\r\nimport logger from \"../core/utils/logger\";\r\nimport { ServiceError } from \"../core/utils/error-handler\";\r\nimport { IContactMessageService } from \"../Interfaces/Services/i-contact-message-service\";\r\nimport { IContactMessageRepository } from \"../Interfaces/Repository/i-contact-message-repositry\";\r\nimport { IContactMessageDTO } from \"../Interfaces/DTOs/i-contact-message-dto\";\r\nimport { toContactMessageDTO, toContactMessageDTOs } from \"../Utils/mappers/contact-message-mapper\";\r\n\r\n@injectable()\r\nexport class ContactMessageService implements IContactMessageService{\r\n  private contactMessageRepo: IContactMessageRepository;\r\n\r\n  constructor(@inject('IContactMessageRepository') contactMessageRepository : IContactMessageRepository) {\r\n    this.contactMessageRepo = contactMessageRepository;\r\n  }\r\n\r\n  public createContactMessage = async (data: {\r\n    name: string;\r\n    email: string;\r\n    message: string;\r\n  }): Promise<IContactMessageDTO> => {\r\n    try {\r\n      logger.debug(`Creating contact message from: ${data.email}`);\r\n\r\n      if (!data.name || !data.email || !data.message) {\r\n        logger.error(\"Missing required fields: name, email, or message\");\r\n        throw new ServiceError(\r\n          \"Name, email, and message are required\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      const ReceiverEmail = config.adminEmail;\r\n      if (!ReceiverEmail) {\r\n        logger.error(\"Receiver email not configured\");\r\n        throw new ServiceError(\r\n          \"Receiver email required\",\r\n          StatusCodes.INTERNAL_SERVER_ERROR\r\n        );\r\n      }\r\n\r\n      const contactMessage = await this.contactMessageRepo.createContactMessage(\r\n        data\r\n      );\r\n      const contactMessageDTO = toContactMessageDTO(contactMessage);\r\n      if (!contactMessageDTO) {\r\n        logger.error(`Failed to map contact message ${contactMessage._id} to DTO`);\r\n        throw new ServiceError(\r\n          \"Failed to map contact message to DTO\",\r\n          StatusCodes.INTERNAL_SERVER_ERROR\r\n        );\r\n      }\r\n\r\n      const emailText = `New Contact Message\\n\\nName: ${data.name}\\nEmail: ${\r\n        data.email\r\n      }\\nMessage: ${data.message}\\n\\nSent at: ${new Date().toLocaleString()}`;\r\n      await sendEmail(\r\n        ReceiverEmail,\r\n        \"New Contact Message from ConnectSphere\",\r\n        emailText\r\n      );\r\n      logger.info(`Email sent to admin: ${ReceiverEmail}`);\r\n\r\n      logger.info(`Contact message created: ${contactMessage._id}`);\r\n      return contactMessageDTO;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error processing contact message from ${data.email}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to process contact message\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public getAllContactMessages = async ({\r\n  page = 1,\r\n  limit = 10,\r\n  search = \"\",\r\n  dateFilter = \"all\",\r\n}: {\r\n  page?: number;\r\n  limit?: number;\r\n  search?: string;\r\n  dateFilter?: \"today\" | \"7days\" | \"30days\" | \"all\";\r\n}): Promise<{\r\n  messages: IContactMessageDTO[];\r\n  total: number;\r\n  page: number;\r\n  pages: number;\r\n}> => {\r\n  try {\r\n    logger.debug(\r\n      `Service: Fetching contact messages with pagination/search/filter`\r\n    );\r\n\r\n    const { messages, total, page: currentPage, pages } =\r\n      await this.contactMessageRepo.getAllContactMessages({\r\n        page,\r\n        limit,\r\n        search,\r\n        dateFilter,\r\n      });\r\n\r\n    const messagesDTO = toContactMessageDTOs(messages);\r\n\r\n    return {\r\n      messages: messagesDTO,\r\n      total,\r\n      page: currentPage,\r\n      pages,\r\n    };\r\n  } catch (error: unknown) {\r\n    const err = error instanceof Error ? error : new Error(String(error));\r\n\r\n    logger.error(`Error fetching contact messages: ${err.message}`);\r\n\r\n    throw new ServiceError(\r\n      \"Failed to fetch contact messages\",\r\n      StatusCodes.INTERNAL_SERVER_ERROR,\r\n      err\r\n    );\r\n  }\r\n};\r\n\r\n  public sendReply = async (\r\n    contactMessageId: string,\r\n    replyData: { email: string; replyMessage: string }\r\n  ): Promise<IContactMessageDTO> => {\r\n    try {\r\n      logger.debug(`Sending reply for contact message: ${contactMessageId}`);\r\n\r\n      if (!Types.ObjectId.isValid(contactMessageId)) {\r\n        logger.error(\"Invalid contact message ID\");\r\n        throw new ServiceError(\r\n          \"Invalid contact message ID: must be a 24 character hex string\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      if (!replyData.email || !replyData.replyMessage) {\r\n        logger.error(\"Missing required fields: email or reply message\");\r\n        throw new ServiceError(\r\n          \"Email and reply message are required\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      const updatedMessage = await this.contactMessageRepo.updateReplyStatus(\r\n        contactMessageId\r\n      );\r\n      if (!updatedMessage) {\r\n        logger.error(`Contact message not found: ${contactMessageId}`);\r\n        throw new ServiceError(\r\n          \"Contact message not found\",\r\n          StatusCodes.NOT_FOUND\r\n        );\r\n      }\r\n\r\n      const updatedMessageDTO = toContactMessageDTO(updatedMessage);\r\n      if (!updatedMessageDTO) {\r\n        logger.error(`Failed to map contact message ${updatedMessage._id} to DTO`);\r\n        throw new ServiceError(\r\n          \"Failed to map contact message to DTO\",\r\n          StatusCodes.INTERNAL_SERVER_ERROR\r\n        );\r\n      }\r\n\r\n      await sendEmail(\r\n        replyData.email,\r\n        \"Reply from ConnectSphere\",\r\n        `Hello ${updatedMessage.name},\\n\\n${replyData.replyMessage}\\n\\nBest regards,\\nConnectSphere Team`\r\n      );\r\n      logger.info(`Reply email sent to: ${replyData.email}`);\r\n\r\n      logger.info(`Reply sent for contact message: ${contactMessageId}`);\r\n      return updatedMessageDTO;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error sending reply for contact message ${contactMessageId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to send reply\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n}\r\n"]}