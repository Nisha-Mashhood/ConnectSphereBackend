{"version":3,"file":"notification-service.js","sourceRoot":"","sources":["../../src/services/notification-service.ts"],"names":[],"mappings":"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","sourcesContent":["import { inject, injectable } from \"inversify\";\r\nimport { Types } from \"mongoose\";\r\nimport { ServiceError } from \"../core/utils/error-handler\";\r\nimport logger from \"../core/utils/logger\";\r\nimport { IAppNotification } from \"../Interfaces/Models/i-app-notification\";\r\nimport { ITask } from \"../Interfaces/Models/i-task\";\r\nimport { Server } from \"socket.io\";\r\nimport { SocketService } from \"../socket/socket-service\";\r\nimport { convertTo24HourFormat } from \"../Utils/utils/notification-utils/helper\";\r\nimport { INotificationService } from \"../Interfaces/Services/i-notification-service\";\r\nimport { TaskNotificationPayload } from \"../Utils/types/notification-types\";\r\nimport { StatusCodes } from \"../enums/status-code-enums\";\r\nimport { INotificationRepository } from \"../Interfaces/Repository/i-notification-repositry\";\r\nimport { IUserRepository } from \"../Interfaces/Repository/i-user-repositry\";\r\nimport { IGroupRepository } from \"../Interfaces/Repository/i-group-repositry\";\r\nimport { ICollaborationRepository } from \"../Interfaces/Repository/i-collaboration-repositry\";\r\nimport { IAppNotificationDTO } from \"../Interfaces/DTOs/i-app-notification-dto\";\r\nimport { toNotificationDTO, toNotificationDTOs } from \"../Utils/mappers/notification-mapper\";\r\n\r\nlet io: Server | null = null;\r\n\r\n@injectable()\r\nexport class NotificationService  implements INotificationService{\r\n  private _notificationRepository: INotificationRepository;\r\n  private _groupRepository: IGroupRepository;\r\n  private _userRepository: IUserRepository;\r\n  private _collaborationRepository: ICollaborationRepository;\r\n  private intervalId: NodeJS.Timeout | null = null;\r\n\r\n  constructor(\r\n    @inject('INotificationRepository') notificationRepository : INotificationRepository,\r\n    @inject('IGroupRepository') groupRepository : IGroupRepository,\r\n    @inject('IUserRepository') userRepository : IUserRepository,\r\n    @inject('ICollaborationRepository') collaborationRepository : ICollaborationRepository,\r\n  ) {\r\n    this._notificationRepository = notificationRepository;\r\n    this._groupRepository = groupRepository;\r\n    this._userRepository = userRepository;\r\n    this._collaborationRepository = collaborationRepository;\r\n  }\r\n\r\n  initializeSocket(_io: Server) {\r\n    io = _io;\r\n    logger.info(\"Notification service initialized with Socket.IO\");\r\n    this.startNotificationInterval();\r\n  }\r\n\r\n  private startNotificationInterval() {\r\n    if (this.intervalId) {\r\n      clearInterval(this.intervalId); \r\n      logger.info(\"Cleared existing notification interval\");\r\n    }\r\n    this.intervalId = setInterval(async () => {\r\n      try {\r\n        const notifications = await this.checkAndSendNotifications();\r\n        logger.info(`Generated ${notifications.length} notifications`);\r\n      } catch (error: any) {\r\n        logger.error(`Error in periodic notification check: ${error.message}`);\r\n      }\r\n    }, 60 * 1000); // 1 minute\r\n  }\r\n\r\n  stopNotificationInterval() {\r\n    if (this.intervalId) {\r\n      clearInterval(this.intervalId);\r\n      this.intervalId = null;\r\n      logger.info(\"Notification interval stopped\");\r\n    }\r\n  }\r\n\r\n  sendTaskNotification = async (\r\n    taskId: string,\r\n    specificUserId?: string,\r\n    notificationDate?: string,\r\n    notificationTime?: string\r\n  ): Promise<TaskNotificationPayload[]> => {\r\n    try {\r\n      logger.debug(`Sending task notification for task: ${taskId}`);\r\n      const notifications: TaskNotificationPayload[] = [];\r\n      const task: ITask | null =\r\n        await this._notificationRepository.getTasksForNotification(taskId);\r\n      if (!task) {\r\n        logger.warn(`No task found for ID ${taskId}`);\r\n        return notifications;\r\n      }\r\n      logger.info(`Task Found For Notification : ${task}`);\r\n\r\n      const currentTime = new Date();\r\n      if (task.status === \"completed\") {\r\n        logger.info(`Skipping task ${task.taskId}: Task completed`);\r\n        return notifications;\r\n      }\r\n      if (new Date(task.dueDate) < currentTime) {\r\n        logger.info(\r\n          `Skipping task ${task.taskId}: Due date passed (${task.dueDate})`\r\n        );\r\n        return notifications;\r\n      }\r\n\r\n      let isTimeToNotify = false;\r\n      if (task.notificationDate && task.notificationTime) {\r\n        const taskNotificationDate = new Date(task.notificationDate);\r\n        const isSameDay =\r\n          currentTime.getDate() === taskNotificationDate.getDate() &&\r\n          currentTime.getMonth() === taskNotificationDate.getMonth() &&\r\n          currentTime.getFullYear() === taskNotificationDate.getFullYear();\r\n\r\n        if (isSameDay) {\r\n          const time24 = convertTo24HourFormat(task.notificationTime);\r\n          if (time24) {\r\n            const taskNotificationTime = new Date(currentTime);\r\n            taskNotificationTime.setHours(time24.hours, time24.minutes, 0, 0);\r\n            const timeDiff = Math.abs(\r\n              currentTime.getTime() - taskNotificationTime.getTime()\r\n            );\r\n            isTimeToNotify = timeDiff <= 60 * 1000; // Â±1 minute window\r\n          }\r\n        }\r\n      } else {\r\n        logger.warn(\r\n          `Task ${task.taskId} missing notificationDate or notificationTime`\r\n        );\r\n        return notifications;\r\n      }\r\n\r\n      if (!isTimeToNotify) {\r\n        logger.info(`Skipping task ${task.taskId}: Not time to notify`);\r\n        return notifications;\r\n      }\r\n\r\n      let recipients: string[] = [];\r\n      if (specificUserId) {\r\n        recipients = [specificUserId];\r\n      } else if (task.contextType === \"collaboration\") {\r\n        const collaborationIds =\r\n          await this._collaborationRepository.getMentorIdAndUserId(\r\n            task.contextId.toString()\r\n          );\r\n        if (collaborationIds) {\r\n          recipients = [\r\n            collaborationIds.userId,\r\n            collaborationIds.mentorUserId,\r\n          ].filter((id): id is string => id !== null);\r\n        }\r\n      } else if (task.contextType === \"group\") {\r\n        const groupMembers = await this._groupRepository.getGroupMembers(\r\n          task.contextId.toString()\r\n        );\r\n        recipients = groupMembers.map((member) => member.toString());\r\n      } else if (task.contextType === \"user\") {\r\n        recipients = [\r\n          task.createdBy.toString(),\r\n          ...task.assignedUsers.map((id) => id.toString()),\r\n        ];\r\n        recipients = [...new Set(recipients)];\r\n      }\r\n\r\n      logger.debug(\r\n        `Recipients for task ${task._id}: ${JSON.stringify(recipients)}`\r\n      );\r\n      if (recipients.length === 0) {\r\n        logger.warn(`No recipients for task ${task.taskId}`);\r\n        return notifications;\r\n      }\r\n\r\n      const assigner = await this._userRepository.findById(task.createdBy.toString());\r\n      const assignerName = assigner?.name || \"Unknown\";\r\n\r\n      for (const userId of recipients) {\r\n        let isConnected = false;\r\n        if (io) {\r\n          const room = `user_${userId}`;\r\n          const socketsInRoom = await io.in(room).allSockets();\r\n          isConnected = socketsInRoom.size > 0;\r\n          logger.debug(\r\n            `User ${userId} connected for task ${task.taskId}: ${isConnected}`\r\n          );\r\n        }\r\n\r\n        let notification = await this._notificationRepository.findTaskNotification(\r\n          userId,\r\n          task._id.toString(),\r\n          notificationDate,\r\n          notificationTime\r\n        );\r\n\r\n        if (notification && notification.status === \"read\") {\r\n          notification = await this._notificationRepository.updateNotificationStatus(\r\n            notification._id.toString(),\r\n            \"unread\"\r\n          );\r\n        }\r\n\r\n        if (!notification) {\r\n          const isAssigner = userId === task.createdBy.toString();\r\n          const content = isAssigner\r\n            ? `Reminder: Your task \"${task.name}\" is due soon`\r\n            : `Reminder: Task \"${task.name}\" assigned by ${assignerName} is due soon`;\r\n\r\n          const notificationData: Partial<IAppNotification> = {\r\n            userId,\r\n            type: \"task_reminder\",\r\n            content,\r\n            relatedId: task._id.toString(),\r\n            senderId: task.createdBy,\r\n            status: \"unread\",\r\n            notificationDate: notificationDate\r\n              ? new Date(notificationDate)\r\n              : undefined,\r\n            notificationTime,\r\n            taskContext: {\r\n              contextType: task.contextType,\r\n              contextId: task.contextId.toString(),\r\n            },\r\n          };\r\n\r\n          notification = await this._notificationRepository.createNotification(\r\n            notificationData\r\n          );\r\n          if (!notification) {\r\n            logger.warn(\r\n              `Failed to create notification for user ${userId} on task ${taskId}`\r\n            );\r\n            continue;\r\n          }\r\n        }\r\n\r\n        const payload: TaskNotificationPayload = {\r\n          _id: notification._id.toString(),\r\n          userId: notification.userId.toString(),\r\n          type: notification.type,\r\n          content: notification.content,\r\n          relatedId: notification.relatedId,\r\n          senderId: notification.senderId.toString(),\r\n          status: notification.status,\r\n          callId: notification.callId,\r\n          notificationDate: notification.notificationDate\r\n            ?.toISOString()\r\n            .split(\"T\")[0],\r\n          notificationTime: notification.notificationTime,\r\n          createdAt: notification.createdAt,\r\n          updatedAt: notification.updatedAt,\r\n          taskContext: notification.taskContext,\r\n        };\r\n\r\n        notifications.push(payload);\r\n        if (isConnected && io) {\r\n          SocketService.notificationEmitter.emit(\"notification\", payload);\r\n          logger.info(\r\n            `Emitted notification ${notification._id} to user ${userId} for task ${task.taskId}`\r\n          );\r\n        } else {\r\n          logger.info(\r\n            `Stored notification ${notification._id} for offline user ${userId} on task ${task.taskId}`\r\n          );\r\n        }\r\n      }\r\n      return notifications;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error sending task notification for task ${taskId}: ${err.message}`);\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to send task notification\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          )\r\n    }\r\n  };\r\n\r\n  checkAndSendNotifications = async (): Promise<TaskNotificationPayload[]> => {\r\n    try {\r\n      logger.debug(\"Checking and sending notifications\");\r\n      const allNotifications: TaskNotificationPayload[] = [];\r\n      const tasks: ITask[] =\r\n        await this._notificationRepository.getAllTasksForNotification();\r\n      const currentTime = new Date();\r\n\r\n      for (const task of tasks) {\r\n        if (\r\n          !task.notificationDate ||\r\n          !task.notificationTime ||\r\n          task.status === \"completed\" ||\r\n          new Date(task.dueDate) < currentTime\r\n        ) {\r\n          continue;\r\n        }\r\n        const notifications = await this.sendTaskNotification(\r\n          task._id.toString(),\r\n          undefined,\r\n          task.notificationDate.toISOString().split(\"T\")[0],\r\n          task.notificationTime\r\n        );\r\n        allNotifications.push(...notifications);\r\n      }\r\n\r\n      return allNotifications;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error checking and sending notifications: ${err.message}`);\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to check and send notifications\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          )\r\n    }\r\n  };\r\n\r\n  sendNotification = async (\r\n    userId: string,\r\n    notificationType: IAppNotification[\"type\"],\r\n    senderId: string,\r\n    relatedId: string,\r\n    contentType?: string,\r\n    callId?: string,\r\n    callType?: IAppNotification[\"callType\"],\r\n    customContent?: string\r\n  ): Promise<IAppNotificationDTO> => {\r\n    try {\r\n      logger.debug(\r\n        `Sending notification to user: ${userId}, type: ${notificationType}`\r\n      );\r\n      if (!Types.ObjectId.isValid(userId) || !Types.ObjectId.isValid(senderId) || !Types.ObjectId.isValid(relatedId)) {\r\n        logger.error(\"Invalid user ID, sender ID, or related ID\");\r\n        throw new ServiceError(\r\n          \"User ID, sender ID, and related ID must be valid ObjectIds\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      const validTypes: IAppNotification[\"type\"][] = [\r\n        \"message\",\r\n        \"incoming_call\",\r\n        \"missed_call\",\r\n        \"task_reminder\",\r\n        \"new_user\",\r\n        \"new_mentor\",\r\n        \"mentor_approved\",\r\n        \"collaboration_status\",\r\n      ];\r\n      if (!validTypes.includes(notificationType)) {\r\n        logger.error(`Invalid notification type: ${notificationType}`);\r\n        throw new ServiceError(\r\n          `Notification type must be one of: ${validTypes.join(\", \")}`,\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      if (contentType) {\r\n        const validContextTypes = [\"user\", \"group\", \"collaboration\", \"userconnection\"];\r\n        if (!validContextTypes.includes(contentType)) {\r\n          logger.error(`Invalid content type: ${contentType}`);\r\n          throw new ServiceError(\r\n            `Content type must be one of: ${validContextTypes.join(\", \")}`,\r\n            StatusCodes.BAD_REQUEST\r\n          );\r\n        }\r\n      }\r\n\r\n      if (callType) {\r\n        const validCallTypes: IAppNotification[\"callType\"][] = [\"audio\", \"video\"];\r\n        if (!validCallTypes.includes(callType)) {\r\n          logger.error(`Invalid call type: ${callType}`);\r\n          throw new ServiceError(\r\n            `Call type must be one of: ${validCallTypes.join(\", \")}`,\r\n            StatusCodes.BAD_REQUEST\r\n          );\r\n        }\r\n      }\r\n\r\n      const sender = await this._userRepository.findById(senderId);\r\n      if (!sender) {\r\n        logger.warn(`Sender not found: ${senderId}`);\r\n        throw new ServiceError(\"Sender not found\", StatusCodes.NOT_FOUND);\r\n      }\r\n      let content: string;\r\n\r\n      // Use customContent if provided, otherwise generate default content\r\n      if (customContent) {\r\n        content = customContent;\r\n      } else if (notificationType === \"message\") {\r\n        content = `New ${contentType || \"text\"} message from ${\r\n          sender?.name || senderId\r\n        }`;\r\n      } else if (notificationType === \"incoming_call\") {\r\n        content = `Incoming ${contentType || \"call\"} call from ${\r\n          sender?.name || senderId\r\n        }`;\r\n      } else if (notificationType === \"missed_call\") {\r\n        content = `Missed ${contentType || \"call\"} call from ${\r\n          sender?.name || senderId\r\n        }`;\r\n      } else if (notificationType === \"new_user\") {\r\n        content = `New user registered: ${sender?.email || senderId}`;\r\n      } else if (notificationType === \"new_mentor\") {\r\n        content = `New mentor registered: ${sender?.email || senderId}`;\r\n      } else if (notificationType === \"mentor_approved\") {\r\n        content = `Mentor approval status updated for ${\r\n          sender?.email || senderId\r\n        }`;\r\n      } else if (notificationType === \"collaboration_status\") {\r\n        content = `Collaboration status updated with ${\r\n          sender?.name || senderId\r\n        }`;\r\n      } else {\r\n        const task = await this._notificationRepository.getTasksForNotification(\r\n          relatedId\r\n        );\r\n        if (!task) {\r\n          content = `Task reminder from ${sender?.name || senderId}`;\r\n        } else {\r\n          const isAssigner = userId === senderId;\r\n          content = isAssigner\r\n            ? `Reminder: Your task \"${task.name}\" is due soon`\r\n            : `Reminder: Task \"${task.name}\" assigned by ${\r\n                sender?.name || senderId\r\n              } is due soon`;\r\n        }\r\n      }\r\n\r\n      const notificationData: Partial<IAppNotification> = {\r\n        userId,\r\n        type: notificationType,\r\n        content,\r\n        relatedId,\r\n        senderId,\r\n        status: \"unread\",\r\n        callId,\r\n        callType,\r\n        taskContext: contentType\r\n          ? {\r\n              contextType: contentType as\r\n                | \"user\"\r\n                | \"group\"\r\n                | \"collaboration\"\r\n                | \"userconnection\",\r\n              contextId: relatedId,\r\n            }\r\n          : undefined,\r\n      };\r\n\r\n      const notification = await this._notificationRepository.createNotification(\r\n        notificationData\r\n      );\r\n      if (!notification) {\r\n        logger.error(`Failed to create notification for user ${userId}`);\r\n        throw new ServiceError(\"Failed to create notification\", StatusCodes.INTERNAL_SERVER_ERROR);\r\n      }\r\n\r\n      const notificationDTO = toNotificationDTO(notification);\r\n      if (!notificationDTO) {\r\n        logger.error(`Failed to map notification ${notification._id} to DTO`);\r\n        throw new ServiceError(\"Failed to map notification to DTO\", StatusCodes.INTERNAL_SERVER_ERROR);\r\n      }\r\n\r\n      if (io) {\r\n        const socketsInRoom = await io.in(`user_${userId}`).allSockets();\r\n        if (socketsInRoom.size > 0) {\r\n          const payload: TaskNotificationPayload = {\r\n            _id: notificationDTO.id,\r\n            userId: notificationDTO.userId,\r\n            type: notificationDTO.type,\r\n            content: notificationDTO.content,\r\n            relatedId: notificationDTO.relatedId,\r\n            senderId: notificationDTO.senderId,\r\n            status: notificationDTO.status,\r\n            callId: notificationDTO.callId,\r\n            callType: notificationDTO.callType,\r\n            notificationDate: notificationDTO.notificationDate,\r\n            notificationTime: notificationDTO.notificationTime,\r\n            createdAt: notificationDTO.createdAt,\r\n            updatedAt: notificationDTO.updatedAt,\r\n            taskContext: notificationDTO.taskContext,\r\n          };\r\n          SocketService.notificationEmitter.emit(\"notification\", payload);\r\n          logger.info(`Emitted notification ${notification._id} to user ${userId}`);\r\n        } else {\r\n          logger.info(`User ${userId} not connected, stored notification ${notification._id}`);\r\n        }\r\n      }\r\n\r\n      return notificationDTO;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error sending notification to user ${userId}: ${err.message}`);\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to send notification\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  updateCallNotificationToMissed = async (\r\n    userId: string,\r\n    callId: string,\r\n    content: string\r\n  ): Promise<IAppNotificationDTO | null> => {\r\n    try {\r\n      logger.debug(\r\n        `Updating call notification to missed for user: ${userId}, call: ${callId}`\r\n      );\r\n      if (!Types.ObjectId.isValid(userId)) {\r\n        logger.error(\"Invalid user ID or call ID\");\r\n        throw new ServiceError(\r\n          \"User ID and call ID must be valid ObjectIds\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      if (!content || content.trim() === \"\") {\r\n        logger.error(\"Content is required for missed call notification\");\r\n        throw new ServiceError(\r\n          \"Content is required for missed call notification\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      const notification =\r\n        await this._notificationRepository.updateNotificationToMissed(\r\n          userId,\r\n          callId,\r\n          content\r\n        );\r\n\r\n        if (!notification) {\r\n        logger.warn(`No notification found for user ${userId} and call ${callId}`);\r\n        throw new ServiceError(\r\n          \"Notification not found\",\r\n          StatusCodes.NOT_FOUND\r\n        );\r\n      }\r\n\r\n      const notificationDTO = toNotificationDTO(notification);\r\n      if (!notificationDTO) {\r\n        logger.error(`Failed to map notification ${notification._id} to DTO`);\r\n        throw new ServiceError(\"Failed to map notification to DTO\", StatusCodes.INTERNAL_SERVER_ERROR);\r\n      }\r\n\r\n      if (io) {\r\n        const payload: TaskNotificationPayload = {\r\n          _id: notificationDTO.id,\r\n          userId: notificationDTO.userId,\r\n          type: notificationDTO.type,\r\n          content: notificationDTO.content,\r\n          relatedId: notificationDTO.relatedId,\r\n          senderId: notificationDTO.senderId,\r\n          status: notificationDTO.status,\r\n          callId: notificationDTO.callId,\r\n          notificationDate: notificationDTO.notificationDate,\r\n          notificationTime: notificationDTO.notificationTime,\r\n          createdAt: notificationDTO.createdAt,\r\n          updatedAt: notificationDTO.updatedAt,\r\n          taskContext: notificationDTO.taskContext,\r\n        };\r\n        try {\r\n          SocketService.notificationEmitter.emit(\"notification.updated\", payload);\r\n        } catch (socketError: any) {\r\n          logger.error(`Socket emission error: ${socketError.message}`);\r\n        }\r\n      }\r\n      return notificationDTO;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error updating call notification to missed for user ${userId}: ${err.message}`);\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to update call notification to missed\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  getNotifications = async (userId: string): Promise<IAppNotificationDTO[]> => {\r\n    try {\r\n      logger.debug(`Fetching notifications for user: ${userId}`);\r\n      const notifications = await this._notificationRepository.findNotificationByUserId(userId);\r\n      const notificationDTOs = toNotificationDTOs(notifications);\r\n      logger.info(`Fetched ${notificationDTOs.length} notifications for user: ${userId}`);\r\n      return notificationDTOs;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error fetching notifications for user ${userId}: ${err.message}`);\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to fetch notifications\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  // Marks a single notification or all notifications of a specific type as read\r\n  markNotificationAsRead = async (\r\n    notificationId?: string,\r\n    userId?: string,\r\n    type?: IAppNotification[\"type\"]\r\n  ): Promise<IAppNotificationDTO[]> => {\r\n    logger.info(\r\n      `markNotificationAsRead called with: notificationId=${notificationId}, userId=${userId}, type=${type}`\r\n    );\r\n\r\n    try {\r\n      if (!notificationId && !type) {\r\n        logger.error(\"Either notificationId or type must be provided\");\r\n        throw new ServiceError(\r\n          \"Either notificationId or type must be provided\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      if (type && !userId) {\r\n        logger.error(\"userId is required when marking notifications by type\");\r\n        throw new ServiceError(\r\n          \"userId is required when marking notifications by type\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      if (notificationId && !Types.ObjectId.isValid(notificationId)) {\r\n        logger.error(\"Invalid notification ID\");\r\n        throw new ServiceError(\r\n          \"Notification ID must be a valid ObjectId\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      if (userId && !Types.ObjectId.isValid(userId)) {\r\n        logger.error(\"Invalid user ID\");\r\n        throw new ServiceError(\r\n          \"User ID must be a valid ObjectId\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      if (type) {\r\n        const validTypes: IAppNotification[\"type\"][] = [\r\n          \"message\",\r\n          \"incoming_call\",\r\n          \"missed_call\",\r\n          \"task_reminder\",\r\n          \"new_user\",\r\n          \"new_mentor\",\r\n          \"mentor_approved\",\r\n          \"collaboration_status\",\r\n        ];\r\n        if (!validTypes.includes(type)) {\r\n          logger.error(`Invalid notification type: ${type}`);\r\n          throw new ServiceError(\r\n            `Notification type must be one of: ${validTypes.join(\", \")}`,\r\n            StatusCodes.BAD_REQUEST\r\n          );\r\n        }\r\n      }\r\n\r\n      const updatedNotifications: IAppNotification[] = [];\r\n\r\n      if (notificationId) {\r\n        const notification = await this._notificationRepository.markNotificationAsRead(notificationId);\r\n        if (notification) {\r\n          updatedNotifications.push(notification);\r\n          logger.info(`Marked notification ${notificationId} as read`);\r\n        } else {\r\n          logger.warn(`Notification not found: ${notificationId}`);\r\n          throw new ServiceError(\r\n            \"Notification not found\",\r\n            StatusCodes.NOT_FOUND\r\n          );\r\n        }\r\n      } else if (userId && type) {\r\n        const notifications = await this._notificationRepository.findNotificationByUserId(userId);\r\n        const targetNotifications = notifications.filter(\r\n          (n) => n.type === type && n.status === \"unread\"\r\n        );\r\n\r\n        logger.debug(`Found ${targetNotifications.length} unread ${type} notifications for user ${userId}`);\r\n\r\n        for (const notification of targetNotifications) {\r\n          const updated = await this._notificationRepository.markNotificationAsRead(notification._id.toString());\r\n          if (updated) {\r\n            updatedNotifications.push(updated);\r\n            logger.debug(`Marked notification ${notification._id} as read`);\r\n          }\r\n        }\r\n        logger.info(`Marked ${updatedNotifications.length} ${type} notifications as read for user ${userId}`);\r\n      }\r\n\r\n      if (updatedNotifications.length === 0) {\r\n        logger.warn(`No notifications found for ${notificationId || type}`);\r\n        throw new ServiceError(\r\n          \"No notifications found to mark as read\",\r\n          StatusCodes.NOT_FOUND\r\n        )\r\n      }\r\n      const notificationDTOs = toNotificationDTOs(updatedNotifications);\r\n      if (notificationDTOs.length === 0) {\r\n        logger.error(`Failed to map notifications to DTOs`);\r\n        throw new ServiceError(\"Failed to map notifications to DTO\", StatusCodes.INTERNAL_SERVER_ERROR);\r\n      }\r\n\r\n      return notificationDTOs;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error marking notification(s) as read: ${err.message}`, {\r\n        notificationId,\r\n        userId,\r\n        type,\r\n        errorDetails: err,\r\n      })\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to mark notification(s) as read\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          )\r\n    }\r\n  };\r\n\r\n  getUnreadCount = async (\r\n    userId: string,\r\n    type?: IAppNotification[\"type\"]\r\n  ): Promise<number> => {\r\n    try {\r\n      logger.debug(`Fetching unread notification count for user: ${userId}${type ? `, type: ${type}` : \"\"}`);\r\n\r\n      if (!Types.ObjectId.isValid(userId)) {\r\n        logger.error(\"Invalid user ID\");\r\n        throw new ServiceError(\r\n          \"User ID must be a valid ObjectId\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      if (type) {\r\n        const validTypes: IAppNotification[\"type\"][] = [\r\n          \"message\",\r\n          \"incoming_call\",\r\n          \"missed_call\",\r\n          \"task_reminder\",\r\n          \"new_user\",\r\n          \"new_mentor\",\r\n          \"mentor_approved\",\r\n          \"collaboration_status\",\r\n        ];\r\n        if (!validTypes.includes(type)) {\r\n          logger.error(`Invalid notification type: ${type}`);\r\n          throw new ServiceError(\r\n            `Notification type must be one of: ${validTypes.join(\", \")}`,\r\n            StatusCodes.BAD_REQUEST\r\n          );\r\n        }\r\n      }\r\n\r\n      const count = await this._notificationRepository.getNotificationUnreadCount(userId, type);\r\n      logger.info(`Fetched unread count ${count} for user ${userId}${type ? `, type: ${type}` : \"\"}`);\r\n      return count;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error fetching unread notification count for user ${userId}: ${err.message}`);\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to fetch unread notification count\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  }\r\n}\r\n"]}