{"version":3,"file":"user-collaboartion-service.js","sourceRoot":"","sources":["../../src/services/user-collaboartion-service.ts"],"names":[],"mappings":"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","sourcesContent":["import { inject, injectable } from \"inversify\";\r\nimport { ServiceError } from \"../core/utils/error-handler\";\r\nimport logger from \"../core/utils/logger\";\r\nimport { StatusCodes } from \"../enums/status-code-enums\";\r\nimport { IContact } from \"../Interfaces/Models/i-contact\";\r\nimport { IUserConnectionRepository } from \"../Interfaces/Repository/i-user-collaboration-repositry\";\r\nimport { IContactRepository } from \"../Interfaces/Repository/i-contact-repositry\";\r\nimport { toUserConnectionDTO, toUserConnectionDTOs } from \"../Utils/mappers/user-connection-mapper\";\r\nimport { IUserConnectionDTO } from \"../Interfaces/DTOs/i-user-connection-dto\";\r\nimport { IUserConnectionService } from \"../Interfaces/Services/i-user-collaboration-service\";\r\n\r\n@injectable()\r\nexport class UserConnectionService implements IUserConnectionService{\r\n  private _userConnectionRepository: IUserConnectionRepository;\r\n  private _contactRepository: IContactRepository;\r\n\r\n  constructor(\r\n    @inject('IUserConnectionRepository') userConnectionRepository : IUserConnectionRepository,\r\n    @inject('IContactRepository') contactRepository : IContactRepository\r\n  ) {\r\n    this._userConnectionRepository = userConnectionRepository;\r\n    this._contactRepository = contactRepository;\r\n  }\r\n\r\n  public sendUserConnectionRequest = async (\r\n    requesterId: string,\r\n    recipientId: string\r\n  ): Promise<IUserConnectionDTO> => {\r\n    try {\r\n      logger.debug(\r\n        `Sending connection request: requester=${requesterId}, recipient=${recipientId}`\r\n      );\r\n      if (requesterId === recipientId) {\r\n        logger.error(\"Attempt to send connection request to self\");\r\n        throw new ServiceError(\r\n          \"You cannot send a connection request to yourself\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      const existingConnection =\r\n        await this._userConnectionRepository.findExistingConnection(\r\n          requesterId,\r\n          recipientId\r\n        );\r\n      if (existingConnection) {\r\n        logger.error(\r\n          `Pending request already exists: requester=${requesterId}, recipient=${recipientId}`\r\n        );\r\n        throw new ServiceError(\r\n          \"A pending request already exists for this user\",\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      const connection = await this._userConnectionRepository.createUserConnection(\r\n        requesterId,\r\n        recipientId\r\n      );\r\n      const connectionDTO = toUserConnectionDTO(connection);\r\n      if (!connectionDTO) {\r\n        logger.error(`Failed to map user connection ${connection._id} to DTO`);\r\n        throw new ServiceError(\"Failed to map user connection to DTO\", StatusCodes.INTERNAL_SERVER_ERROR);\r\n      }\r\n      logger.info(\r\n        `Connection request created: ${connection._id} (requester=${requesterId}, recipient=${recipientId})`\r\n      );\r\n      return connectionDTO;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error sending connection request from ${requesterId} to ${recipientId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to send connection request\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public respondToConnectionRequest = async (\r\n    connectionId: string,\r\n    action: \"Accepted\" | \"Rejected\"\r\n  ): Promise<{ updatedConnection: IUserConnectionDTO; contacts?: IContact[] }> => {\r\n    try {\r\n      logger.debug(\r\n        `Responding to connection request: connectionId=${connectionId}, action=${action}`\r\n      );\r\n      const validActions = [\"Accepted\", \"Rejected\"];\r\n      if (!validActions.includes(action)) {\r\n        logger.error(`Invalid action: ${action}`);\r\n        throw new ServiceError(\r\n          `Action must be one of: ${validActions.join(\", \")}`,\r\n          StatusCodes.BAD_REQUEST\r\n        );\r\n      }\r\n\r\n      const updatedConnection =\r\n        await this._userConnectionRepository.updateUserConnectionStatus(\r\n          connectionId,\r\n          action\r\n        );\r\n      if (!updatedConnection) {\r\n        logger.error(`Connection not found: ${connectionId}`);\r\n        throw new ServiceError(\"Connection not found\", StatusCodes.NOT_FOUND);\r\n      }\r\n\r\n      const updatedConnectionDTO = toUserConnectionDTO(updatedConnection);\r\n      if (!updatedConnectionDTO) {\r\n        logger.error(`Failed to map user connection ${updatedConnection._id} to DTO`);\r\n        throw new ServiceError(\"Failed to map user connection to DTO\", StatusCodes.INTERNAL_SERVER_ERROR);\r\n      }\r\n\r\n      if (action === \"Accepted\") {\r\n        const requesterId = updatedConnection.requester.toString();\r\n        const recipientId = updatedConnection.recipient.toString();\r\n        const [contact1, contact2] = await Promise.all([\r\n          this._contactRepository.createContact({\r\n            userId: requesterId,\r\n            targetUserId: recipientId,\r\n            userConnectionId: connectionId,\r\n            type: \"user-user\",\r\n          }),\r\n          this._contactRepository.createContact({\r\n            userId: recipientId,\r\n            targetUserId: requesterId,\r\n            userConnectionId: connectionId,\r\n            type: \"user-user\",\r\n          }),\r\n        ]);\r\n        logger.info(`Contacts created for connection: ${connectionId}`);\r\n        return { updatedConnection: updatedConnectionDTO, contacts: [contact1, contact2] };\r\n      }\r\n\r\n      logger.info(`Connection request ${connectionId} ${action.toLowerCase()}`);\r\n      return { updatedConnection: updatedConnectionDTO };\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error responding to connection request ${connectionId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to respond to connection request\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public disconnectConnection = async (\r\n    connectionId: string,\r\n    reason: string\r\n  ): Promise<IUserConnectionDTO | null> => {\r\n    try {\r\n      logger.debug(`Disconnecting connection: connectionId=${connectionId}`);\r\n      if (!reason || reason.trim() === \"\") {\r\n        logger.error(\"Reason is required for disconnection\");\r\n        throw new ServiceError(\"Reason is required\", StatusCodes.BAD_REQUEST);\r\n      }\r\n\r\n      const updatedConnection =\r\n        await this._userConnectionRepository.disconnectUserConnection(\r\n          connectionId,\r\n          reason\r\n        );\r\n      if (!updatedConnection) {\r\n        logger.error(`Connection not found: ${connectionId}`);\r\n        throw new ServiceError(\"Connection not found\", StatusCodes.NOT_FOUND);\r\n      }\r\n\r\n      const updatedConnectionDTO = toUserConnectionDTO(updatedConnection);\r\n      if (!updatedConnectionDTO) {\r\n        logger.error(`Failed to map user connection ${updatedConnection._id} to DTO`);\r\n        throw new ServiceError(\"Failed to map user connection to DTO\", StatusCodes.INTERNAL_SERVER_ERROR);\r\n      }\r\n\r\n      await this._contactRepository.deleteContact(connectionId, \"user-user\");\r\n      logger.info(\r\n        `Connection ${connectionId} disconnected and associated contacts deleted`\r\n      );\r\n      return updatedConnectionDTO;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error disconnecting connection ${connectionId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to disconnect connection\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public fetchUserConnections = async (\r\n    userId: string\r\n  ): Promise<IUserConnectionDTO[]> => {\r\n    try {\r\n      logger.debug(`Fetching connections for user: ${userId}`);\r\n      const connections = await this._userConnectionRepository.getUserConnections(\r\n        userId\r\n      );\r\n      const connectionDTOs = toUserConnectionDTOs(connections);\r\n      logger.info(\r\n        `Fetched ${connectionDTOs.length} connections for user: ${userId}`\r\n      );\r\n      return connectionDTOs;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error fetching connections for user ${userId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to fetch user connections\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n  public fetchUserRequests = async (\r\n    userId: string\r\n  ): Promise<{\r\n    sentRequests: IUserConnectionDTO[];\r\n    receivedRequests: IUserConnectionDTO[];\r\n  }> => {\r\n    try {\r\n      logger.debug(`Fetching user requests for user: ${userId}`);\r\n      const requests = await this._userConnectionRepository.getUserRequests(userId);\r\n      const sentRequestDTOs = toUserConnectionDTOs(requests.sentRequests);\r\n      const receivedRequestDTOs = toUserConnectionDTOs(requests.receivedRequests);\r\n      logger.info(\r\n        `Fetched ${sentRequestDTOs.length} sent and ${receivedRequestDTOs.length} received requests for user: ${userId}`\r\n      );\r\n      return { sentRequests: sentRequestDTOs, receivedRequests: receivedRequestDTOs };\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(\r\n        `Error fetching user requests for user ${userId}: ${err.message}`\r\n      );\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to fetch user requests\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n\r\n\r\n  public fetchAllUserConnections = async (\r\n  page: number,\r\n  limit: number,\r\n  search: string\r\n): Promise<{ connections: IUserConnectionDTO[]; total: number }> => {\r\n  try {\r\n    logger.debug(`Service â€“ page:${page} limit:${limit} search:\"${search}\"`);\r\n    const { connections, total } =\r\n      await this._userConnectionRepository.getAllUserConnections(\r\n        page,\r\n        limit,\r\n        search\r\n      );\r\n\r\n    const connectionDTOs = toUserConnectionDTOs(connections);\r\n    return { connections: connectionDTOs, total };\r\n  } catch (error: unknown) {\r\n    const err = error instanceof Error ? error : new Error(String(error));\r\n    logger.error(`Error fetching paginated connections: ${err.message}`);\r\n    throw error instanceof ServiceError\r\n      ? error\r\n      : new ServiceError(\r\n          'Failed to fetch paginated connections',\r\n          StatusCodes.INTERNAL_SERVER_ERROR,\r\n          err\r\n        );\r\n  }\r\n};\r\n\r\n  public fetchUserConnectionById = async (\r\n    connectionId: string\r\n  ): Promise<IUserConnectionDTO | null> => {\r\n    try {\r\n      logger.debug(`Fetching user connection by ID: ${connectionId}`);\r\n      const connection = await this._userConnectionRepository.getUserConnectionById(\r\n        connectionId\r\n      );\r\n      if (!connection) {\r\n        logger.warn(`Connection not found: ${connectionId}`);\r\n        throw new ServiceError(\"Connection not found\", StatusCodes.NOT_FOUND);\r\n      }\r\n\r\n      const connectionDTO = toUserConnectionDTO(connection);\r\n      if (!connectionDTO) {\r\n        logger.error(`Failed to map user connection ${connection._id} to DTO`);\r\n        throw new ServiceError(\"Failed to map user connection to DTO\", StatusCodes.INTERNAL_SERVER_ERROR);\r\n      }\r\n\r\n      logger.info(`Fetched connection: ${connectionId}`);\r\n      return connectionDTO;\r\n    } catch (error: unknown) {\r\n      const err = error instanceof Error ? error : new Error(String(error));\r\n      logger.error(`Error fetching connection ${connectionId}: ${err.message}`);\r\n      throw error instanceof ServiceError\r\n        ? error\r\n        : new ServiceError(\r\n            \"Failed to fetch user connection\",\r\n            StatusCodes.INTERNAL_SERVER_ERROR,\r\n            err\r\n          );\r\n    }\r\n  };\r\n}\r\n"]}