{"version":3,"file":"call-log-helper.js","sourceRoot":"","sources":["../../../src/socket/Utils/call-log-helper.ts"],"names":[],"mappings":"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","sourcesContent":["import { Socket, Server } from \"socket.io\";\r\nimport logger from \"../../core/utils/logger\";\r\nimport { ICallLog } from \"../../Interfaces/Models/i-call-log\";\r\nimport { ICallLogRepository } from \"../../Interfaces/Repository/i-call-repositry\";\r\n\r\nexport const createCallLog = async(\r\n  socket: Socket,\r\n  io: Server | null,\r\n  callLogRepo: ICallLogRepository,\r\n  data: {\r\n    CallId: string;\r\n    chatKey: string;\r\n    callType: \"audio\" | \"video\";\r\n    type: \"group\" | \"user-mentor\" | \"user-user\";\r\n    senderId: string;\r\n    recipientIds: string[];\r\n    groupId?: string;\r\n    callerName: string;\r\n  }\r\n): Promise<ICallLog | null> => {\r\n  try {\r\n    const callLogData: Partial<ICallLog> = {\r\n      CallId: data.CallId,\r\n      chatKey: data.chatKey,\r\n      callType: data.callType,\r\n      type: data.type,\r\n      senderId: data.senderId,\r\n      recipientIds: data.recipientIds,\r\n      groupId: data.groupId,\r\n      status: \"ongoing\",\r\n      callerName: data.callerName,\r\n      startTime: new Date(),\r\n    };\r\n\r\n    const callLog = await callLogRepo.createCallLog(callLogData);\r\n    logger.info(`Created call log: ${callLog._id}, CallId: ${callLog.CallId}, status: ${callLog.status}`);\r\n\r\n    const allParticipants = [data.senderId, ...data.recipientIds];\r\n    allParticipants.forEach((participantId) => {\r\n      io?.to(`user_${participantId}`).emit(\"callLog.created\", {\r\n        ...callLog.toObject()\r\n      });\r\n      logger.info(`Emitted callLog.created to user_${participantId} for CallId: ${callLog.CallId}`);\r\n    });\r\n\r\n    return callLog;\r\n  } catch (error: any) {\r\n    logger.error(`Error creating call log for chatKey: ${data.chatKey}, CallId: ${data.CallId}: ${error.message}`);\r\n    socket.emit(\"error\", { message: \"Failed to create call log\" });\r\n    return null;\r\n  }\r\n}\r\n\r\nexport const updateCallLog = async (\r\n  socket: Socket,\r\n  io: Server | null,\r\n  callLogRepo: ICallLogRepository,\r\n  callId: string,\r\n  senderId: string,\r\n  recipientIds: string[],\r\n  updateData: Partial<ICallLog>\r\n): Promise<ICallLog | null> => {\r\n  try {\r\n    const callLog = await callLogRepo.findCallLogByCallId(callId);\r\n    if (!callLog) {\r\n      logger.error(`Call log not found for CallId: ${callId}`);\r\n      socket.emit(\"error\", { message: \"Call log not found\" });\r\n      return null;\r\n    }\r\n\r\n    const endTime = updateData.status === \"completed\" || updateData.status === \"missed\" \r\n      ? updateData.endTime || new Date()\r\n      : undefined;\r\n\r\n    let duration: number | undefined;\r\n    if (updateData.status === \"completed\" && callLog.startTime && endTime) {\r\n      duration = Math.round((endTime.getTime() - callLog.startTime.getTime()) / 1000);\r\n      logger.debug(`Calculated duration for CallId: ${callId}: ${duration} seconds`);\r\n    } else if (updateData.status === \"completed\" && !callLog.startTime) {\r\n      logger.warn(`Missing startTime for completed call, CallId: ${callId}`);\r\n      duration = 0;\r\n    }\r\n\r\n    const updatedCallLog = await callLogRepo.updateCallLog(callId, {\r\n      ...updateData,\r\n      endTime,\r\n      duration,\r\n      updatedAt: new Date(),\r\n    });\r\n\r\n    if (updatedCallLog) {\r\n      const allParticipants = [senderId, ...recipientIds];\r\n      allParticipants.forEach((participantId) => {\r\n        io?.to(`user_${participantId}`).emit(\"callLog.updated\", {\r\n          ...updatedCallLog.toObject(),\r\n        });\r\n        logger.info(\r\n          `Emitted callLog.updated to user_${participantId} for CallId: ${callId}, status: ${updatedCallLog.status}, duration: ${updatedCallLog.duration || 'N/A'}`\r\n        );\r\n      });\r\n      return updatedCallLog;\r\n    }\r\n\r\n    logger.error(`Failed to update call log for CallId: ${callId}: No updated document returned`);\r\n    socket.emit(\"error\", { message: \"Failed to update call log\" });\r\n    return null;\r\n  } catch (error: any) {\r\n    logger.error(`Error updating call log for CallId: ${callId}: ${error.message}`);\r\n    socket.emit(\"error\", { message: \"Failed to update call log\" });\r\n    return null;\r\n  }\r\n}"]}