{"version":3,"file":"chat-socket-handler.js","sourceRoot":"","sources":["../../src/socket/chat-socket-handler.ts"],"names":[],"mappings":"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","sourcesContent":["import { Server, Socket } from \"socket.io\";\r\nimport mongoose from \"mongoose\";\r\nimport logger from \"../core/utils/logger\";\r\nimport Group from \"../Models/group-model\";\r\nimport UserConnection from \"../Models/user-connection-model\";\r\nimport { MarkAsReadData, Message, TypingData } from \"./types\";\r\nimport { inject, injectable } from \"inversify\";\r\nimport { IContactRepository } from \"../Interfaces/Repository/i-contact-repositry\";\r\nimport { IGroupRepository } from \"../Interfaces/Repository/i-group-repositry\";\r\nimport { IChatRepository } from \"../Interfaces/Repository/i-chat-repositry\";\r\nimport { INotificationService } from \"../Interfaces/Services/i-notification-service\";\r\nimport { ICollaborationRepository } from \"../Interfaces/Repository/i-collaboration-repositry\";\r\nimport { IMentor } from \"../Interfaces/Models/i-mentor\";\r\nimport { IUser } from \"../Interfaces/Models/i-user\";\r\n\r\n@injectable()\r\nexport class ChatSocketHandler {\r\n  private _activeChats: Map<string, string> = new Map();\r\n  private _contactsRepo: IContactRepository;\r\n  private _groupRepo: IGroupRepository;\r\n  private _chatRepo: IChatRepository;\r\n  private _collabRepository: ICollaborationRepository;\r\n  private _notificationService: INotificationService;\r\n  private _io: Server | null = null;\r\n\r\n  constructor(\r\n    @inject(\"IContactRepository\") contactsRepo: IContactRepository,\r\n    @inject(\"IGroupRepository\") groupRepo: IGroupRepository,\r\n    @inject(\"IChatRepository\") chatRepo: IChatRepository,\r\n    @inject(\"ICollaborationRepository\")\r\n    collaboartionRepository: ICollaborationRepository,\r\n    @inject(\"INotificationService\") notificationService: INotificationService\r\n  ) {\r\n    this._contactsRepo = contactsRepo;\r\n    this._groupRepo = groupRepo;\r\n    this._chatRepo = chatRepo;\r\n    this._collabRepository = collaboartionRepository;\r\n    this._notificationService = notificationService;\r\n  }\r\n\r\n  public setIo(io: Server): void {\r\n    this._io = io;\r\n  }\r\n\r\n  public async handleJoinChats(socket: Socket, userId: string): Promise<void> {\r\n    try {\r\n      const contacts = await this._contactsRepo.findContactsByUserId(userId);\r\n      const rooms = Array.from(\r\n        new Set(\r\n          contacts\r\n            .map((contact) => {\r\n              if (contact.type === \"group\" && contact.groupId) {\r\n                return `group_${contact.groupId._id.toString()}`;\r\n              } else if (contact.userId && contact.targetUserId) {\r\n                const ids = [\r\n                  contact.userId._id.toString(),\r\n                  contact.targetUserId._id.toString(),\r\n                ].sort();\r\n                return `chat_${ids[0]}_${ids[1]}`;\r\n              }\r\n              return null;\r\n            })\r\n            .filter(Boolean)\r\n        )\r\n      ) as string[];\r\n\r\n      socket.join(rooms);\r\n      logger.info(`User ${userId} joined chats: ${rooms.join(\", \")}`);\r\n    } catch (error: any) {\r\n      logger.error(`Error joining chats for user ${userId}: ${error.message}`);\r\n      socket.emit(\"error\", { message: \"Failed to join chats\" });\r\n    }\r\n  }\r\n\r\n  public handleJoinUserRoom(socket: Socket, userId: string): void {\r\n    socket.join(`user_${userId}`);\r\n    const roomMembers =  this._io?.sockets.adapter.rooms.get(`user_${userId}`)?.size || 0;\r\n    logger.info(`User ${userId} joined personal room: user_${userId}, socketId=${socket.id}, members=${roomMembers}` );\r\n    this._io?.emit(\"userOnline\", { userId });\r\n    console.log(`[ONLINE] User ${userId} is online (broadcasted)`);\r\n    socket.emit(\"userOnline\", { userId });\r\n  }\r\n\r\n  public handleEnsureUserRoom(socket: Socket, data: { userId: string }): void {\r\n    const { userId } = data;\r\n    socket.join(`user_${userId}`);\r\n    const roomMembers =\r\n      this._io?.sockets.adapter.rooms.get(`user_${userId}`)?.size || 0;\r\n    logger.info(\r\n      `Ensured user ${userId} joined room user_${userId}, socketId=${socket.id}, members=${roomMembers}`\r\n    );\r\n    this._io?.to(`user_${userId}`).emit(\"userRoomJoined\", { userId });\r\n  }\r\n\r\n  public handleLeaveUserRoom(socket: Socket, userId: string): void {\r\n    socket.leave(`user_${userId}`);\r\n    logger.info(\r\n      `User ${userId} left personal room: user_${userId}, socketId=${socket.id}`\r\n    );\r\n  }\r\n\r\n  public handleActiveChat(data: { userId: string; chatKey: string }): void {\r\n    const { userId, chatKey } = data;\r\n    this._activeChats.set(userId, chatKey);\r\n    logger.info(`User ${userId} set active chat: ${chatKey}`);\r\n  }\r\n\r\n  public async handleSendMessage(\r\n    socket: Socket,\r\n    message: Message\r\n  ): Promise<void> {\r\n    logger.info(\"RAW MESSAGE RECEIVED:\", JSON.stringify(message, null, 2));\r\n    logger.info(\"[DEBUG 1] handleSendMessage called\");\r\n\r\n    try {\r\n      const {\r\n        senderId,\r\n        targetId,\r\n        type,\r\n        content,\r\n        contentType = \"text\",\r\n        collaborationId,\r\n        userConnectionId,\r\n        groupId,\r\n        _id,\r\n      } = message;\r\n\r\n      if (!senderId || !targetId || !type || !content) {\r\n        logger.error(\"Missing required fields in message\");\r\n        socket.emit(\"error\", { message: \"Missing required fields\" });\r\n        return;\r\n      }\r\n\r\n      const timestamp = new Date();\r\n      let room: string = \"\";\r\n      let savedMessage: any = null;\r\n\r\n      const senderObjectId = new mongoose.Types.ObjectId(senderId);\r\n\r\n      // ====================== SAVE MESSAGE ======================\r\n      if (contentType === \"text\") {\r\n        if (type === \"group\") {\r\n          const group = await this._groupRepo.getGroupById(targetId);\r\n          logger.info(`Group details : ${group}`);\r\n          if (!group) {\r\n            logger.error(\"Invalid group ID:\", targetId);\r\n            socket.emit(\"error\", { message: \"Invalid group ID\" });\r\n            return;\r\n          }\r\n          const isMember = await this._groupRepo.isUserInGroup(\r\n            targetId,\r\n            senderId\r\n          );\r\n          logger.info(`isMember : ${isMember}`);\r\n          if (!isMember) {\r\n            logger.error(\"Sender not in group\");\r\n            socket.emit(\"error\", { message: \"Not a group member\" });\r\n            return;\r\n          }\r\n          room = `group_${targetId}`;\r\n          savedMessage = await this._chatRepo.saveChatMessage({\r\n            senderId: senderObjectId,\r\n            groupId: new mongoose.Types.ObjectId(groupId || targetId),\r\n            content,\r\n            contentType,\r\n            timestamp,\r\n            isRead: false,\r\n            status: \"sent\",\r\n          });\r\n        } else {\r\n          // user-user or user-mentor\r\n          const contact = await this._contactsRepo.findContactByUsers(\r\n            senderId,\r\n            targetId\r\n          );\r\n          if (!contact || !contact._id) {\r\n            logger.error(\"Contact not found for users:\", senderId, targetId);\r\n            socket.emit(\"error\", { message: \"Invalid contact\" });\r\n            return;\r\n          }\r\n\r\n          const ids = [\r\n            contact.userId.toString(),\r\n            contact.targetUserId?.toString(),\r\n          ].sort();\r\n          room = `chat_${ids[0]}_${ids[1]}`;\r\n\r\n          savedMessage = await this._chatRepo.saveChatMessage({\r\n            senderId: senderObjectId,\r\n            ...(type === \"user-mentor\" && {\r\n              collaborationId: new mongoose.Types.ObjectId(\r\n                collaborationId || contact.collaborationId?.toString()\r\n              ),\r\n            }),\r\n            ...(type === \"user-user\" && {\r\n              userConnectionId: new mongoose.Types.ObjectId(\r\n                userConnectionId || contact.userConnectionId?.toString()\r\n              ),\r\n            }),\r\n            content,\r\n            contentType,\r\n            timestamp,\r\n            isRead: false,\r\n            status: \"sent\",\r\n          });\r\n        }\r\n      } else {\r\n        // Non-text (image, file, etc.) — assume already saved\r\n        if (!_id) {\r\n          socket.emit(\"error\", { message: \"Non-text message requires _id\" });\r\n          return;\r\n        }\r\n        savedMessage = await this._chatRepo.findChatMessageById(_id);\r\n        if (!savedMessage) {\r\n          socket.emit(\"error\", { message: \"Message not found\" });\r\n          return;\r\n        }\r\n        room =\r\n          type === \"group\"\r\n            ? `group_${targetId}`\r\n            : `chat_${[senderId, targetId].sort().join(\"_\")}`;\r\n\r\n            savedMessage.status = \"sent\";\r\n            await savedMessage.save();\r\n      }\r\n\r\n      if (!savedMessage) {\r\n        logger.error(\"Failed to save message\");\r\n        socket.emit(\"error\", { message: \"Failed to save message\" });\r\n        return;\r\n      }\r\n\r\n      logger.info(`[DEBUG 2] Message saved successfully, ${savedMessage}`);\r\n      logger.info(`Message Id :\",${savedMessage._id.toString()}`);\r\n      logger.info(\r\n        `collaboartionId : ${savedMessage.collaborationId?.toString() || null}`\r\n      );\r\n      logger.info(\r\n        `userConnectionId : ${\r\n          savedMessage.userConnectionId?.toString() || null\r\n        }`\r\n      );\r\n      logger.info(`GroupId : ${savedMessage.groupId?.toString() || null}`);\r\n\r\n      // ====================== BUILD messageData (common for both types) ======================\r\n    const messageData = {\r\n        senderId,\r\n        targetId,\r\n        type,\r\n        content: savedMessage.content || content,\r\n        contentType,\r\n        thumbnailUrl: savedMessage.thumbnailUrl,\r\n        fileMetadata: savedMessage.fileMetadata,\r\n        ...(type === \"group\" && {\r\n          groupId: savedMessage.groupId?.toString() || targetId,\r\n        }),\r\n        ...(type === \"user-mentor\" && {\r\n          collaborationId: savedMessage.collaborationId?.toString(),\r\n        }),\r\n        ...(type === \"user-user\" && {\r\n          userConnectionId: savedMessage.userConnectionId?.toString(),\r\n        }),\r\n        timestamp: savedMessage.timestamp.toISOString(),\r\n        _id: savedMessage._id.toString(),\r\n        status: savedMessage.status,\r\n        isRead: savedMessage.isRead || false,\r\n      };\r\n\r\n      // ====================== DETERMINE CHATKEY & RECIPIENTS ======================\r\n      let chatKey: string | null = null;\r\n      const recipientIds: string[] = [];\r\n\r\n      if (type === \"group\" && savedMessage.groupId) {\r\n        chatKey = `group_${savedMessage.groupId.toString()}`;\r\n        const group = await Group.findById(savedMessage.groupId);\r\n        if (group) {\r\n          recipientIds.push( ...group.members .filter((m) => m.userId.toString() !== senderId)\r\n              .map((m) => m.userId.toString())\r\n          );\r\n        }\r\n      } else if (type === \"user-mentor\" && savedMessage.collaborationId) {\r\n        chatKey = `user-mentor_${savedMessage.collaborationId.toString()}`;\r\n        const collab = await this._collabRepository.findCollabById(\r\n          savedMessage.collaborationId\r\n        );\r\n        if (collab) {\r\n          let mentorUserId: string | null = null;\r\n\r\n          if (typeof collab.mentorId === \"object\" && collab.mentorId !== null) {\r\n            const mentorObj = collab.mentorId as IMentor;\r\n            if (typeof mentorObj.userId === \"object\" && mentorObj.userId !== null && \"_id\" in mentorObj.userId ) {\r\n              mentorUserId = mentorObj.userId._id.toString();\r\n            }\r\n          }\r\n\r\n          if (!mentorUserId) {\r\n            mentorUserId = collab.mentorId?.toString() || null;\r\n          }\r\n          let userUserId: string | null = null;\r\n\r\n          if ( typeof collab.userId === \"object\" && collab.userId !== null && \"_id\" in collab.userId ) {\r\n            userUserId = (collab.userId as IUser)._id.toString();\r\n          } else {\r\n            userUserId = collab.userId?.toString() || null;\r\n          }\r\n          const recipient = userUserId === senderId ? mentorUserId : userUserId;\r\n\r\n          if (recipient && recipient !== senderId) {\r\n            recipientIds.push(recipient);\r\n          }\r\n        }\r\n      } else if (type === \"user-user\" && savedMessage.userConnectionId) {\r\n        chatKey = `user-user_${savedMessage.userConnectionId.toString()}`;\r\n        const conn = await UserConnection.findById(\r\n          savedMessage.userConnectionId\r\n        );\r\n        if (conn) {\r\n          const recipient =\r\n            conn.requester.toString() === senderId\r\n              ? conn.recipient.toString()\r\n              : conn.requester.toString();\r\n          if (recipient !== senderId) recipientIds.push(recipient);\r\n        }\r\n      }\r\n\r\n      if (!chatKey || recipientIds.length === 0) {\r\n        logger.warn(\"No valid chatKey or recipients → skipping notifications\"\r\n        );\r\n      } else if (this._io) {\r\n        logger.info(\"Starting notification + contactsUpdated for\", recipientIds.length, \"users\" );\r\n\r\n        // === SEND NOTIFICATIONS ===\r\n        for (const recipientId of recipientIds) {\r\n          try {\r\n            let relatedId: string | null = null;\r\n\r\n            if (type === \"group\") {\r\n              relatedId = savedMessage.groupId?.toString() || null;\r\n            } else if (type === \"user-mentor\") {\r\n              relatedId = savedMessage.collaborationId?.toString() || null;\r\n            } else if (type === \"user-user\") {\r\n              relatedId = savedMessage.userConnectionId?.toString() || null;\r\n            }\r\n            const notification =\r\n              await this._notificationService.sendNotification(\r\n                recipientId,\r\n                \"message\",\r\n                senderId,\r\n                relatedId!,\r\n                type === \"group\" ? \"group\" : type === \"user-mentor\" ? \"collaboration\" : \"userconnection\"\r\n              );\r\n            // Auto-mark as read if recipient is actively viewing this chat\r\n            const activeChat = this._activeChats.get(recipientId);\r\n            if (activeChat === chatKey && notification.status === \"unread\") {\r\n              await this._notificationService.markNotificationAsRead(\r\n                notification.id\r\n              );\r\n              this._io\r\n                .to(`user_${recipientId}`)\r\n                .emit(\"notification.read\", { notificationId: notification.id });\r\n            }\r\n          } catch (err: any) {\r\n            logger.error( `[NOTIFY ERROR] Failed for ${recipientId}:`, err.message );\r\n          }\r\n        }\r\n        // === EMIT contactsUpdated TO REFRESH UNREAD COUNTS ===\r\n        const allUsers = [...new Set([senderId, ...recipientIds])];\r\n        for (const userId of allUsers) {\r\n          this._io.to(`user_${userId}`).emit(\"contactsUpdated\");\r\n        }\r\n      }\r\n      // ====================== BROADCAST MESSAGE ======================\r\n      socket.broadcast.to(room).emit(\"receiveMessage\", messageData);\r\n      socket.emit(\"messageSaved\", messageData);\r\n    } catch (error: any) {\r\n      logger.error(\r\n        \"[FATAL] handleSendMessage crashed:\",\r\n        error.message,\r\n        error.stack\r\n      );\r\n      socket.emit(\"error\", { message: \"Failed to send message\" });\r\n    }\r\n  }\r\n\r\n  public handleTyping(socket: Socket, data: TypingData): void {\r\n    const { userId, targetId, type, chatKey } = data;\r\n    let room: string;\r\n    if (type === \"group\") {\r\n      room = `group_${targetId}`;\r\n    } else {\r\n      const ids = [userId, targetId].sort();\r\n      room = `chat_${ids[0]}_${ids[1]}`;\r\n    }\r\n    socket.broadcast.to(room).emit(\"typing\", { userId, chatKey });\r\n    logger.info(\r\n      `Broadcasting typing to room ${room}: userId=${userId}, chatKey=${chatKey}`\r\n    );\r\n  }\r\n\r\n  public handleStopTyping(socket: Socket, data: TypingData): void {\r\n    const { userId, targetId, type, chatKey } = data;\r\n    let room: string;\r\n    if (type === \"group\") {\r\n      room = `group_${targetId}`;\r\n    } else {\r\n      const ids = [userId, targetId].sort();\r\n      room = `chat_${ids[0]}_${ids[1]}`;\r\n    }\r\n    socket.to(room).emit(\"stopTyping\", { userId, chatKey });\r\n    logger.info(\r\n      `Broadcasting stopTyping to room ${room}: userId=${userId}, chatKey=${chatKey}`\r\n    );\r\n  }\r\n\r\n  public async handleMarkAsRead(\r\n  socket: Socket,\r\n  data: MarkAsReadData\r\n): Promise<void> {\r\n  try {\r\n    const { chatKey, userId, type } = data;\r\n    const updatedMessages = await this._chatRepo.markMessagesAsRead(\r\n      chatKey,\r\n      userId,\r\n      type\r\n    );\r\n    const notifications = await this._notificationService.getNotifications(\r\n      userId\r\n    );\r\n    const messageNotifications = notifications.filter(\r\n      (n) =>\r\n        n.type === \"message\" &&\r\n        n.relatedId === chatKey &&\r\n        n.status === \"unread\"\r\n    );\r\n    for (const notification of messageNotifications) {\r\n      const updatedNotification =\r\n        await this._notificationService.markNotificationAsRead(\r\n          notification.id.toString()\r\n        );\r\n      if (updatedNotification && this._io) {\r\n        this._io\r\n          .to(`user_${userId}`)\r\n          .emit(\"notification.read\", { notificationId: notification.id });\r\n      }\r\n    }\r\n    let room: string;\r\n    if (type === \"group\") {\r\n      room = `group_${chatKey.replace(\"group_\", \"\")}`;\r\n    } else {\r\n      const contact = await this._contactsRepo.findContactByUsers(\r\n        userId,\r\n        chatKey.replace(/^(user-mentor_|user-user_)/, \"\")\r\n      );\r\n      const ids = [\r\n        contact?.userId.toString(),\r\n        contact?.targetUserId?.toString(),\r\n      ].sort();\r\n      room = `chat_${ids[0]}_${ids[1]}`;\r\n    }\r\n    console.log(`[READ EMIT] Emitting messagesRead to room ${room}`, { chatKey, userId, messageIds: updatedMessages });\r\n    this._io?.to(room).emit(\"messagesRead\", { chatKey, userId, messageIds: updatedMessages });\r\n\r\n    // NEW: Emit to personal rooms for 1-on-1 chats\r\n    let otherUsers: string[] = [];\r\n    if (type === \"user-user\") {\r\n      const connId = chatKey.replace(\"user-user_\", \"\");\r\n      const conn = await UserConnection.findById(connId);\r\n      if (conn) {\r\n        const otherUser = conn.requester.toString() === userId ? conn.recipient.toString() : conn.requester.toString();\r\n        otherUsers.push(otherUser);\r\n      }\r\n    } else if (type === \"user-mentor\") {\r\n        const collabId = chatKey.replace(\"user-mentor_\", \"\");\r\n        const collab = await this._collabRepository.findCollabById(collabId);\r\n        if (collab) {\r\n          let mentorUserId: string | null = null;\r\n          if (typeof collab.mentorId === \"object\" && collab.mentorId !== null) {\r\n            const mentorObj = collab.mentorId as IMentor;\r\n            if (mentorObj.userId) {\r\n              mentorUserId = typeof mentorObj.userId === \"object\" \r\n                ? (mentorObj.userId as IUser)._id.toString()\r\n                : mentorObj.userId\r\n            }\r\n          } else if (collab.mentorId) {\r\n            mentorUserId = collab.mentorId.toString();\r\n          }\r\n\r\n          let userUserId: string | null = null;\r\n          if (typeof collab.userId === \"object\" && collab.userId !== null) {\r\n            userUserId = (collab.userId as IUser)._id.toString();\r\n          } else if (collab.userId) {\r\n            userUserId = collab.userId.toString();\r\n          }\r\n\r\n          if (mentorUserId && userUserId) {\r\n            const otherUser = userUserId === userId ? mentorUserId : userUserId;\r\n            if (otherUser && otherUser !== userId) {\r\n              otherUsers.push(otherUser);\r\n            }\r\n          }\r\n        }\r\n      } else if (type === \"group\") {\r\n      const groupId = chatKey.replace(\"group_\", \"\");\r\n      const group = await this._groupRepo.getGroupById(groupId);\r\n      if (group) {\r\n        otherUsers = group.members\r\n          .filter(m => m.userId.toString() !== userId)\r\n          .map(m => m.userId.toString());\r\n      }\r\n    }\r\n\r\n    // Emit to all other users' personal rooms\r\n    otherUsers.forEach(otherId => {\r\n      console.log(`[READ EMIT] Emitting to personal room user_${otherId}`);\r\n      this._io?.to(`user_${otherId}`).emit(\"messagesRead\", { chatKey, userId, messageIds: updatedMessages });\r\n    });\r\n\r\n    logger.info(`Marked messages as read for user ${userId} in chat ${chatKey}`);\r\n  } catch (error: any) {\r\n    logger.error(`Error marking messages as read: ${error.message}`);\r\n    socket.emit(\"error\", { message: \"Failed to mark messages as read\" });\r\n  }\r\n}\r\n\r\n\r\n  public handleLeaveChat(userId: string): void {\r\n    try {\r\n      this._activeChats.delete(userId);\r\n      logger.info(`User ${userId} left all chats — activeChat cleared`);\r\n    } catch (err: any) {\r\n      logger.error(`Failed to handle leaveChat for ${userId}: ${err.message}`);\r\n    }\r\n  }\r\n}\r\n"]}