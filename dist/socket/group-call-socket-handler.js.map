{"version":3,"file":"group-call-socket-handler.js","sourceRoot":"","sources":["../../src/socket/group-call-socket-handler.ts"],"names":[],"mappings":"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","sourcesContent":["import { Server, Socket } from \"socket.io\";\r\nimport logger from \"../core/utils/logger\";\r\nimport {\r\n  createCallLog,\r\n  updateCallLog,\r\n} from \"./Utils/call-log-helper\";\r\nimport { inject, injectable } from \"inversify\";\r\nimport { IGroupRepository } from \"../Interfaces/Repository/i-group-repositry\";\r\nimport { IUserRepository } from \"../Interfaces/Repository/i-user-repositry\";\r\nimport { INotificationService } from \"../Interfaces/Services/i-notification-service\";\r\nimport { ICallLogRepository } from \"../Interfaces/Repository/i-call-repositry\";\r\n\r\ninterface GroupCallData {\r\n  groupId: string;\r\n  senderId: string;\r\n  recipientId: string;\r\n  callType: \"audio\" | \"video\";\r\n  callId: string;\r\n}\r\n\r\ninterface GroupOfferData extends GroupCallData {\r\n  offer: RTCSessionDescriptionInit;\r\n}\r\n\r\ninterface GroupAnswerData extends GroupCallData {\r\n  answer: RTCSessionDescriptionInit;\r\n}\r\n\r\ninterface GroupIceCandidateData extends GroupCallData {\r\n  candidate: RTCIceCandidateInit;\r\n}\r\n\r\ninterface GroupJoinCallData {\r\n  groupId: string;\r\n  userId: string;\r\n  callType: \"audio\" | \"video\";\r\n  callId: string;\r\n}\r\n\r\ninterface GroupCallOffer {\r\n  senderId: string;\r\n  recipientIds: string[];\r\n  callType: \"audio\" | \"video\";\r\n  callId: string;\r\n  endTimeout: NodeJS.Timeout;\r\n}\r\n\r\n@injectable()\r\nexport class GroupCallSocketHandler {\r\n  private _activeOffers: Map<string, GroupCallOffer> = new Map();\r\n  private _endedCalls: Set<string> = new Set();\r\n  private _joinedUsersByCallId: Map<string, Set<string>> = new Map();\r\n  private _groupRepo: IGroupRepository;\r\n  private _userRepo: IUserRepository;\r\n  private _notificationService: INotificationService;\r\n  private _callLogRepo: ICallLogRepository;\r\n  private _io: Server | null = null;\r\n  private _groupToCallId: Map<string, string> = new Map();\r\n\r\n  constructor(\r\n    @inject(\"IGroupRepository\") groupRepo: IGroupRepository,\r\n    @inject(\"IUserRepository\") userRepo: IUserRepository,\r\n    @inject(\"INotificationService\") notificationService: INotificationService,\r\n    @inject(\"ICallLogRepository\") callLogRepo: ICallLogRepository\r\n  ) {\r\n    this._groupRepo = groupRepo;\r\n    this._userRepo = userRepo;\r\n    this._notificationService = notificationService;\r\n    this._callLogRepo = callLogRepo;\r\n  }\r\n\r\n  public setIo(io: Server): void {\r\n    this._io = io;\r\n  }\r\n\r\n  public getCallIdForGroup(groupId: string): string | undefined {\r\n    return this._groupToCallId.get(groupId);\r\n  }\r\n\r\n  public async handleGroupOffer(\r\n    socket: Socket,\r\n    data: GroupOfferData\r\n  ): Promise<void> {\r\n    try {\r\n      const { groupId, senderId, recipientId, offer, callType, callId } = data;\r\n      logger.info(\r\n        `Received group ${callType} offer from ${senderId} to ${recipientId} for callId: ${callId}, groupId: ${groupId}`\r\n      );\r\n\r\n      const group = await this._groupRepo.getGroupById(groupId);\r\n      if (!group) {\r\n        logger.error(`Invalid group ID: ${groupId}`);\r\n        socket.emit(\"error\", { message: \"Invalid group ID\" });\r\n        return;\r\n      }\r\n\r\n      const recipientIds = group.members\r\n        .filter((member) => member.userId._id.toString() !== senderId)\r\n        .map((member) => member.userId._id.toString());\r\n\r\n      if (!recipientIds.includes(recipientId)) {\r\n        logger.error(\r\n          `Recipient ${recipientId} is not a member of group ${groupId}`\r\n        );\r\n        socket.emit(\"error\", { message: \"Invalid recipient for group call\" });\r\n        return;\r\n      }\r\n\r\n      const recipientSocketRoom = `user_${recipientId}`;\r\n      const socketsInRoom = await this._io?.in(recipientSocketRoom).allSockets();\r\n      if (!socketsInRoom || socketsInRoom.size === 0) {\r\n        logger.warn(\r\n          `No sockets found in room ${recipientSocketRoom} for recipient ${recipientId}`\r\n        );\r\n        return;\r\n      }\r\n\r\n      const sender = await this._userRepo.findById(senderId);\r\n      logger.info(\r\n        `Emitting groupOffer to ${recipientSocketRoom} for recipient ${recipientId}`\r\n      );\r\n      this._io?.to(recipientSocketRoom).emit(\"groupOffer\", {\r\n        groupId,\r\n        senderId,\r\n        recipientId,\r\n        offer,\r\n        callType,\r\n        callId,\r\n        senderName: sender?.name,\r\n      });\r\n    } catch (error: any) {\r\n      logger.error(`Error broadcasting group offer: ${error.message}`);\r\n      socket.emit(\"error\", { message: \"Failed to send group offer\" });\r\n    }\r\n  }\r\n\r\n  public async handleGroupAnswer(\r\n    socket: Socket,\r\n    data: GroupAnswerData\r\n  ): Promise<void> {\r\n    try {\r\n      const { groupId, senderId, recipientId, answer, callType, callId } = data;\r\n      logger.info(\r\n        `Received group ${callType} answer from ${senderId} to ${recipientId} for callId: ${callId}, groupId: ${groupId}`\r\n      );\r\n\r\n      const group = await this._groupRepo.getGroupById(groupId);\r\n      if (!group) {\r\n        logger.error(`Invalid group ID: ${groupId}`);\r\n        socket.emit(\"error\", { message: \"Invalid group ID\" });\r\n        return;\r\n      }\r\n\r\n      const recipientSocketRoom = `user_${recipientId}`;\r\n      const socketsInRoom = await this._io?.in(recipientSocketRoom).allSockets();\r\n      if (!socketsInRoom || socketsInRoom.size === 0) {\r\n        logger.warn(\r\n          `No sockets found in room ${recipientSocketRoom} for recipient ${recipientId}`\r\n        );\r\n        return;\r\n      }\r\n\r\n      logger.info(\r\n        `Emitting groupAnswer to ${recipientSocketRoom} for recipient ${recipientId}`\r\n      );\r\n      this._io?.to(recipientSocketRoom).emit(\"groupAnswer\", {\r\n        groupId,\r\n        senderId,\r\n        recipientId,\r\n        answer,\r\n        callType,\r\n        callId,\r\n      });\r\n\r\n      const call = this._activeOffers.get(callId);\r\n      if (call) {\r\n        clearTimeout(call.endTimeout);\r\n        this._activeOffers.delete(callId);\r\n        logger.info(`Cleared active offer for callId: ${callId}`);\r\n      }\r\n    } catch (error: any) {\r\n      logger.error(`Error broadcasting group answer: ${error.message}`);\r\n      socket.emit(\"error\", { message: \"Failed to send group answer\" });\r\n    }\r\n  }\r\n\r\n  public async handleGroupIceCandidate(\r\n    socket: Socket,\r\n    data: GroupIceCandidateData\r\n  ): Promise<void> {\r\n    try {\r\n      const { groupId, senderId, recipientId, candidate, callType, callId } =\r\n        data;\r\n      logger.info(\r\n        `Received group ${callType} ICE candidate from ${senderId} for callId: ${callId}, groupId: ${groupId}`\r\n      );\r\n\r\n      const group = await this._groupRepo.getGroupById(groupId);\r\n      if (!group) {\r\n        logger.error(`Invalid group ID: ${groupId}`);\r\n        socket.emit(\"error\", { message: \"Invalid group ID\" });\r\n        return;\r\n      }\r\n\r\n      this._io?.to(`user_${recipientId}`).emit(\"groupIceCandidate\", {\r\n        groupId,\r\n        senderId,\r\n        recipientId,\r\n        candidate,\r\n        callType,\r\n        callId,\r\n      });\r\n    } catch (error: any) {\r\n      logger.error(`Error broadcasting group ICE candidate: ${error.message}`);\r\n      socket.emit(\"error\", { message: \"Failed to send group ICE candidate\" });\r\n    }\r\n  }\r\n\r\n  public async handleGroupCallEnded(\r\n    socket: Socket,\r\n    data: GroupCallData\r\n  ): Promise<void> {\r\n    try {\r\n      const { groupId, senderId, callType, callId } = data;\r\n      if (this._endedCalls.has(callId)) {\r\n        logger.info(\r\n          `Ignoring duplicate group callEnded for callId: ${callId}, groupId: ${groupId}`\r\n        );\r\n        return;\r\n      }\r\n      logger.info(\r\n        `Received group callEnded from ${senderId} for callId: ${callId}, groupId: ${groupId}, callType: ${callType}`\r\n      );\r\n\r\n      const group = await this._groupRepo.getGroupById(groupId);\r\n      if (!group) {\r\n        logger.error(`Invalid group ID: ${groupId}`);\r\n        socket.emit(\"error\", { message: \"Invalid group ID\" });\r\n        return;\r\n      }\r\n\r\n      const recipientIds = group.members\r\n        .filter((member) => member.userId._id.toString() !== senderId)\r\n        .map((member) => member.userId._id.toString());\r\n\r\n      const room = `group_${groupId}`;\r\n      // If senderId is leaving, emit userRoomLeft and update call log\r\n      if (senderId && this._joinedUsersByCallId.has(callId)) {\r\n        this._joinedUsersByCallId.get(callId)!.delete(senderId);\r\n        logger.info(`Removed user ${senderId} from call ${callId}`);\r\n        this._io?.to(room).emit(\"userRoomLeft\", { userId: senderId });\r\n        logger.info(\r\n          `Emitted userRoomLeft for user ${senderId} to room ${room}`\r\n        );\r\n\r\n        // Update call log only if no users remain\r\n        if (this._joinedUsersByCallId.get(callId)!.size === 0) {\r\n          await updateCallLog(\r\n            socket,\r\n            this._io,\r\n            this._callLogRepo,\r\n            callId,\r\n            senderId,\r\n            recipientIds,\r\n            {\r\n              status: \"completed\",\r\n              endTime: new Date(),\r\n            }\r\n          );\r\n        }\r\n      } else {\r\n        // Entire call ending\r\n        await updateCallLog(\r\n          socket,\r\n          this._io,\r\n          this._callLogRepo,\r\n          callId,\r\n          senderId,\r\n          recipientIds,\r\n          {\r\n            status: \"completed\",\r\n            endTime: new Date(),\r\n          }\r\n        );\r\n        this._io?.to(room).emit(\"groupCallEnded\", {\r\n          groupId,\r\n          callId,\r\n        });\r\n      }\r\n\r\n      this._endedCalls.add(callId);\r\n      setTimeout(() => this._endedCalls.delete(callId), 60000);\r\n\r\n      const call = this._activeOffers.get(callId);\r\n      if (call) {\r\n        clearTimeout(call.endTimeout);\r\n        this._activeOffers.delete(callId);\r\n      }\r\n\r\n      // Clean up if no users remain\r\n      if (\r\n        this._joinedUsersByCallId.has(callId) &&\r\n        this._joinedUsersByCallId.get(callId)!.size === 0\r\n      ) {\r\n        this._joinedUsersByCallId.delete(callId);\r\n        this._activeOffers.delete(callId);\r\n        this._groupToCallId.delete(groupId);\r\n        logger.info(`Cleaned up empty call ${callId} for group ${groupId}`);\r\n      }\r\n    } catch (error: any) {\r\n      logger.error(`Error handling group callEnded: ${error.message}`);\r\n      socket.emit(\"error\", { message: \"Failed to end group call\" });\r\n    }\r\n  }\r\n\r\n  public async handleDisconnect(socket: Socket): Promise<void> {\r\n    try {\r\n      const userId = socket.data.userId;\r\n      if (!userId) {\r\n        logger.warn(\"Disconnect: No userId found in socket data\");\r\n        return;\r\n      }\r\n      logger.info(`User ${userId} disconnected from group calls`);\r\n\r\n      const rooms = Array.from(socket.rooms).filter((room) =>\r\n        room.startsWith(\"group_\")\r\n      );\r\n      for (const room of rooms) {\r\n        const groupId = room.replace(\"group_\", \"\");\r\n        const callId = this.getCallIdForGroup(groupId);\r\n        if (callId && this._joinedUsersByCallId.has(callId)) {\r\n          this._joinedUsersByCallId.get(callId)!.delete(userId);\r\n          logger.info(`Removed user ${userId} from call ${callId}`);\r\n\r\n          const group = await this._groupRepo.getGroupById(groupId);\r\n          if (!group) {\r\n            logger.error(`Invalid group ID: ${groupId}`);\r\n            continue;\r\n          }\r\n\r\n          const recipientIds = group.members\r\n            .filter((member) => member.userId._id.toString() !== userId)\r\n            .map((member) => member.userId._id.toString());\r\n\r\n          this._io?.to(room).emit(\"userRoomLeft\", { userId });\r\n          logger.info(\r\n            `Emitted userRoomLeft for user ${userId} to room ${room}`\r\n          );\r\n\r\n          if (this._joinedUsersByCallId.get(callId)!.size === 0) {\r\n            await updateCallLog(\r\n              socket,\r\n              this._io,\r\n              this._callLogRepo,\r\n              callId,\r\n              userId,\r\n              recipientIds,\r\n              {\r\n                status: \"completed\",\r\n                endTime: new Date(),\r\n              }\r\n            );\r\n            this._joinedUsersByCallId.delete(callId);\r\n            this._activeOffers.delete(callId);\r\n            this._groupToCallId.delete(groupId);\r\n            logger.info(`Cleaned up empty call ${callId} for group ${groupId}`);\r\n          }\r\n        }\r\n      }\r\n    } catch (error: any) {\r\n      logger.error(`Error handling group call disconnect: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  public async handleJoinGroupCall(\r\n    socket: Socket,\r\n    data: GroupJoinCallData\r\n  ): Promise<void> {\r\n    try {\r\n      const { groupId, userId, callType, callId } = data;\r\n      logger.info(\r\n        `User ${userId} joining group call for groupId: ${groupId}, callId: ${callId}, callType: ${callType}`\r\n      );\r\n\r\n      const group = await this._groupRepo.getGroupById(groupId);\r\n      if (!group) {\r\n        logger.error(`Invalid group ID: ${groupId}`);\r\n        socket.emit(\"error\", { message: \"Invalid group ID\" });\r\n        return;\r\n      }\r\n\r\n      const isMember = group.members.some(\r\n        (member) => member.userId._id.toString() === userId\r\n      );\r\n      if (!isMember) {\r\n        logger.error(`User ${userId} is not a member of group ${groupId}`);\r\n        socket.emit(\"error\", { message: \"User is not a group member\" });\r\n        return;\r\n      }\r\n\r\n      const room = `group_${groupId}`;\r\n      socket.join(room);\r\n      logger.info(`User ${userId} joined group call room: ${room}`);\r\n\r\n      if (!this._joinedUsersByCallId.has(callId)) {\r\n        this._joinedUsersByCallId.set(callId, new Set());\r\n      }\r\n      this._joinedUsersByCallId.get(callId)!.add(userId);\r\n\r\n      this._groupToCallId.set(groupId, callId);\r\n      logger.info(`Mapped groupId ${groupId} to callId ${callId}`);\r\n\r\n      const recipientIds = group.members\r\n        .filter((member) => member.userId._id.toString() !== userId)\r\n        .map((member) => member.userId._id.toString());\r\n\r\n      // Create call log only when the first user joins\r\n      if (this._joinedUsersByCallId.get(callId)!.size === 1) {\r\n        const sender = await this._userRepo.findById(userId);\r\n        await createCallLog(socket, this._io, this._callLogRepo, {\r\n          CallId: callId,\r\n          chatKey: `group_${groupId}`,\r\n          callType,\r\n          type: \"group\",\r\n          senderId: userId,\r\n          recipientIds,\r\n          groupId,\r\n          callerName: sender?.name || \"Unknown\",\r\n        });\r\n      }\r\n\r\n      const currentParticipants = Array.from(\r\n        this._joinedUsersByCallId.get(callId) || []\r\n      ).filter((id) => id !== userId);\r\n\r\n      socket.emit(\"joinedGroupCall\", {\r\n        groupId,\r\n        callId,\r\n        callType,\r\n        participants: currentParticipants,\r\n      });\r\n      logger.info(`Sent participant list to ${userId}: ${currentParticipants}`);\r\n\r\n      const unjoinedMembers = recipientIds.filter(\r\n        (memberId) => !this._joinedUsersByCallId.get(callId)!.has(memberId)\r\n      );\r\n      const sender = await this._userRepo.findById(userId);\r\n      for (const recipId of unjoinedMembers) {\r\n        try {\r\n          const notification = await this._notificationService.sendNotification(\r\n            recipId,\r\n            \"incoming_call\",\r\n            userId,\r\n            `group_${groupId}`,\r\n            \"group\",\r\n            callId,\r\n            callType,\r\n            `Incoming group ${callType} call from ${sender?.name || \"Group\"}`\r\n          );\r\n          this._io?.to(`user_${recipId}`).emit(\"notification.new\", notification);\r\n          logger.info(\r\n            `Sent group call notification to user ${recipId}: ${notification.id}`\r\n          );\r\n        } catch (error: any) {\r\n          logger.warn(\r\n            `Failed to send group call notification to user ${recipId}: ${error.message}`\r\n          );\r\n        }\r\n      }\r\n\r\n      this._io?.to(room).emit(\"userRoomJoined\", { userId });\r\n      logger.info(`Emitted userRoomJoined for user ${userId} to ${room}`);\r\n\r\n      const endTimeout = setTimeout(async () => {\r\n        const call = this._activeOffers.get(callId);\r\n        if (!call) return;\r\n\r\n        const socketsInRoom = await this._io?.in(room).allSockets();\r\n        const connectedUserIds = new Set<string>();\r\n        if (socketsInRoom) {\r\n          for (const socketId of socketsInRoom) {\r\n            const s = this._io?.sockets.sockets.get(socketId);\r\n            if (s && s.data.userId) {\r\n              connectedUserIds.add(s.data.userId);\r\n            }\r\n          }\r\n        }\r\n\r\n        for (const recipId of recipientIds) {\r\n          if (!connectedUserIds.has(recipId)) {\r\n            const notification =\r\n              await this._notificationService.updateCallNotificationToMissed(\r\n                recipId,\r\n                callId,\r\n                `Missed group ${callType} call from ${sender?.name || \"Group\"}`\r\n              );\r\n            if (notification) {\r\n              this._io\r\n                ?.to(`user_${recipId}`)\r\n                .emit(\"notification.updated\", notification);\r\n              logger.info(\r\n                `Emitted notification.updated to user_${recipId}: ${notification.id}`\r\n              );\r\n            } else {\r\n              const newNotification =\r\n                await this._notificationService.sendNotification(\r\n                  recipId,\r\n                  \"missed_call\",\r\n                  userId,\r\n                  `group_${groupId}`,\r\n                  \"group\",\r\n                  callId,\r\n                  callType,\r\n                  `Missed group ${callType} call from ${\r\n                    sender?.name || \"Group\"\r\n                  }`\r\n                );\r\n              this._io\r\n                ?.to(`user_${recipId}`)\r\n                .emit(\"notification.new\", newNotification);\r\n              logger.info(\r\n                `Emitted notification.new to user_${recipId}: ${newNotification.id}`\r\n              );\r\n            }\r\n          }\r\n        }\r\n\r\n        // Update call log to missed for unjoined members\r\n        if (unjoinedMembers.length > 0) {\r\n          await updateCallLog(\r\n            socket,\r\n            this._io,\r\n            this._callLogRepo,\r\n            callId,\r\n            userId,\r\n            recipientIds,\r\n            {\r\n              status: \"missed\",\r\n              endTime: new Date(),\r\n            }\r\n          );\r\n        }\r\n\r\n        this._activeOffers.delete(callId);\r\n        this._joinedUsersByCallId.delete(callId);\r\n        this._groupToCallId.delete(groupId);\r\n        logger.info(`Cleaned up timed out call ${callId} for group ${groupId}`);\r\n      }, 30000);\r\n\r\n      this._activeOffers.set(callId, {\r\n        senderId: userId,\r\n        recipientIds,\r\n        callType,\r\n        callId,\r\n        endTimeout,\r\n      });\r\n    } catch (error: any) {\r\n      logger.error(`Error handling joinGroupCall: ${error.message}`);\r\n      socket.emit(\"error\", { message: \"Failed to join group call\" });\r\n    }\r\n  }\r\n}\r\n"]}