{"version":3,"file":"notification-socket-handler.js","sourceRoot":"","sources":["../../src/socket/notification-socket-handler.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AACA,kEAA0C;AAG1C,yCAA+C;AAKxC,IAAM,yBAAyB,GAA/B,MAAM,yBAAyB;IAKpC,YAA4C,mBAAyC;QAF7E,QAAG,GAAkB,IAAI,CAAC;QAGhC,IAAI,CAAC,oBAAoB,GAAG,mBAAmB,CAAC;IAClD,CAAC;IAEM,gBAAgB,CAAC,EAAU;QAChC,IAAI,CAAC,GAAG,GAAG,EAAE,CAAC;QACd,IAAI,CAAC,oBAAoB,CAAC,gBAAgB,CAAC,EAAE,CAAC,CAAC;IACjD,CAAC;IAEM,KAAK,CAAC,sBAAsB,CACjC,MAAc,EACd,IAAmF;QAEnF,IAAI,CAAC;YACH,MAAM,EAAE,cAAc,EAAE,MAAM,EAAE,IAAI,EAAE,GAAG,IAAI,CAAC;YAC9C,MAAM,oBAAoB,GAAG,MAAM,IAAI,CAAC,oBAAoB,CAAC,sBAAsB,CACjF,cAAc,EACd,MAAM,EACN,IAAI,CACL,CAAC;YAEF,IAAI,oBAAoB,CAAC,MAAM,GAAG,CAAC,IAAI,IAAI,CAAC,GAAG,IAAI,MAAM,EAAE,CAAC;gBAC1D,qDAAqD;gBACrD,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,QAAQ,MAAM,EAAE,CAAC,CAAC,IAAI,CAAC,mBAAmB,EAAE;oBACtD,eAAe,EAAE,oBAAoB,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC;iBACrD,CAAC,CAAC;gBACH,gBAAM,CAAC,IAAI,CAAC,UAAU,oBAAoB,CAAC,MAAM,mCAAmC,MAAM,EAAE,CAAC,CAAC;YAChG,CAAC;QACH,CAAC;QAAC,OAAO,KAAU,EAAE,CAAC;YACpB,gBAAM,CAAC,KAAK,CAAC,qCAAqC,KAAK,CAAC,OAAO,EAAE,CAAC,CAAC;YACnE,MAAM,CAAC,IAAI,CAAC,OAAO,EAAE,EAAE,OAAO,EAAE,qCAAqC,EAAE,CAAC,CAAC;QAC3E,CAAC;IACH,CAAC;IAEM,oBAAoB,CAAC,YAAqC;QAC/D,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,CAAC;YACd,gBAAM,CAAC,KAAK,CAAC,kCAAkC,CAAC,CAAC;YACjD,OAAO;QACT,CAAC;QAED,MAAM,IAAI,GAAG,QAAQ,YAAY,CAAC,MAAM,EAAE,CAAC;QAC3C,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,kBAAkB,EAAE,YAAY,CAAC,CAAC;QACzD,gBAAM,CAAC,IAAI,CAAC,oCAAoC,YAAY,CAAC,MAAM,KAAK,YAAY,CAAC,GAAG,KAAK,YAAY,CAAC,IAAI,GAAG,CAAC,CAAC;IACrH,CAAC;CACF,CAAA;AAjDY,8DAAyB;oCAAzB,yBAAyB;IADrC,IAAA,sBAAU,GAAE;IAME,WAAA,IAAA,kBAAM,EAAC,sBAAsB,CAAC,CAAA;;GALhC,yBAAyB,CAiDrC","sourcesContent":["import { Server, Socket } from \"socket.io\";\r\nimport logger from \"../core/utils/logger\";\r\nimport { IAppNotification } from \"../Interfaces/Models/i-app-notification\";\r\nimport { TaskNotificationPayload } from \"../Utils/types/notification-types\";\r\nimport { inject, injectable } from \"inversify\";\r\nimport { INotificationSocketHandler } from \"../Interfaces/Services/i-notification-socket-handler\";\r\nimport { INotificationService } from \"../Interfaces/Services/i-notification-service\";\r\n\r\n@injectable()\r\nexport class NotificationSocketHandler implements INotificationSocketHandler{\r\n  // private _sentNotifications: Set<string> = new Set();\r\n  private _notificationService: INotificationService;\r\n  private _io: Server | null = null;\r\n\r\n  constructor(@inject(\"INotificationService\") notificationService: INotificationService) {\r\n    this._notificationService = notificationService;\r\n  }\r\n\r\n  public initializeSocket(io: Server): void {\r\n    this._io = io;\r\n    this._notificationService.initializeSocket(io);\r\n  }\r\n\r\n  public async handleNotificationRead(\r\n    socket: Socket,\r\n    data: { notificationId?: string; userId?: string; type?: IAppNotification['type'] }\r\n  ): Promise<void> {\r\n    try {\r\n      const { notificationId, userId, type } = data;\r\n      const updatedNotifications = await this._notificationService.markNotificationAsRead(\r\n        notificationId,\r\n        userId,\r\n        type\r\n      );\r\n\r\n      if (updatedNotifications.length > 0 && this._io && userId) {\r\n        // Emit to the user that some notifications were read\r\n        this._io.to(`user_${userId}`).emit(\"notification.read\", {\r\n          notificationIds: updatedNotifications.map(n => n.id),\r\n        });\r\n        logger.info(`Marked ${updatedNotifications.length} notifications as read for user ${userId}`);\r\n      }\r\n    } catch (error: any) {\r\n      logger.error(`Error handling notification.read: ${error.message}`);\r\n      socket.emit(\"error\", { message: \"Failed to mark notification as read\" });\r\n    }\r\n  }\r\n\r\n  public emitTaskNotification(notification: TaskNotificationPayload): void {\r\n    if (!this._io) {\r\n      logger.error(\"Socket.IO server not initialized\");\r\n      return;\r\n    }\r\n\r\n    const room = `user_${notification.userId}`;\r\n    this._io.to(room).emit(\"notification.new\", notification);\r\n    logger.info(`Emitted notification.new to user_${notification.userId}: ${notification._id} (${notification.type})`);\r\n  }\r\n}"]}