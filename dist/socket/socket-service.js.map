{"version":3,"file":"socket-service.js","sourceRoot":"","sources":["../../src/socket/socket-service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Server, Socket } from \"socket.io\";\r\nimport { EventEmitter } from \"events\";\r\nimport logger from \"../core/utils/logger\";\r\nimport { CallData, MarkAsReadData, Message, TypingData } from \"../Utils/types/socket-service-types\";\r\nimport { inject, injectable } from \"inversify\";\r\nimport { ISocketService } from \"../Interfaces/Services/i-socket-service\";\r\nimport { IChatSocketHandler } from \"../Interfaces/Services/i-chat-socket-handler\";\r\nimport { ICallSocketHandler } from \"../Interfaces/Services/i-call-socket-handler\";\r\nimport { INotificationSocketHandler } from \"../Interfaces/Services/i-notification-socket-handler\";\r\n\r\n\r\n\r\n@injectable()\r\nexport class SocketService implements ISocketService{\r\n  private _io: Server | null = null;\r\n  public static notificationEmitter: EventEmitter = new EventEmitter();\r\n  private _chatHandler: IChatSocketHandler;\r\n  private _callHandler: ICallSocketHandler;\r\n  // private _groupCallHandler: IGroupCallSocketHandler;\r\n  private _notificationHandler: INotificationSocketHandler;\r\n\r\n  constructor(\r\n    @inject(\"IChatSocketHandler\") chatHandler: IChatSocketHandler,\r\n    @inject(\"ICallSocketHandler\") callHandler: ICallSocketHandler,\r\n    // @inject(\"IGroupCallSocketHandler\") groupCallHandler: IGroupCallSocketHandler,\r\n    @inject(\"INotificationSocketHandler\") notificationHandler: INotificationSocketHandler\r\n  ) {\r\n    this._chatHandler = chatHandler;\r\n    this._callHandler = callHandler;\r\n    // this._groupCallHandler = groupCallHandler;\r\n    this._notificationHandler = notificationHandler;\r\n  }\r\n\r\n  public initialize(io: Server): void {\r\n    this._io = io;\r\n    this._callHandler.setIo(io); \r\n    // this._groupCallHandler.setIo(io); \r\n    this._notificationHandler.initializeSocket(io);\r\n    this._chatHandler.setIo(io);\r\n    logger.info(\"Socket.IO server initialized\");\r\n\r\n    SocketService.notificationEmitter.on(\"notification\", (notification) => {\r\n      this._notificationHandler.emitTaskNotification(notification);\r\n    });\r\n\r\n    this._io.on(\"connection\", (socket: Socket) => {\r\n      this.handleConnection(socket);\r\n    });\r\n  }\r\n\r\n  private handleConnection(socket: Socket): void {\r\n    logger.info(`New socket connection: ${socket.id}`);\r\n    const userId = socket.handshake.auth.userId as string;\r\n    socket.data.userId = userId;\r\n    logger.info(\r\n      `New client connected: socketId=${socket.id}, userId=${userId}, auth=${JSON.stringify(socket.handshake.auth)}`\r\n    );\r\n\r\n    socket.join(`user_${userId}`);\r\n    logger.info(`User ${userId} joined personal room: user_${userId}, socketId=${socket.id}`);\r\n\r\n      socket.on(\"chat:online\", ({ userId }) => {\r\n      socket.data.inChat = true;\r\n      logger.info(`[PRESENCE] User ${userId} entered chat`);\r\n      const rooms = Array.from(socket.rooms).filter(\r\n        (r) => r.startsWith(\"chat_\") || r.startsWith(\"group_\")\r\n      );\r\n      rooms.forEach((room) => {\r\n        socket.to(room).emit(\"userOnline\", { userId });\r\n      });\r\n    });\r\n\r\n    socket.on(\"chat:offline\", ({ userId }) => {\r\n      socket.data.inChat = false;\r\n      logger.info(`[PRESENCE] User ${userId} left chat`);\r\n      const rooms = Array.from(socket.rooms).filter(\r\n        (r) => r.startsWith(\"chat_\") || r.startsWith(\"group_\")\r\n      );\r\n      rooms.forEach((room) => {\r\n        socket.to(room).emit(\"userOffline\", { userId });\r\n      });\r\n    });\r\n\r\n    // Chat-related events\r\n    socket.on(\"joinChats\", (userId: string) =>\r\n      this._chatHandler.handleJoinChats(socket, userId)\r\n    );\r\n    socket.on(\"joinUserRoom\", (userId: string) =>\r\n      this._chatHandler.handleJoinUserRoom(socket, userId)\r\n    );\r\n    socket.on(\"ensureUserRoom\", (data: { userId: string }) =>\r\n    this._chatHandler.handleEnsureUserRoom(socket, data)\r\n    );\r\n    socket.on(\"leaveUserRoom\", (userId: string) =>\r\n      this._chatHandler.handleLeaveUserRoom(socket, userId)\r\n    );\r\n    socket.on(\"activeChat\", (data: { userId: string; chatKey: string }) =>\r\n      this._chatHandler.handleActiveChat(data)\r\n    );\r\n    socket.on(\"sendMessage\", (message: Message) =>\r\n      this._chatHandler.handleSendMessage(socket, message)\r\n    );\r\n    socket.on(\"typing\", (data: TypingData) =>\r\n      this._chatHandler.handleTyping(socket, data)\r\n    );\r\n    socket.on(\"stopTyping\", (data: TypingData) =>\r\n      this._chatHandler.handleStopTyping(socket, data)\r\n    );\r\n    socket.on(\"markAsRead\", (data: MarkAsReadData) =>\r\n      this._chatHandler.handleMarkAsRead(socket, data)\r\n    );\r\n    socket.on(\"leaveChat\", (userId: string) =>\r\n      this._chatHandler.handleLeaveChat(userId)\r\n    );\r\n\r\n    // One-on-one call events\r\n    socket.on(\"offer\", (data: CallData) => this._callHandler.handleOffer(socket, data));\r\n    socket.on(\"answer\", (data: CallData) => this._callHandler.handleAnswer(socket, data));\r\n    socket.on(\"ice-candidate\", (data: CallData) => this._callHandler.handleIceCandidate(socket, data));\r\n    socket.on(\"callEnded\", (data: CallData) => this._callHandler.handleCallEnded(socket, data));\r\n    \r\n\r\n    // Notification events\r\n    socket.on(\"notification.read\", (data: { notificationId: string; userId: string }) =>\r\n      this._notificationHandler.handleNotificationRead(socket, data)\r\n    );\r\n\r\n    socket.on(\"disconnect\", () => this.handleDisconnect(socket));\r\n\r\n    socket.on(\"groupCallStarted\", (data: { groupId: string; starterId: string; callType: string; roomName: string; starterName: string }) => {\r\n      logger.info(`Group call started by ${data.starterId} in group ${data.groupId}`);\r\n      const room = `group_${data.groupId}`;\r\n      socket.to(room).emit(\"groupCallStarted\", {\r\n      ...data,\r\n      starterName: data.starterName || \"Someone\"\r\n  });\r\n      // socket.emit(\"groupCallStarted\", data);\r\n    });\r\n\r\n    socket.on(\"groupCallJoined\", (data: { groupId: string; userId: string }) => {\r\n      const room = `group_${data.groupId}`;\r\n      socket.join(room);\r\n      socket.to(room).emit(\"groupUserJoin\", {\r\n        userId: data.userId,\r\n        groupId: data.groupId,\r\n      });\r\n      logger.info(`User ${data.userId} joined group call ${data.groupId}`);\r\n    });\r\n\r\n    socket.on(\"groupCallEnded\", (data: { groupId: string; callType: string }) => {\r\n      logger.info(`Group call ended in group ${data.groupId}`);\r\n      const room = `group_${data.groupId}`;\r\n      this._io?.to(room).emit(\"groupCallEnded\", data);\r\n    });\r\n  }\r\n\r\n  public handleDisconnect(socket: Socket): void {\r\n    const userId = socket.data.userId;\r\n    if (socket.data.inChat) {\r\n      const rooms = Array.from(socket.rooms).filter(\r\n        (r) => r.startsWith(\"chat_\") || r.startsWith(\"group_\")\r\n      );\r\n      rooms.forEach((room) => {\r\n        socket.to(room).emit(\"userOffline\", { userId });\r\n      });\r\n      logger.info(`[PRESENCE] User ${userId} went OFFLINE due to disconnect`);\r\n    }\r\n    logger.info(`User disconnected: socketId=${socket.id}, userId=${userId}`);\r\n  }\r\n\r\n  }"]}